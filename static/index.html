<!DOCTYPE html>
<html lang="en" class="dark">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ResearchPulse - AI Research Assistant</title>
    <link rel="icon" type="image/x-icon" href="/static/favicon.ico">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        primary: { DEFAULT: '#a84370', light: '#db2777', dark: '#77347c' },
                        accent: { DEFAULT: '#f1c4e6', light: '#f6e5f3' },
                        surface: { light: '#ffffff', dark: '#2c2632' },
                        background: { light: '#faf5fa', dark: '#221d27' },
                        text: { light: '#501854', dark: '#d2c4de' },
                        muted: { light: '#834588', dark: '#c2b6cf' },
                    },
                    fontFamily: {
                        sans: ['Inter', 'system-ui', 'sans-serif'],
                    },
                },
            },
        }
    </script>
    <style>
        /* ========== Animated Background ========== */
        #canvas-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            opacity: 0.6;
            transition: opacity 0.5s ease;
        }

        /* ========== Logo Container & Hover Effects ========== */
        .logo-container {
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .logo-glow {
            position: absolute;
            inset: -4px;
            background: linear-gradient(to right, var(--primary), var(--accent));
            border-radius: 12px;
            filter: blur(8px);
            opacity: 0.3;
            transition: opacity 0.5s ease;
            pointer-events: none;
        }

        .logo-container:hover .logo-glow {
            opacity: 0.6;
        }

        .logo {
            position: relative;
            width: 100px;
            height: 56px;
            object-fit: contain;
            border-radius: 10px;
            transition: transform 0.3s ease, filter 0.3s ease;
            z-index: 1;
        }

        .logo-container:hover .logo {
            transform: scale(1.1);
            filter: brightness(1.15);
        }

        /* ========== Header Title Group ========== */
        .header-title-group {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .header-subtitle {
            font-size: 0.85rem;
            color: var(--text-muted);
            margin: 0;
            font-weight: 400;
        }

        /* ========== Base Reset & Variables ========== */
        *,
        *::before,
        *::after {
            box-sizing: border-box;
        }

        :root {
            --primary: #4f125e;
            --primary-light: #991399;
            --primary-dark: #77347c;
            --accent: #f1c4e6;
            --accent-light: #f6e5f3;
            --bg: #faf5fa;
            --surface: #ffffff;
            --text: #501854;
            --text-muted: #834588;
            --border: #e8dde8;
            --bubble-user: linear-gradient(135deg, #a84370 0%, #db2777 100%);
            --bubble-agent: rgba(255, 255, 255, 0.85);
            --success: #10b981;
            --warning: #f59e0b;
            --error: #ef4444;
            --info: #3b82f6;
            --glass-bg: rgba(255, 255, 255, 0.7);
            --glass-border: rgba(255, 255, 255, 0.3);
        }

        html.dark {
            --primary: #a94bd4;
            --primary-light: #d2a3e7;
            --primary-dark: #a84370;
            --accent: #77347c;
            --accent-light: #9d5ba3;
            --bg: #221d27;
            --surface: #2c2632;
            --text: #d2c4de;
            --text-muted: #c2b6cf;
            --border: #3d3544;
            --bubble-user: linear-gradient(135deg, #df85ad 0%, #c7acb8 100%);
            --bubble-agent: rgba(44, 38, 50, 0.85);
            --glass-bg: rgba(44, 38, 50, 0.7);
            --glass-border: rgba(255, 255, 255, 0.1);
        }

        body {
            margin: 0;
            font-family: 'Inter', system-ui, sans-serif;
            background: var(--bg);
            color: var(--text);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        /* ========== Glass Panel Effect ========== */
        .glass-panel {
            background: var(--glass-bg);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border: 1px solid var(--glass-border);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }

        /* ========== Theme Toggle ========== */
        .theme-toggle-container {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .theme-toggle {
            position: relative;
            width: 56px;
            height: 28px;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
            border-radius: 14px;
            cursor: pointer;
            transition: all 0.3s ease;
            border: none;
            padding: 0;
        }

        .theme-toggle::before {
            content: '';
            position: absolute;
            top: 2px;
            left: 2px;
            width: 24px;
            height: 24px;
            background: white;
            border-radius: 50%;
            transition: transform 0.3s ease;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        html.dark .theme-toggle::before {
            transform: translateX(28px);
        }

        .theme-toggle .sun-icon,
        .theme-toggle .moon-icon {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            font-size: 14px;
            transition: opacity 0.3s ease;
        }

        .theme-toggle .sun-icon {
            left: 8px;
            opacity: 1;
        }

        .theme-toggle .moon-icon {
            right: 8px;
            opacity: 0.5;
        }

        html.dark .theme-toggle .sun-icon {
            opacity: 0.5;
        }

        html.dark .theme-toggle .moon-icon {
            opacity: 1;
        }

        /* ========== Layout ========== */
        .app-container {
            display: flex;
            flex-direction: column;
            height: 100vh;
            max-width: 1024px;
            margin: 0 auto;
            width: 100%;
            padding: 16px;
        }

        header {
            background: var(--glass-bg);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border: 1px solid var(--glass-border);
            border-radius: 16px;
            padding: 16px 24px;
            display: flex;
            align-items: center;
            gap: 16px;
            transition: background 0.3s ease;
            box-shadow: 0 4px 24px rgba(0, 0, 0, 0.08);
        }

        header h1 {
            margin: 0;
            font-size: 1.5rem;
            font-weight: 600;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        header .logo {
            width: 52px;
            height: 66px;
            border-radius: 10px;
            object-fit: contain;
        }

        header .header-right {
            margin-left: auto;
            display: flex;
            align-items: center;
            gap: 16px;
        }

        header .status-badge {
            padding: 6px 14px;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .status-idle {
            background: var(--accent-light);
            color: var(--text-muted);
        }

        .status-running {
            background: linear-gradient(135deg, rgba(168, 67, 112, 0.15) 0%, rgba(219, 39, 119, 0.15) 100%);
            color: var(--primary);
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }

        @keyframes pulse {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0.7;
            }
        }

        .status-done {
            background: rgba(16, 185, 129, 0.15);
            color: #047857;
        }

        html.dark .status-done {
            color: #34d399;
        }

        .status-error {
            background: rgba(239, 68, 68, 0.15);
            color: #dc2626;
        }

        html.dark .status-error {
            color: #f87171;
        }

        .status-cancelled {
            background: rgba(245, 158, 11, 0.15);
            color: #d97706;
        }

        html.dark .status-cancelled {
            color: #fbbf24;
        }

        /* ========== Navigation Tabs ========== */
        .nav-tabs {
            display: flex;
            background: var(--glass-bg);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border: 1px solid var(--glass-border);
            border-radius: 16px;
            padding: 8px 16px;
            gap: 6px;
            overflow-x: auto;
            transition: background 0.3s ease;
            margin-top: 12px;
            box-shadow: 0 4px 24px rgba(0, 0, 0, 0.08);
        }

        .nav-tab {
            padding: 10px 18px;
            border: none;
            background: transparent;
            cursor: pointer;
            font-size: 0.875rem;
            font-weight: 500;
            color: var(--text-muted);
            border-radius: 10px;
            transition: all 0.2s ease;
            white-space: nowrap;
            position: relative;
        }

        .nav-tab:hover {
            color: var(--text);
            background: rgba(168, 67, 112, 0.1);
        }

        html.dark .nav-tab:hover {
            background: rgba(219, 39, 119, 0.15);
        }

        html.dark header,
        html.dark .nav-tabs {
            box-shadow: 0 4px 24px rgba(0, 0, 0, 0.3);
        }

        html.dark .chat-panel {
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }

        .nav-tab.active {
            color: white;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
            box-shadow: 0 4px 12px rgba(168, 67, 112, 0.3);
        }

        /* ---- Home tab: always visually distinct as the "main" tab ---- */
        .nav-tab[data-tab="chat"] {
            font-weight: 700;
            border: 1.5px solid rgba(79, 18, 94, 0.25);
            background: rgba(79, 18, 94, 0.06);
        }

        .nav-tab[data-tab="chat"]:hover {
            background: rgba(79, 18, 94, 0.13);
        }

        .nav-tab[data-tab="chat"].active {
            border-color: transparent;
            background: linear-gradient(135deg, #4f125e 0%, #a84370 100%);
            box-shadow: 0 6px 18px rgba(79, 18, 94, 0.35);
        }

        /* Dark-mode overrides for the Home tab */
        html.dark .nav-tab[data-tab="chat"] {
            border-color: rgba(169, 75, 212, 0.3);
            background: rgba(169, 75, 212, 0.08);
        }

        html.dark .nav-tab[data-tab="chat"]:hover {
            background: rgba(169, 75, 212, 0.18);
        }

        html.dark .nav-tab[data-tab="chat"].active {
            border-color: transparent;
            background: linear-gradient(135deg, #9333ea 0%, #db2777 100%);
            box-shadow: 0 6px 18px rgba(147, 51, 234, 0.4);
        }

        .nav-tab .tab-icon {
            margin-right: 6px;
        }

        main {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            padding: 16px 0 0 0;
            gap: 16px;
        }

        /* ========== Tab Panels ========== */
        .tab-panel {
            display: none;
            flex: 1;
            overflow: auto;
        }

        .tab-panel.active {
            display: flex;
            flex-direction: column;
        }

        /* ========== Dashboard Components ========== */
        .dashboard-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 16px;
            background: var(--glass-bg);
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
            border-radius: 16px;
            margin-bottom: 16px;
            border: 1px solid var(--glass-border);
            transition: background 0.3s ease;
        }

        .dashboard-header h2 {
            margin: 0;
            font-size: 1.25rem;
            font-weight: 600;
        }

        .dashboard-actions {
            display: flex;
            gap: 8px;
            align-items: center;
            flex-wrap: wrap;
        }

        .search-input {
            padding: 10px 16px;
            border: 1px solid var(--border);
            border-radius: 12px;
            font-size: 0.9rem;
            width: 200px;
            background: var(--surface);
            color: var(--text);
            transition: all 0.2s ease;
        }

        .search-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(168, 67, 112, 0.15);
        }

        .filter-select {
            padding: 10px 16px;
            border: 1px solid var(--border);
            border-radius: 12px;
            font-size: 0.9rem;
            background: var(--surface);
            color: var(--text);
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .filter-select:focus {
            outline: none;
            border-color: var(--primary);
        }

        .action-btn {
            padding: 10px 18px;
            border: 1px solid var(--border);
            border-radius: 12px;
            background: var(--surface);
            color: var(--text);
            cursor: pointer;
            font-size: 0.875rem;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: all 0.2s ease;
        }

        .action-btn:hover {
            background: var(--bg);
            transform: translateY(-1px);
        }

        .action-btn.primary {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
            color: white;
            border: none;
            box-shadow: 0 4px 12px rgba(168, 67, 112, 0.3);
        }

        .action-btn.primary:hover {
            box-shadow: 0 6px 16px rgba(168, 67, 112, 0.4);
            transform: translateY(-2px);
        }

        .action-btn.danger {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            color: white;
            border: none;
        }

        .data-list {
            background: var(--glass-bg);
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
            border-radius: 16px;
            border: 1px solid var(--glass-border);
            flex: 1;
            overflow: auto;
            padding: 16px;
            transition: background 0.3s ease;
        }

        .data-item {
            padding: 14px;
            border-bottom: 1px solid var(--border);
            display: flex;
            gap: 12px;
            align-items: flex-start;
            border-radius: 12px;
            margin-bottom: 4px;
            transition: background 0.15s ease;
        }

        .data-item:last-child {
            border-bottom: none;
        }

        .data-item:hover {
            background: rgba(168, 67, 112, 0.05);
        }

        html.dark .data-item:hover {
            background: rgba(219, 39, 119, 0.1);
        }

        .data-info {
            flex: 1;
        }

        .data-title {
            font-weight: 500;
            margin-bottom: 4px;
        }

        .data-meta {
            font-size: 0.8rem;
            color: var(--text-muted);
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
        }

        .data-actions {
            display: flex;
            gap: 6px;
        }

        .data-btn {
            padding: 4px 8px;
            border: 1px solid var(--border);
            border-radius: 4px;
            background: var(--surface);
            cursor: pointer;
            font-size: 0.75rem;
        }

        .data-btn:hover {
            background: var(--bg);
        }

        .data-btn.danger:hover {
            background: #fee2e2;
            color: var(--error);
        }

        .pagination {
            display: flex;
            justify-content: center;
            gap: 8px;
            padding: 16px;
        }

        .settings-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 16px;
        }

        .settings-section {
            background: var(--glass-bg);
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
            border-radius: 16px;
            border: 1px solid var(--glass-border);
            padding: 20px;
            transition: background 0.3s ease;
        }

        .settings-section h3 {
            margin: 0 0 16px 0;
            font-size: 1rem;
            font-weight: 600;
        }

        .health-status {
            margin-bottom: 16px;
        }

        .health-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid var(--border);
        }

        .health-item:last-child {
            border-bottom: none;
        }

        .health-label {
            font-weight: 500;
        }

        .health-value {
            font-size: 0.9rem;
        }

        .health-value.ok {
            color: var(--success);
        }

        .health-value.error {
            color: var(--error);
        }

        #policy-editor {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-bottom: 16px;
        }

        #policy-editor label {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        #policy-editor input[type="number"] {
            width: 60px;
            padding: 4px 8px;
            border: 1px solid var(--border);
            border-radius: 4px;
        }

        /* Prompt Builder Styles */
        .prompt-builder {
            background: var(--glass-bg);
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
            border-radius: 16px;
            border: 1px solid var(--glass-border);
            margin-bottom: 16px;
            overflow: hidden;
            transition: background 0.3s ease;
        }

        .prompt-builder-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 14px 18px;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
            color: white;
            cursor: pointer;
        }

        .prompt-builder-header h3 {
            margin: 0;
            font-size: 1rem;
            font-weight: 600;
        }

        .prompt-builder-content {
            padding: 16px;
            display: block;
        }

        .prompt-builder-content.collapsed {
            display: none;
        }

        .prompt-builder-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 12px;
            margin-bottom: 12px;
        }

        .prompt-field {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .prompt-field label {
            font-size: 0.85rem;
            font-weight: 500;
            color: var(--text-muted);
        }

        .prompt-select {
            padding: 8px;
            border: 1px solid var(--border);
            border-radius: 8px;
            background: var(--background);
            color: var(--text);
            min-height: 36px;
        }

        .prompt-select[multiple] {
            min-height: 80px;
        }

        .prompt-actions {
            display: flex;
            gap: 8px;
            margin-bottom: 12px;
        }

        .saved-prompts {
            display: flex;
            align-items: center;
            gap: 8px;
            padding-top: 12px;
            border-top: 1px solid var(--border);
        }

        .saved-prompts label {
            font-size: 0.85rem;
            color: var(--text-muted);
        }

        .saved-prompts select {
            flex: 1;
            padding: 6px 8px;
            border: 1px solid var(--border);
            border-radius: 6px;
            background: var(--background);
            color: var(--text);
        }

        .action-btn.small {
            padding: 6px 12px;
            font-size: 0.85rem;
        }

        /* Profile Form Styles */
        .profile-section {
            grid-column: 1 / -1;
        }

        .section-desc {
            color: var(--text-muted);
            font-size: 0.9rem;
            margin: 0 0 16px 0;
        }

        .profile-form {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-bottom: 16px;
        }

        .form-row {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .form-row label {
            font-size: 0.9rem;
            font-weight: 500;
            color: var(--text-muted);
        }

        .form-row input,
        .form-row textarea,
        .form-row select {
            padding: 12px 14px;
            border: 1px solid var(--border);
            border-radius: 10px;
            background: var(--surface);
            color: var(--text);
            font-size: 0.95rem;
            transition: all 0.2s ease;
        }

        .form-row input:focus,
        .form-row textarea:focus,
        .form-row select:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(168, 67, 112, 0.12);
        }

        .form-row textarea {
            resize: vertical;
            font-family: inherit;
        }

        .save-status {
            margin-left: 12px;
            font-size: 0.9rem;
        }

        .save-status.success {
            color: var(--success);
        }

        .save-status.error {
            color: var(--error);
        }

        /* Modal */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(4px);
            -webkit-backdrop-filter: blur(4px);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal {
            background: var(--glass-bg);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border: 1px solid var(--glass-border);
            border-radius: 20px;
            padding: 28px;
            width: 90%;
            max-width: 500px;
            max-height: 90vh;
            overflow: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.2);
        }

        .modal h3 {
            margin: 0 0 20px 0;
            font-weight: 600;
        }

        .form-group {
            margin-bottom: 16px;
        }

        .form-group label {
            display: block;
            margin-bottom: 4px;
            font-weight: 500;
        }

        .form-group input,
        .form-group textarea {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid var(--border);
            border-radius: 6px;
            font-size: 0.9rem;
            background: var(--surface);
            color: var(--text);
        }

        .form-group input::placeholder,
        .form-group textarea::placeholder {
            color: var(--text-muted);
        }

        .form-actions {
            display: flex;
            gap: 8px;
            justify-content: flex-end;
        }

        /* ========== Category Selection Grid ========== */
        .category-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 8px;
            max-height: 250px;
            overflow-y: auto;
            padding: 14px;
            background: var(--bg);
            border-radius: 12px;
            border: 1px solid var(--border);
        }

        .category-checkbox {
            display: flex;
            align-items: flex-start;
            gap: 8px;
            padding: 8px 10px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.85rem;
            transition: all 0.2s ease;
        }

        .category-checkbox:hover {
            background: rgba(168, 67, 112, 0.08);
        }

        html.dark .category-checkbox:hover {
            background: rgba(219, 39, 119, 0.12);
        }

        .category-checkbox input[type="checkbox"] {
            width: auto;
            margin-top: 2px;
            accent-color: var(--primary);
        }

        .category-checkbox span {
            line-height: 1.3;
        }

        /* ========== Chat Panel ========== */
        .chat-panel {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: var(--glass-bg);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border-radius: 20px;
            border: 1px solid var(--glass-border);
            overflow: hidden;
            min-height: 0;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.08);
            transition: background 0.3s ease;
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 14px;
            justify-content: flex-start;
        }

        /* When empty-state is the only child, center it */
        .chat-messages>.empty-state:only-child {
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        .message {
            display: flex;
            flex-direction: column;
            max-width: 80%;
        }

        .message.user {
            align-self: flex-end;
        }

        .message.agent {
            align-self: flex-start;
        }

        .message-bubble {
            padding: 14px 18px;
            border-radius: 20px;
            line-height: 1.6;
            word-wrap: break-word;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        }

        .message.user .message-bubble {
            background: var(--bubble-user);
            color: white;
            border-bottom-right-radius: 6px;
        }

        .message.agent .message-bubble {
            background: var(--bubble-agent);
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
            color: var(--text);
            border-bottom-left-radius: 6px;
            border: 1px solid var(--glass-border);
        }

        .message-time {
            font-size: 0.7rem;
            color: var(--text-muted);
            margin-top: 6px;
            padding: 0 8px;
        }

        .message.user .message-time {
            text-align: right;
        }

        /* ========== Input Area ========== */
        .input-area {
            padding: 16px;
            border-top: 1px solid var(--border);
            display: flex;
            gap: 12px;
        }

        .input-area input,
        .input-area textarea {
            flex: 1;
            padding: 14px 20px;
            border: 1px solid var(--border);
            border-radius: 24px;
            font-size: 1rem;
            outline: none;
            background: var(--surface);
            color: var(--text);
            transition: all 0.2s ease;
            font-family: inherit;
        }

        .input-area textarea {
            resize: none;
            min-height: 48px;
            max-height: 200px;
            overflow-y: auto;
            line-height: 1.4;
        }

        .input-area input:focus,
        .input-area textarea:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(168, 67, 112, 0.15);
        }

        .input-area input:disabled,
        .input-area textarea:disabled {
            background: var(--bg);
            cursor: not-allowed;
            opacity: 0.6;
        }

        .send-btn {
            background: linear-gradient(135deg, #a84370 0%, #77347c 100%);
            color: white;
            border: none;
            padding: 0;
            width: 48px;
            height: 48px;
            border-radius: 50%;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 16px rgba(168, 67, 112, 0.35);
            flex-shrink: 0;
        }

        .send-btn span {
            display: none;
        }

        .send-btn:hover:not(:disabled) {
            box-shadow: 0 6px 24px rgba(168, 67, 112, 0.5);
            transform: scale(1.05);
        }

        .send-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .send-btn.stop-mode {
            background: linear-gradient(135deg, #6b7280 0%, #4b5563 100%);
            box-shadow: 0 4px 16px rgba(107, 114, 128, 0.35);
            min-width: 48px;
            width: 48px;
            height: 48px;
            border-radius: 50%;
            padding: 0;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .send-btn.stop-mode:hover {
            background: linear-gradient(135deg, #9ca3af 0%, #6b7280 100%);
            box-shadow: 0 6px 20px rgba(107, 114, 128, 0.45);
            transform: translateY(-2px);
        }

        .stop-icon {
            display: block;
        }

        /* ========== Steps Trace Display (Course Project compliance) ========== */
        .steps-trace {
            background: var(--surface) !important;
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 16px !important;
            max-width: 100%;
        }

        .steps-trace-header {
            font-weight: 600;
            font-size: 0.95rem;
            margin-bottom: 12px;
            color: var(--primary);
        }

        .step-detail {
            border: 1px solid var(--border);
            border-radius: 8px;
            margin-bottom: 8px;
            overflow: hidden;
            transition: all 0.2s ease;
        }

        .step-detail[open] {
            border-color: var(--primary);
        }

        .step-summary {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 14px;
            cursor: pointer;
            background: var(--bg);
            font-size: 0.9rem;
            user-select: none;
            list-style: none;
        }

        .step-summary::-webkit-details-marker {
            display: none;
        }

        .step-summary::before {
            content: '▶';
            font-size: 0.7rem;
            transition: transform 0.2s ease;
            color: var(--text-muted);
        }

        .step-detail[open] .step-summary::before {
            transform: rotate(90deg);
        }

        .step-number {
            background: var(--primary);
            color: white;
            font-size: 0.75rem;
            font-weight: 700;
            padding: 2px 8px;
            border-radius: 10px;
            min-width: 28px;
            text-align: center;
        }

        .step-module {
            font-weight: 600;
            color: var(--text);
        }

        .step-content {
            padding: 12px 14px;
            border-top: 1px solid var(--border);
        }

        .step-section {
            margin-bottom: 10px;
        }

        .step-section:last-child {
            margin-bottom: 0;
        }

        .step-label {
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--text-muted);
            margin-bottom: 4px;
        }

        .step-data {
            background: var(--bg);
            border: 1px solid var(--border);
            border-radius: 6px;
            padding: 8px 12px;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 0.8rem;
            color: var(--text);
            overflow-x: auto;
            white-space: pre-wrap;
            word-break: break-word;
            max-height: 200px;
            overflow-y: auto;
            margin: 0;
        }

        /* ========== Chat Summary (dual rendering) ========== */
        .chat-summary {
            padding: 16px 18px;
            line-height: 1.6;
        }

        .chat-summary-status {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 600;
            margin-bottom: 12px;
        }

        .chat-summary-status.ok {
            background: rgba(16, 185, 129, 0.15);
            color: #047857;
        }

        html.dark .chat-summary-status.ok {
            color: #34d399;
        }

        .chat-summary-status.error {
            background: rgba(239, 68, 68, 0.15);
            color: #dc2626;
        }

        html.dark .chat-summary-status.error {
            color: #f87171;
        }

        .chat-summary-status.filtered {
            background: rgba(234, 179, 8, 0.15);
            color: #a16207;
        }

        html.dark .chat-summary-status.filtered {
            color: #fbbf24;
        }

        .chat-summary-stats {
            font-size: 0.85rem;
            color: var(--text-muted);
            margin-bottom: 10px;
        }

        .chat-summary-papers {
            margin: 8px 0 12px 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .paper-card {
            padding: 10px 12px;
            border: 1px solid var(--border);
            border-radius: 10px;
            background: var(--surface);
        }

        .paper-card-title {
            font-size: 0.88rem;
            font-weight: 600;
            line-height: 1.4;
            margin-bottom: 4px;
        }

        .paper-card-meta {
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            gap: 6px;
            font-size: 0.75rem;
            color: var(--text-muted);
        }

        .paper-card-id {
            font-family: 'Consolas', 'Monaco', monospace;
        }

        .paper-card-date::before {
            content: '·';
            margin-right: 6px;
        }

        .paper-tag {
            padding: 1px 7px;
            border-radius: 6px;
            font-size: 0.7rem;
            font-weight: 600;
        }

        .paper-tag.high {
            background: rgba(16, 185, 129, 0.15);
            color: #047857;
        }

        html.dark .paper-tag.high {
            color: #34d399;
        }

        .paper-tag.mid {
            background: rgba(234, 179, 8, 0.15);
            color: #a16207;
        }

        html.dark .paper-tag.mid {
            color: #fbbf24;
        }

        .paper-tag.low {
            background: rgba(239, 68, 68, 0.15);
            color: #dc2626;
        }

        html.dark .paper-tag.low {
            color: #f87171;
        }

        .paper-card-more {
            font-size: 0.82rem;
            color: var(--text-muted);
            font-style: italic;
            padding-left: 4px;
        }

        .paper-group-label {
            font-size: 0.8rem;
            font-weight: 600;
            margin: 12px 0 4px 0;
            padding: 2px 0;
        }

        .paper-group-label.delivered {
            color: #047857;
        }

        html.dark .paper-group-label.delivered {
            color: #34d399;
        }

        .paper-group-label.new {
            color: #2563eb;
        }

        html.dark .paper-group-label.new {
            color: #60a5fa;
        }

        .paper-group-label.seen {
            color: var(--text-muted);
        }

        .chat-summary-pipeline {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            margin: 8px 0;
        }

        .chat-summary-pipeline .pipeline-step {
            padding: 3px 10px;
            background: rgba(168, 67, 112, 0.1);
            color: var(--primary);
            border-radius: 8px;
            font-size: 0.75rem;
            font-weight: 500;
        }

        html.dark .chat-summary-pipeline .pipeline-step {
            background: rgba(219, 39, 119, 0.15);
        }

        .chat-summary-toggle {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            margin-top: 12px;
            padding: 8px 14px;
            border: 1px solid var(--border);
            border-radius: 10px;
            background: var(--surface);
            color: var(--text-muted);
            cursor: pointer;
            font-size: 0.8rem;
            font-weight: 500;
            transition: all 0.2s ease;
        }

        .chat-summary-toggle:hover {
            border-color: var(--primary);
            color: var(--primary);
            background: rgba(168, 67, 112, 0.05);
        }

        .chat-summary-raw {
            display: none;
            margin-top: 12px;
            padding: 12px;
            background: var(--bg);
            border: 1px solid var(--border);
            border-radius: 10px;
        }

        .chat-summary-raw.expanded {
            display: block;
        }

        .chat-summary-raw-label {
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--text-muted);
            margin-bottom: 6px;
        }

        .chat-summary-raw pre {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 6px;
            padding: 10px;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 0.78rem;
            color: var(--text);
            overflow-x: auto;
            white-space: pre-wrap;
            word-break: break-word;
            max-height: 400px;
            overflow-y: auto;
            margin: 0 0 10px 0;
        }

        /* ========== Chat Header ========== */
        .chat-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 18px;
            border-bottom: 1px solid var(--border);
            background: var(--glass-bg);
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
        }

        .chat-header span {
            font-weight: 600;
            color: var(--text-primary);
            font-size: 0.95rem;
        }

        /* ========== Logs Panel ========== */
        .logs-panel {
            background: var(--glass-bg);
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
            border-radius: 16px;
            border: 1px solid var(--glass-border);
            max-height: 200px;
            display: flex;
            flex-direction: column;
            transition: background 0.3s ease;
        }

        .logs-header {
            padding: 14px 18px;
            font-weight: 600;
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .logs-header .toggle-btn {
            margin-left: auto;
            background: none;
            border: none;
            color: var(--text-muted);
            cursor: pointer;
            font-size: 0.85rem;
            transition: color 0.2s ease;
        }

        .logs-header .toggle-btn:hover {
            color: var(--primary);
        }

        .logs-content {
            flex: 1;
            overflow-y: auto;
            font-family: 'SF Mono', 'Fira Code', 'Consolas', monospace;
            font-size: 0.8rem;
            padding: 14px;
            background: #1a1625;
            border-radius: 0 0 16px 16px;
            color: #d2c4de;
        }

        html.dark .logs-content {
            background: #13101a;
        }

        .log-entry {
            margin-bottom: 4px;
            line-height: 1.4;
        }

        .log-entry .log-time {
            color: #64748b;
        }

        .log-entry.log-INFO .log-level {
            color: #3b82f6;
        }

        .log-entry.log-WARN .log-level {
            color: #f59e0b;
        }

        .log-entry.log-ERROR .log-level {
            color: #ef4444;
        }

        .log-entry.log-DEBUG .log-level {
            color: #8b5cf6;
        }

        .logs-panel.collapsed .logs-content {
            display: none;
        }

        /* ========== Report Panel ========== */
        .report-panel {
            background: var(--glass-bg);
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
            border-radius: 16px;
            border: 1px solid var(--glass-border);
            display: none;
            transition: background 0.3s ease;
        }

        .report-panel.visible {
            display: block;
        }

        .report-header {
            padding: 18px;
            font-weight: 600;
            font-size: 1.1rem;
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .report-content {
            padding: 18px;
        }

        .report-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 14px;
            margin-bottom: 24px;
        }

        .summary-card {
            background: rgba(168, 67, 112, 0.05);
            padding: 18px;
            border-radius: 12px;
            text-align: center;
            border: 1px solid rgba(168, 67, 112, 0.1);
            transition: all 0.2s ease;
        }

        html.dark .summary-card {
            background: rgba(219, 39, 119, 0.1);
            border-color: rgba(219, 39, 119, 0.2);
        }

        .summary-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(168, 67, 112, 0.15);
        }

        .summary-card .value {
            font-size: 1.75rem;
            font-weight: 700;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .summary-card .label {
            font-size: 0.85rem;
            color: var(--text-muted);
            margin-top: 6px;
        }

        .report-section {
            margin-bottom: 20px;
        }

        .report-section h3 {
            margin: 0 0 12px 0;
            font-size: 1rem;
            color: var(--text);
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 600;
        }

        .report-section h3::before {
            content: '';
            width: 4px;
            height: 1em;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
            border-radius: 2px;
        }

        /* Artifacts List */
        .artifacts-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .artifacts-list li {
            padding: 10px 12px;
            background: var(--bg);
            border-radius: 6px;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 10px;
            font-family: 'SF Mono', 'Fira Code', monospace;
            font-size: 0.85rem;
        }

        .artifact-icon {
            font-size: 1.2rem;
        }

        .artifact-path {
            flex: 1;
            word-break: break-all;
        }

        /* Papers Table */
        .papers-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.85rem;
        }

        .papers-table th,
        .papers-table td {
            padding: 10px 12px;
            text-align: left;
            border-bottom: 1px solid var(--border);
        }

        .papers-table th {
            background: var(--bg);
            font-weight: 600;
        }

        .papers-table tr:hover {
            background: var(--bg);
        }

        .importance-badge {
            padding: 3px 10px;
            border-radius: 9999px;
            font-size: 0.7rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }

        .importance-high {
            background: rgba(16, 185, 129, 0.15);
            color: #047857;
        }

        html.dark .importance-high {
            color: #34d399;
        }

        .importance-medium {
            background: rgba(245, 158, 11, 0.15);
            color: #b45309;
        }

        html.dark .importance-medium {
            color: #fbbf24;
        }

        .importance-low {
            background: var(--accent-light);
            color: var(--text-muted);
        }

        .importance-very_low {
            background: rgba(239, 68, 68, 0.12);
            color: #b91c1c;
        }

        html.dark .importance-very_low {
            color: #f87171;
        }

        /* Triggered-by attribution badges */
        .triggered-badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 2px 8px;
            border-radius: 9999px;
            font-size: 0.65rem;
            font-weight: 500;
            text-transform: none;
            letter-spacing: 0.2px;
        }

        .triggered-badge.user {
            background: rgba(16, 185, 129, 0.15);
            color: #059669;
        }

        html.dark .triggered-badge.user {
            background: rgba(16, 185, 129, 0.2);
            color: #34d399;
        }

        .triggered-badge.agent {
            background: rgba(99, 102, 241, 0.15);
            color: #4f46e5;
        }

        html.dark .triggered-badge.agent {
            background: rgba(99, 102, 241, 0.2);
            color: #818cf8;
        }

        .triggered-badge .icon {
            font-size: 0.75rem;
        }

        /* ========== Papers Tab Enhanced Styles ========== */

        /* Paper Row with Checkbox */
        .paper-row {
            display: flex;
            gap: 12px;
            align-items: flex-start;
            padding: 16px;
            border-bottom: 1px solid var(--border);
            transition: background 0.15s, box-shadow 0.15s;
            cursor: default;
        }

        .paper-row:last-child {
            border-bottom: none;
        }

        .paper-row:hover {
            background: rgba(168, 67, 112, 0.04);
        }

        html.dark .paper-row:hover {
            background: rgba(219, 39, 119, 0.08);
        }

        .paper-row.selected {
            background: rgba(168, 67, 112, 0.08);
            box-shadow: inset 3px 0 0 var(--primary);
        }

        html.dark .paper-row.selected {
            background: rgba(219, 39, 119, 0.12);
        }

        .paper-checkbox {
            flex-shrink: 0;
            width: 18px;
            height: 18px;
            margin-top: 2px;
            cursor: pointer;
            accent-color: var(--primary);
        }

        .paper-content {
            flex: 1;
            min-width: 0;
        }

        .paper-title-row {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 6px;
        }

        .paper-title-link {
            font-weight: 400;
            color: var(--text);
            text-decoration: none;
            flex: 1;
            overflow: hidden;
            text-overflow: ellipsis;
            transition: color 0.2s ease;
        }

        .paper-title-link:hover {
            color: var(--primary);
            text-decoration: underline;
        }

        /* Unread paper styling - bold title */
        .paper-title-link.unread {
            font-weight: 700;
        }

        /* Not Relevant / Starred Styling */
        .paper-row.not-relevant {
            opacity: 0.7;
            background: #fef2f2;
        }

        .paper-row.not-relevant .paper-title-link {
            text-decoration: line-through;
            color: var(--text-muted);
        }

        .not-relevant-badge {
            background: #fee2e2;
            color: #dc2626;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 0.65rem;
            font-weight: 600;
            margin-left: 8px;
        }

        .star-btn {
            background: transparent;
            border: 1px solid var(--border);
            border-radius: 6px;
            padding: 5px 10px;
            cursor: pointer;
            font-size: 0.85rem;
            transition: all 0.2s ease;
        }

        .star-btn:hover {
            background: rgba(245, 158, 11, 0.15);
            border-color: #d97706;
        }

        .star-btn.starred {
            background: rgba(245, 158, 11, 0.15);
            border-color: #d97706;
        }

        .relevance-btn {
            background: transparent;
            border: 1px solid var(--border);
            border-radius: 4px;
            padding: 4px 8px;
            cursor: pointer;
            font-size: 0.7rem;
            transition: all 0.15s;
        }

        .relevance-btn:hover {
            background: var(--bg);
        }

        .relevance-btn.not-relevant {
            background: #fee2e2;
            color: #dc2626;
            border-color: #fecaca;
        }

        .sort-dir-btn {
            padding: 4px 8px;
            border: 1px solid var(--border);
            border-radius: 4px;
            background: var(--surface);
            font-size: 0.75rem;
            cursor: pointer;
            transition: all 0.15s;
            min-width: 28px;
        }

        .sort-dir-btn:hover {
            background: var(--bg);
        }

        .paper-pdf-link {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 3px 10px;
            background: rgba(239, 68, 68, 0.1);
            color: #dc2626;
            border-radius: 6px;
            font-size: 0.7rem;
            font-weight: 600;
            text-decoration: none;
            transition: all 0.2s ease;
        }

        .paper-pdf-link:hover {
            background: rgba(239, 68, 68, 0.2);
        }

        html.dark .paper-pdf-link {
            color: #f87171;
        }

        .paper-meta-row {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            font-size: 0.8rem;
            color: var(--text-muted);
            margin-bottom: 8px;
        }

        .paper-meta-item {
            display: inline-flex;
            align-items: center;
            gap: 4px;
        }

        .paper-authors {
            font-size: 0.8rem;
            color: var(--text-muted);
            margin-bottom: 6px;
        }

        .paper-agent-decisions {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .agent-decision-badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 4px 10px;
            border-radius: 6px;
            font-size: 0.7rem;
            font-weight: 500;
        }

        .agent-decision-badge.email-yes {
            background: rgba(168, 67, 112, 0.1);
            color: var(--primary);
        }

        .agent-decision-badge.email-no {
            background: var(--accent-light);
            color: var(--text-muted);
        }

        .agent-decision-badge.calendar-yes {
            background: rgba(16, 185, 129, 0.12);
            color: #047857;
        }

        html.dark .agent-decision-badge.calendar-yes {
            color: #34d399;
        }

        .agent-decision-badge.calendar-no {
            background: var(--accent-light);
            color: var(--text-muted);
        }

        .agent-decision-badge.starred {
            background: rgba(245, 158, 11, 0.15);
            color: #b45309;
        }

        html.dark .agent-decision-badge.starred {
            color: #fbbf24;
        }

        .paper-overflow-btn {
            background: transparent;
            border: 1px solid var(--border);
            border-radius: 4px;
            padding: 4px 8px;
            cursor: pointer;
            font-size: 0.9rem;
            color: var(--text-muted);
            transition: background 0.15s;
        }

        .paper-overflow-btn:hover {
            background: var(--bg);
            color: var(--text);
        }

        .paper-expand-btn {
            background: transparent;
            border: 1px solid var(--border);
            border-radius: 6px;
            padding: 5px 12px;
            cursor: pointer;
            font-size: 0.75rem;
            color: var(--text-muted);
            transition: all 0.2s ease;
        }

        .paper-expand-btn:hover {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
            color: white;
            border-color: transparent;
            box-shadow: 0 2px 8px rgba(168, 67, 112, 0.25);
        }

        /* Bulk Action Bar */
        .bulk-action-bar {
            display: none;
            align-items: center;
            gap: 12px;
            padding: 14px 18px;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
            color: white;
            border-radius: 14px;
            margin-bottom: 12px;
            box-shadow: 0 6px 20px rgba(168, 67, 112, 0.35);
            flex-wrap: wrap;
        }

        .bulk-action-bar.visible {
            display: flex;
        }

        .bulk-selection-info {
            font-weight: 600;
            min-width: 100px;
        }

        .bulk-action-btn {
            padding: 8px 14px;
            border: none;
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.2);
            color: white;
            cursor: pointer;
            font-size: 0.8rem;
            font-weight: 500;
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            gap: 4px;
        }

        .bulk-action-btn:hover {
            background: rgba(255, 255, 255, 0.35);
            transform: translateY(-1px);
        }

        .bulk-action-btn.danger {
            background: rgba(239, 68, 68, 0.85);
        }

        .bulk-action-btn.danger:hover {
            background: rgba(239, 68, 68, 1);
        }

        .bulk-clear-btn {
            margin-left: auto;
            padding: 8px 14px;
            border: 1px solid rgba(255, 255, 255, 0.5);
            border-radius: 8px;
            background: transparent;
            color: white;
            cursor: pointer;
            font-size: 0.8rem;
            transition: all 0.2s ease;
        }

        .bulk-clear-btn:hover {
            background: rgba(255, 255, 255, 0.15);
        }

        /* Paper List Header */
        .paper-list-header {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 18px;
            background: rgba(168, 67, 112, 0.05);
            border-bottom: 1px solid var(--border);
            font-size: 0.8rem;
            font-weight: 600;
            color: var(--text-muted);
        }

        html.dark .paper-list-header {
            background: rgba(219, 39, 119, 0.08);
        }

        .select-all-checkbox {
            width: 18px;
            height: 18px;
            cursor: pointer;
            accent-color: var(--primary);
        }

        /* Sorting Controls */
        .sort-controls {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-left: auto;
        }

        .sort-btn {
            padding: 6px 12px;
            border: 1px solid var(--border);
            border-radius: 8px;
            background: var(--surface);
            color: var(--text);
            font-size: 0.75rem;
            cursor: pointer;
            transition: all 0.15s ease;
        }

        .sort-btn:hover {
            background: rgba(168, 67, 112, 0.08);
        }

        .sort-btn.active {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
            color: white;
            border-color: transparent;
            box-shadow: 0 2px 8px rgba(168, 67, 112, 0.25);
        }

        /* Paper Details Modal */
        .paper-drawer-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.4);
            backdrop-filter: blur(4px);
            -webkit-backdrop-filter: blur(4px);
            z-index: 1000;
        }

        .paper-drawer-overlay.visible {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .paper-drawer {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 600px;
            height: 70vh;
            min-width: 360px;
            min-height: 300px;
            max-width: 95vw;
            max-height: 95vh;
            background: var(--glass-bg);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border: 1px solid var(--glass-border);
            border-radius: 16px;
            box-shadow: 0 24px 64px rgba(0, 0, 0, 0.25);
            z-index: 1001;
            overflow: hidden;
            resize: both;
            flex-direction: column;
        }

        .paper-drawer.visible {
            display: flex;
        }

        .drawer-header {
            padding: 16px 20px;
            background: rgba(168, 67, 112, 0.05);
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-shrink: 0;
            border-radius: 16px 16px 0 0;
            cursor: grab;
        }

        .drawer-header:active {
            cursor: grabbing;
        }

        html.dark .drawer-header {
            background: rgba(219, 39, 119, 0.1);
        }

        .drawer-header h3 {
            margin: 0;
            font-size: 1.1rem;
            font-weight: 600;
        }

        .drawer-close-btn {
            background: transparent;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            padding: 4px 8px;
            line-height: 1;
            color: var(--text-muted);
            transition: all 0.2s ease;
            border-radius: 6px;
        }

        .drawer-close-btn:hover {
            color: var(--primary);
            background: rgba(168, 67, 112, 0.1);
        }

        .drawer-content {
            padding: 20px;
            overflow-y: auto;
            flex: 1;
        }

        .drawer-section {
            margin-bottom: 24px;
        }

        .drawer-section h4 {
            margin: 0 0 10px 0;
            font-size: 0.85rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .drawer-section p {
            margin: 0;
            line-height: 1.6;
            color: var(--text);
        }

        .drawer-links {
            display: flex;
            gap: 10px;
        }

        .drawer-link {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 10px 18px;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
            color: white;
            border-radius: 10px;
            text-decoration: none;
            font-size: 0.875rem;
            font-weight: 500;
            transition: all 0.2s ease;
            box-shadow: 0 4px 12px rgba(168, 67, 112, 0.25);
        }

        .drawer-link:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(168, 67, 112, 0.35);
        }

        .drawer-link.secondary {
            background: rgba(239, 68, 68, 0.1);
            color: #dc2626;
            box-shadow: none;
        }

        .drawer-link.secondary:hover {
            background: rgba(239, 68, 68, 0.2);
        }

        .drawer-link.summarize {
            background: rgba(99, 102, 241, 0.1);
            color: #6366f1;
            box-shadow: none;
            cursor: pointer;
            border: none;
            font-family: inherit;
        }

        .drawer-link.summarize:hover {
            background: rgba(99, 102, 241, 0.2);
        }

        .drawer-link.summarize.loading {
            opacity: 0.7;
            pointer-events: none;
        }

        .summary-container {
            margin-top: 12px;
            padding: 16px;
            background: var(--bg);
            border-radius: 10px;
            border: 1px solid rgba(99, 102, 241, 0.2);
            font-size: 0.9rem;
            line-height: 1.6;
            color: var(--text);
            white-space: pre-wrap;
            max-height: 500px;
            overflow-y: auto;
        }

        .summary-container h2 {
            font-size: 1rem;
            font-weight: 600;
            margin: 12px 0 6px 0;
            color: var(--primary);
        }

        .summary-container h2:first-child {
            margin-top: 0;
        }

        .summary-container ul {
            margin: 4px 0 8px 0;
            padding-left: 20px;
        }

        .summary-container li {
            margin-bottom: 4px;
        }

        .summary-container p {
            margin: 6px 0;
        }

        .summary-actions {
            display: flex;
            gap: 8px;
            margin-top: 8px;
        }

        .summary-action-btn {
            padding: 6px 14px;
            border-radius: 6px;
            border: 1px solid rgba(99, 102, 241, 0.3);
            background: transparent;
            color: #6366f1;
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .summary-action-btn:hover {
            background: rgba(99, 102, 241, 0.1);
        }

        .summary-status {
            font-size: 0.85rem;
            color: var(--text-muted);
            font-style: italic;
            margin-top: 8px;
        }

        .drawer-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
        }

        .drawer-tag {
            padding: 4px 10px;
            background: var(--bg);
            border-radius: 4px;
            font-size: 0.8rem;
            color: var(--text-muted);
        }

        /* Loading Skeleton */
        .skeleton-row {
            display: flex;
            gap: 12px;
            align-items: flex-start;
            padding: 16px;
            border-bottom: 1px solid var(--border);
        }

        .skeleton-box {
            background: linear-gradient(90deg, var(--accent-light) 25%, var(--accent) 50%, var(--accent-light) 75%);
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite;
            border-radius: 6px;
        }

        html.dark .skeleton-box {
            background: linear-gradient(90deg, rgba(44, 38, 50, 0.8) 25%, rgba(61, 53, 68, 0.8) 50%, rgba(44, 38, 50, 0.8) 75%);
            background-size: 200% 100%;
        }

        .skeleton-checkbox {
            width: 18px;
            height: 18px;
            flex-shrink: 0;
        }

        .skeleton-content {
            flex: 1;
        }

        .skeleton-title {
            height: 20px;
            width: 70%;
            margin-bottom: 8px;
        }

        .skeleton-meta {
            height: 14px;
            width: 50%;
            margin-bottom: 6px;
        }

        .skeleton-badges {
            height: 22px;
            width: 30%;
        }

        @keyframes shimmer {
            0% {
                background-position: -200% 0;
            }

            100% {
                background-position: 200% 0;
            }
        }

        /* Empty State Enhanced */
        .papers-empty-state {
            text-align: center;
            padding: 70px 24px;
            color: var(--text-muted);
        }

        .papers-empty-state .emoji {
            font-size: 3.5rem;
            margin-bottom: 20px;
            opacity: 0.8;
        }

        .papers-empty-state p {
            margin: 0 0 20px 0;
            font-size: 1rem;
        }

        .clear-filters-btn {
            padding: 10px 20px;
            border: 1px solid var(--border);
            border-radius: 10px;
            background: var(--surface);
            color: var(--text);
            cursor: pointer;
            font-size: 0.875rem;
            transition: all 0.2s ease;
        }

        .clear-filters-btn:hover {
            background: rgba(168, 67, 112, 0.08);
            border-color: var(--primary);
            color: var(--primary);
        }

        /* Decisions List */
        .decisions-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .decision-item {
            background: var(--bg);
            padding: 12px;
            border-radius: 8px;
            display: flex;
            gap: 12px;
            align-items: flex-start;
        }

        .decision-icon {
            font-size: 1.25rem;
        }

        .decision-info {
            flex: 1;
        }

        .decision-title {
            font-weight: 500;
            margin-bottom: 4px;
        }

        .decision-detail {
            font-size: 0.8rem;
            color: var(--text-muted);
        }

        /* Empty States */
        .empty-state {
            text-align: center;
            padding: 40px;
            color: var(--text-muted);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            flex: 1;
        }

        .empty-state .emoji {
            font-size: 3.5rem;
            margin-bottom: 16px;
            opacity: 0.8;
        }

        /* Stop Reason */
        .stop-reason {
            background: linear-gradient(135deg, rgba(168, 67, 112, 0.1) 0%, rgba(219, 39, 119, 0.1) 100%);
            padding: 14px 18px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 16px;
            border: 1px solid rgba(168, 67, 112, 0.15);
        }

        html.dark .stop-reason {
            background: linear-gradient(135deg, rgba(168, 67, 112, 0.2) 0%, rgba(219, 39, 119, 0.2) 100%);
            border-color: rgba(219, 39, 119, 0.25);
        }

        .stop-reason-icon {
            font-size: 1.5rem;
        }

        .stop-reason-text {
            font-weight: 600;
        }

        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background: rgba(168, 67, 112, 0.3);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: rgba(168, 67, 112, 0.5);
        }

        html.dark ::-webkit-scrollbar-thumb {
            background: rgba(219, 39, 119, 0.3);
        }

        html.dark ::-webkit-scrollbar-thumb:hover {
            background: rgba(219, 39, 119, 0.5);
        }

        /* Loading Spinner */
        .spinner {
            width: 16px;
            height: 16px;
            border: 2px solid rgba(168, 67, 112, 0.2);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            display: inline-block;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        /* Chat Header with Logo */
        .chat-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 16px;
            border-bottom: 1px solid var(--border);
            background: var(--surface);
        }

        .chat-header-logo {
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: 600;
            color: var(--text);
        }

        .chat-logo-icon {
            width: 28px;
            height: 28px;
            object-fit: contain;
        }

        .chat-empty-logo {
            margin-bottom: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .chat-empty-logo-img {
            width: 400px;
            height: 140px;
            object-fit: contain;
            opacity: 0.95;
        }

        /* Chat Container Width Consistency */
        .chat-panel {
            display: flex;
            flex-direction: column;
            width: 100%;
            max-width: 100%;
        }

        .chat-header,
        .chat-messages,
        .input-area,
        .prompt-templates {
            width: 100%;
            max-width: 100%;
            box-sizing: border-box;
        }

        /* Input Area Layout - Search button left, input in middle, send button right */
        .input-area {
            display: flex;
            justify-content: space-between;
            align-items: flex-end;
            gap: 12px;
            padding: 16px;
            background: var(--surface);
            border-top: 1px solid var(--border);
            width: 100%;
        }

        .input-area #message-input {
            flex: 1;
            min-width: 0;
        }

        /* FAQ Accordion Styles */
        .faq-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .faq-item {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 10px;
            overflow: hidden;
            transition: all 0.2s ease;
        }

        .faq-item:hover {
            border-color: var(--primary);
        }

        .faq-question {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 14px 16px;
            cursor: pointer;
            font-weight: 500;
            color: var(--text);
            transition: background 0.2s ease;
        }

        .faq-question:hover {
            background: rgba(168, 67, 112, 0.05);
        }

        html.dark .faq-question:hover {
            background: rgba(219, 39, 119, 0.1);
        }

        .faq-chevron {
            font-size: 0.75rem;
            color: var(--text-muted);
            transition: transform 0.2s ease;
        }

        .faq-item.expanded .faq-chevron {
            transform: rotate(90deg);
        }

        .faq-answer {
            display: none;
            padding: 0 16px 16px 16px;
            color: var(--text-muted);
            font-size: 0.9rem;
            line-height: 1.6;
        }

        .faq-item.expanded .faq-answer {
            display: block;
        }

        .faq-answer p {
            margin: 0 0 8px 0;
        }

        .faq-answer p:last-child {
            margin-bottom: 0;
        }

        .faq-answer ul {
            margin: 8px 0;
            padding-left: 20px;
        }

        .faq-answer li {
            margin: 4px 0;
        }

        .faq-category {
            margin-top: 20px;
        }

        .faq-category:first-child {
            margin-top: 0;
        }

        .faq-category-header {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 4px 8px 4px;
            font-size: 0.95rem;
            font-weight: 600;
            color: var(--text);
            border-bottom: 2px solid var(--border);
            margin-bottom: 10px;
        }

        .faq-category-icon {
            font-size: 1.1rem;
        }

        .about-content kbd {
            display: inline-block;
            padding: 2px 6px;
            font-size: 0.8rem;
            font-family: monospace;
            background: var(--bg);
            border: 1px solid var(--border);
            border-radius: 4px;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
        }

        /* Responsive */
        @media (max-width: 768px) {
            .app-container {
                padding: 8px;
            }

            header {
                padding: 12px 16px;
                border-radius: 12px;
            }

            header h1 {
                font-size: 1.1rem;
            }

            .header-subtitle {
                font-size: 0.75rem;
            }

            .header-title-group {
                gap: 0;
            }

            .logo {
                width: 36px;
                height: 46px;
            }

            .nav-tabs {
                border-radius: 12px;
                margin-top: 8px;
            }

            main {
                padding: 12px;
            }

            .message {
                max-width: 90%;
            }

            .input-area {
                padding: 12px;
            }

            .send-btn {
                width: 42px;
                height: 42px;
            }

            .send-btn span {
                display: none;
            }
        }

        /* Prompt Templates Accordion */
        .prompt-templates {
            border-top: 1px solid var(--border);
            background: var(--bg);
        }

        .prompt-templates-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 16px;
            cursor: pointer;
            font-weight: 500;
            font-size: 0.9rem;
            color: var(--text-muted);
        }

        .prompt-templates-header:hover {
            background: var(--surface);
        }

        .prompt-templates-content {
            display: none;
            padding: 12px 16px;
            max-height: 300px;
            overflow-y: auto;
        }

        .prompt-templates-content.expanded {
            display: block;
        }

        .chevron {
            transition: transform 0.2s;
        }

        .chevron.expanded {
            transform: rotate(90deg);
        }

        /* Autonomous Components Buttons */
        .autonomous-buttons {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
        }

        .autonomous-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            padding: 10px 12px;
            font-size: 0.85rem;
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 8px;
            transition: all 0.2s ease;
        }

        .autonomous-btn:hover {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        /* Autonomous Components Modal */
        .autonomous-modal {
            max-width: 800px;
            width: 95%;
            transition: max-width 0.3s ease, max-height 0.3s ease;
            display: flex;
            flex-direction: column;
        }

        .autonomous-modal.expanded {
            max-width: 95vw;
        }

        .autonomous-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
            padding-bottom: 12px;
            border-bottom: 1px solid var(--border);
        }

        .autonomous-modal-header h3 {
            margin: 0;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .autonomous-modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--text-muted);
            padding: 4px 8px;
            border-radius: 4px;
        }

        .autonomous-modal-close:hover {
            background: var(--surface);
            color: var(--text);
        }

        .autonomous-modal-content {
            max-height: 60vh;
            overflow-y: auto;
            transition: max-height 0.3s ease;
            flex: 1 1 auto;
            min-height: 0;
        }

        .autonomous-modal.expanded .autonomous-modal-content {
            max-height: 80vh;
        }

        /* Sticky action bar at the bottom of the live-doc modal */
        .live-doc-actions {
            flex-shrink: 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0 0 0;
            margin-top: 12px;
            border-top: 1px solid var(--border);
            background: transparent;
        }

        .download-dropdown-menu {
            display: none;
            position: absolute;
            bottom: 100%;
            left: 0;
            margin-bottom: 4px;
            background: var(--bg);
            border: 1px solid var(--border);
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            min-width: 120px;
            z-index: 100;
            overflow: hidden;
        }

        .download-dropdown.open .download-dropdown-menu {
            display: block;
        }

        .download-dropdown-menu button {
            display: block;
            width: 100%;
            padding: 8px 14px;
            border: none;
            background: none;
            text-align: left;
            font-size: 0.85rem;
            cursor: pointer;
            color: var(--text);
        }

        .download-dropdown-menu button:hover {
            background: var(--surface);
        }

        .autonomous-loading {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 40px;
            color: var(--text-muted);
        }

        .autonomous-empty {
            text-align: center;
            padding: 40px;
            color: var(--text-muted);
        }

        /* Live Document Styles */
        .live-doc-content {
            line-height: 1.6;
        }

        .live-doc-content h1,
        .live-doc-content h2,
        .live-doc-content h3 {
            margin-top: 1em;
            margin-bottom: 0.5em;
        }

        .live-doc-content ul,
        .live-doc-content ol {
            margin: 0.5em 0;
            padding-left: 1.5em;
        }

        .live-doc-content li {
            margin: 0.25em 0;
        }

        /* Suggestion Card Styles */
        .suggestion-card {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 12px;
        }

        .suggestion-card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 8px;
        }

        .suggestion-field {
            font-weight: 600;
            color: var(--primary);
        }

        .suggestion-status {
            font-size: 0.75rem;
            padding: 2px 8px;
            border-radius: 12px;
            background: var(--surface);
        }

        .suggestion-status.pending {
            background: var(--warning);
            color: #000;
        }

        .suggestion-status.accepted {
            background: var(--success);
            color: #fff;
        }

        .suggestion-status.rejected {
            background: var(--error);
            color: #fff;
        }

        .suggestion-reason {
            font-size: 0.9rem;
            color: var(--text-muted);
            margin-bottom: 12px;
        }

        .suggestion-values {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            margin-bottom: 12px;
        }

        .suggestion-value {
            background: var(--bg);
            padding: 8px 12px;
            border-radius: 8px;
            font-size: 0.85rem;
        }

        .suggestion-value-label {
            font-size: 0.75rem;
            color: var(--text-muted);
            margin-bottom: 2px;
        }

        .suggestion-actions {
            display: flex;
            gap: 8px;
        }

        .suggestion-actions button {
            flex: 1;
            padding: 8px;
            border-radius: 6px;
            font-size: 0.85rem;
            cursor: pointer;
            border: 1px solid var(--border);
            background: var(--surface);
            transition: all 0.2s;
        }

        .suggestion-actions .accept-btn:hover {
            background: var(--success);
            color: white;
            border-color: var(--success);
        }

        .suggestion-actions .reject-btn:hover {
            background: var(--error);
            color: white;
            border-color: var(--error);
        }

        /* Audit Log Styles */
        .audit-log-item {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 12px;
        }

        .audit-log-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .audit-log-run-id {
            font-family: monospace;
            font-size: 0.8rem;
            color: var(--text-muted);
        }

        .audit-log-time {
            font-size: 0.8rem;
            color: var(--text-muted);
        }

        .audit-log-stats {
            display: flex;
            gap: 16px;
            font-size: 0.9rem;
        }

        .audit-log-stat {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        /* Feature Flags Styles */
        .feature-flag-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 16px;
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 8px;
            margin-bottom: 8px;
        }

        .feature-flag-name {
            font-weight: 500;
        }

        .feature-flag-status {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .feature-flag-badge {
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 500;
        }

        .feature-flag-badge.enabled {
            background: var(--success);
            color: white;
        }

        .feature-flag-badge.disabled {
            background: var(--text-muted);
            color: white;
        }

        /* Toggle Switch */
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 26px;
            cursor: pointer;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: var(--text-muted);
            border-radius: 26px;
            transition: 0.3s;
        }

        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 20px;
            width: 20px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            border-radius: 50%;
            transition: 0.3s;
        }

        .toggle-switch input:checked+.toggle-slider {
            background-color: var(--success);
        }

        .toggle-switch input:checked+.toggle-slider:before {
            transform: translateX(24px);
        }

        .templates-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-bottom: 12px;
        }

        .template-item {
            display: flex;
            align-items: flex-start;
            justify-content: space-between;
            padding: 12px 14px;
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .template-item:hover {
            border-color: var(--primary);
            box-shadow: 0 2px 8px rgba(168, 67, 112, 0.1);
        }

        .template-info {
            flex: 1;
            min-width: 0;
        }

        .template-name {
            font-weight: 500;
            font-size: 0.9rem;
            margin-bottom: 2px;
        }

        .template-preview {
            font-size: 0.8rem;
            color: var(--text-muted);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .template-actions {
            display: flex;
            gap: 4px;
            margin-left: 8px;
        }

        .template-delete-btn {
            padding: 4px 8px;
            border: none;
            background: transparent;
            color: var(--text-muted);
            cursor: pointer;
            font-size: 0.8rem;
            border-radius: 4px;
        }

        .template-delete-btn:hover {
            background: #fee2e2;
            color: var(--error);
        }

        .template-builtin-badge {
            font-size: 0.7rem;
            color: var(--primary);
            background: rgba(168, 67, 112, 0.1);
            padding: 2px 8px;
            border-radius: 6px;
            margin-left: 8px;
            font-weight: 500;
        }

        html.dark .template-builtin-badge {
            background: rgba(219, 39, 119, 0.15);
        }

        .add-template-form {
            padding: 12px;
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 8px;
            margin-bottom: 12px;
        }

        .add-template-form .form-row {
            margin-bottom: 10px;
        }

        .add-template-form .form-actions {
            display: flex;
            gap: 8px;
        }

        /* Email & Calendar Enhanced Styles */
        .email-row,
        .calendar-row {
            display: flex;
            align-items: flex-start;
            gap: 12px;
            padding: 14px 16px;
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 10px;
            margin-bottom: 8px;
            transition: all 0.2s ease;
            cursor: pointer;
        }

        .email-row:hover,
        .calendar-row:hover {
            border-color: var(--primary);
            box-shadow: 0 2px 8px rgba(168, 67, 112, 0.1);
        }

        .email-row.selected,
        .calendar-row.selected {
            background: rgba(168, 67, 112, 0.08);
            border-color: var(--primary);
        }

        .email-checkbox,
        .calendar-checkbox {
            flex-shrink: 0;
            width: 18px;
            height: 18px;
            margin-top: 2px;
            cursor: pointer;
            accent-color: var(--primary);
        }

        .email-content,
        .calendar-content {
            flex: 1;
            min-width: 0;
        }

        .email-subject,
        .calendar-title {
            font-weight: 600;
            font-size: 0.95rem;
            margin-bottom: 4px;
            color: var(--text);
            display: flex;
            align-items: center;
            gap: 8px;
            flex-wrap: wrap;
        }

        .email-preview,
        .calendar-description {
            font-size: 0.85rem;
            color: var(--text-muted);
            margin-top: 6px;
            line-height: 1.4;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .email-meta,
        .calendar-meta {
            display: flex;
            flex-wrap: wrap;
            gap: 8px 16px;
            font-size: 0.8rem;
            color: var(--text-muted);
            margin-top: 8px;
        }

        .email-meta-item,
        .calendar-meta-item {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .email-actions,
        .calendar-actions {
            display: flex;
            flex-direction: column;
            gap: 4px;
            flex-shrink: 0;
        }

        .email-action-btn,
        .calendar-action-btn {
            padding: 6px 12px;
            border: 1px solid var(--border);
            background: var(--bg);
            color: var(--text);
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.8rem;
            transition: all 0.2s;
            white-space: nowrap;
        }

        .email-action-btn:hover,
        .calendar-action-btn:hover {
            background: var(--surface);
            border-color: var(--primary);
            color: var(--primary);
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 4px;
        }

        .status-dot.sent,
        .status-dot.created {
            background: #22c55e;
        }

        .status-dot.pending {
            background: #f59e0b;
        }

        .status-dot.failed {
            background: #ef4444;
        }

        .status-dot.upcoming {
            background: #3b82f6;
        }

        .status-dot.past {
            background: #94a3b8;
        }

        .calendar-time-badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 4px 10px;
            background: rgba(59, 130, 246, 0.1);
            color: #3b82f6;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 500;
        }

        html.dark .calendar-time-badge {
            background: rgba(59, 130, 246, 0.2);
        }

        .calendar-time-badge.past {
            background: rgba(148, 163, 184, 0.1);
            color: #64748b;
        }

        /* Modal detail sections */
        .detail-section {
            margin-bottom: 16px;
            padding-bottom: 16px;
            border-bottom: 1px solid var(--border);
        }

        .detail-section:last-child {
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0;
        }

        .detail-section h4 {
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--text-muted);
            margin-bottom: 6px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .detail-section p,
        .detail-section div {
            color: var(--text);
            line-height: 1.6;
        }

        .detail-badge-row {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 4px;
        }

        .detail-paper-link {
            display: inline-block;
            padding: 6px 12px;
            background: var(--bg);
            border: 1px solid var(--border);
            border-radius: 6px;
            color: var(--text);
            text-decoration: none;
            font-size: 0.85rem;
            transition: all 0.2s;
        }

        .detail-paper-link:hover {
            border-color: var(--primary);
            color: var(--primary);
        }

        /* Toast animation keyframes */
        @keyframes slideIn {
            from {
                transform: translateX(100px);
                opacity: 0;
            }

            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes slideOut {
            from {
                transform: translateX(0);
                opacity: 1;
            }

            to {
                transform: translateX(100px);
                opacity: 0;
            }
        }

        /* Empty state button */
        .clear-filters-btn {
            margin-top: 12px;
            padding: 8px 16px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9rem;
        }

        .clear-filters-btn:hover {
            filter: brightness(1.1);
        }
    </style>
</head>

<body class="antialiased min-h-screen bg-background-light dark:bg-background-dark text-text-light dark:text-text-dark">
    <!-- Animated Background Canvas -->
    <div id="canvas-container"></div>

    <div class="app-container">
        <header class="glass-panel rounded-2xl">
            <div class="logo-container">
                <div class="logo-glow"></div>
                <img src="/static/public/logo.png" alt="ResearchPulse Logo" class="logo">
            </div>
            <div class="header-title-group">
                <h1>ResearchPulse</h1>
                <p class="header-subtitle">Your autonomous AI-powered research assistant</p>
            </div>
            <div class="header-right">
                <div class="theme-toggle-container">
                    <button id="theme-toggle" class="theme-toggle" title="Toggle dark mode">
                        <span class="sun-icon">☀️</span>
                        <span class="moon-icon">🌙</span>
                    </button>
                </div>
                <span id="status-badge" class="status-badge status-idle">Idle</span>
            </div>
        </header>

        <!-- Navigation Tabs -->
        <nav class="nav-tabs glass-panel rounded-2xl">
            <button class="nav-tab active" data-tab="chat"><span class="tab-icon">🏠📣</span>Home </button>
            <button class="nav-tab" data-tab="papers"><span class="tab-icon">📄</span>Papers</button>
            <button class="nav-tab" data-tab="emails"><span class="tab-icon">📧</span>Emails</button>
            <button class="nav-tab" data-tab="calendar"><span class="tab-icon">📅</span>Alerts</button>
            <button class="nav-tab" data-tab="shares"><span class="tab-icon">📤</span>Shares</button>
            <button class="nav-tab" data-tab="colleagues"><span class="tab-icon">👥</span>Colleagues</button>
            <button class="nav-tab" data-tab="settings"><span class="tab-icon">⚙️</span>My Settings</button>
            <button class="nav-tab" data-tab="about"><span class="tab-icon">❓</span>Q&A</button>
        </nav>

        <main>
            <!-- Chat Tab Panel -->
            <div class="tab-panel active" id="tab-chat">
                <!-- Chat Panel -->
                <div class="chat-panel">
                    <div class="chat-header">
                        <div class="chat-header-logo">
                            <img>
                            <span>ResearchPulse Chat</span>
                        </div>
                        <button id="new-chat-btn" class="action-btn small" onclick="newChat()">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                stroke-width="2" style="margin-right: 4px;">
                                <path d="M12 20h9" />
                                <path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z" />
                            </svg>
                            New Chat
                        </button>
                    </div>
                    <div id="chat-messages" class="chat-messages">
                        <div class="empty-state">
                            <div class="chat-empty-logo">
                                <img src="/static/public/logo2.png" alt="ResearchPulse" class="chat-empty-logo-img">
                            </div>
                            <div>Start by asking ResearchPulse to find papers!</div>
                            <div style="margin-top:8px;font-size:0.9rem;color:#94a3b8;">
                                Try clicking "Search for me" if you have set your preferences, use the prompt templates,
                                or enter a free-text query.
                            </div>
                        </div>
                    </div>

                    <div class="input-area">
                        <button id="search-for-me-btn" class="action-btn primary" onclick="searchForMe()"
                            title="Generate a search prompt from your research interests" style="white-space: nowrap;">
                            🔍 Search for me
                        </button>
                        <textarea id="message-input" placeholder="Ask about research papers..." autocomplete="off"
                            rows="1"></textarea>
                        <button id="send-btn" class="send-btn">
                            <span>Run Agent</span>
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                stroke-width="2">
                                <path d="M22 2L11 13M22 2L15 22L11 13M22 2L2 9L11 13" />
                            </svg>
                        </button>
                    </div>

                    <!-- Prompt Templates Accordion -->
                    <div class="prompt-templates" id="prompt-templates">
                        <div class="prompt-templates-header" onclick="toggleTemplates()">
                            <span>Supported Prompt Templates</span>
                            <span id="templates-chevron" class="chevron">▶</span>
                        </div>
                        <div class="prompt-templates-content" id="prompt-templates-content">
                            <div id="templates-list" class="templates-list"></div>
                        </div>
                    </div>

                    <!-- Autonomous Component Buttons -->
                    <div class="autonomous-buttons" style="margin-top: 8px;">
                        <button onclick="viewLiveDocument()" class="action-btn autonomous-btn">
                            📄 Live Document
                        </button>
                        <button onclick="viewProfileSuggestions()" class="action-btn autonomous-btn">
                            💡 Profile Suggestions
                        </button>
                        <button onclick="viewHistoryLogs()" class="action-btn autonomous-btn">
                            📋 History Logs
                        </button>
                    </div>
                </div>

                <!-- Report Panel -->
                <div id="report-panel" class="report-panel">
                    <div class="report-header">
                        <span>📊</span>
                        <span>Run Report</span>
                    </div>
                    <div id="report-content" class="report-content"></div>
                </div>
            </div><!-- End of tab-chat -->

            <!-- Papers Tab Panel -->
            <div class="tab-panel" id="tab-papers">
                <div class="dashboard-header">
                    <h2>📄 Papers</h2>
                    <div class="dashboard-actions">
                        <input type="text" id="papers-search" placeholder="Search papers..." class="search-input"
                            oninput="debouncedPaperSearch()" />
                        <select id="papers-filter-importance" class="filter-select" onchange="refreshPapers()">
                            <option value="">All Importance</option>
                            <option value="high">High</option>
                            <option value="medium">Medium</option>
                            <option value="low">Low</option>
                        </select>
                        <button onclick="exportPapersCSV()" class="action-btn" id="export-csv-btn">📥 Export
                            CSV</button>
                        <button onclick="refreshPapers()" class="action-btn primary">🔄 Refresh</button>
                    </div>
                </div>

                <!-- Bulk Action Bar (appears when papers are selected) -->
                <div id="bulk-action-bar" class="bulk-action-bar">
                    <span class="bulk-selection-info" id="bulk-selection-count">0 selected</span>
                    <button class="bulk-action-btn" onclick="bulkToggleRead()">↔ Toggle Read</button>
                    <button class="bulk-action-btn" onclick="bulkToggleStar()">⭐ Toggle Star</button>
                    <button class="bulk-action-btn" onclick="bulkMarkNotRelevant()">✕ Not Relevant</button>
                    <button class="bulk-action-btn" onclick="bulkDownloadPDF()">📥 Download PDFs</button>
                    <button class="bulk-action-btn" onclick="bulkEmailSummary()">📧 Email Summary</button>
                    <button class="bulk-action-btn" onclick="bulkCreateReminder()">📅 Reminder</button>
                    <button class="bulk-action-btn danger" onclick="bulkDelete()">🗑️ Delete</button>
                    <button class="bulk-clear-btn" onclick="clearSelection()">✕ Clear</button>
                </div>

                <!-- Paper List with Header -->
                <div class="data-list" style="padding: 0;">
                    <div class="paper-list-header" id="paper-list-header">
                        <input type="checkbox" class="select-all-checkbox" id="select-all-checkbox"
                            onclick="toggleSelectAll()" title="Select all papers" />
                        <span>Select All</span>
                        <div class="sort-controls">
                            <span style="font-weight: normal;">Sort by:</span>
                            <button class="sort-btn active" onclick="setSortOrder('added_at', this)"
                                data-sort="added_at">Added Date</button>
                            <button class="sort-btn" onclick="setSortOrder('importance', this)"
                                data-sort="importance">Importance</button>
                            <button class="sort-btn" onclick="setSortOrder('published_at', this)"
                                data-sort="published_at">Published</button>
                            <button class="sort-btn" onclick="setSortOrder('title', this)"
                                data-sort="title">Title</button>
                            <button class="sort-dir-btn" id="sort-dir-btn" onclick="toggleSortDirection()"
                                title="Toggle sort direction">
                                ↓
                            </button>
                        </div>
                    </div>
                    <div id="papers-list">
                        <div class="papers-empty-state">
                            <div class="emoji">📄</div>
                            <p>No papers yet. Run the agent to discover papers!</p>
                        </div>
                    </div>
                </div>
                <div class="pagination" id="papers-pagination"></div>
            </div>

            <!-- Paper Details Drawer -->
            <div class="paper-drawer-overlay" id="paper-drawer-overlay" onclick="closePaperDrawer()"></div>
            <div class="paper-drawer" id="paper-drawer">
                <div class="drawer-header">
                    <h3>📄 Paper Details</h3>
                    <button class="drawer-close-btn" onclick="closePaperDrawer()">×</button>
                </div>
                <div class="drawer-content" id="drawer-content">
                    <!-- Content will be dynamically populated -->
                </div>
            </div>

            <!-- Emails Tab Panel -->
            <div class="tab-panel" id="tab-emails">
                <div class="dashboard-header">
                    <h2>📧 Email History</h2>
                    <div class="dashboard-actions">
                        <input type="text" id="emails-search" placeholder="Search emails..." class="search-input"
                            oninput="debouncedEmailSearch()" />
                        <select id="emails-filter-status" class="filter-select" onchange="refreshEmails()">
                            <option value="">All Status</option>
                            <option value="sent">Sent</option>
                            <option value="failed">Failed</option>
                            <option value="pending">Pending</option>
                        </select>
                        <button onclick="refreshEmails()" class="action-btn primary">🔄 Refresh</button>
                    </div>
                </div>

                <!-- Email Bulk Action Bar -->
                <div id="email-bulk-action-bar" class="bulk-action-bar">
                    <span class="bulk-selection-info" id="email-bulk-selection-count">0 selected</span>
                    <button class="bulk-action-btn" onclick="bulkResendEmails()">📤 Resend</button>
                    <button class="bulk-action-btn" onclick="bulkExportEmails()">📥 Export</button>
                    <button class="bulk-action-btn danger" onclick="bulkDeleteEmails()">🗑️ Delete</button>
                    <button class="bulk-clear-btn" onclick="clearEmailSelection()">✕ Clear</button>
                </div>

                <div class="data-list" style="padding: 0;" id="emails-container">
                    <div class="paper-list-header" id="email-list-header" style="display: none;">
                        <input type="checkbox" class="select-all-checkbox" id="select-all-emails-checkbox"
                            onclick="toggleSelectAllEmails()" title="Select all emails" />
                        <span>Select All</span>
                        <div class="sort-controls">
                            <span style="font-weight: normal;">Sort by:</span>
                            <button class="sort-btn active" onclick="setEmailSortOrder('created_at', this)"
                                data-sort="created_at">Date</button>
                            <button class="sort-btn" onclick="setEmailSortOrder('recipient_email', this)"
                                data-sort="recipient_email">Recipient</button>
                            <button class="sort-btn" onclick="setEmailSortOrder('status', this)"
                                data-sort="status">Status</button>
                            <button class="sort-dir-btn" id="email-sort-dir-btn" onclick="toggleEmailSortDirection()"
                                title="Toggle sort direction">↓</button>
                        </div>
                    </div>
                    <div id="emails-list">
                        <div class="empty-state">
                            <div class="emoji">📧</div>
                            <div>No emails sent yet.</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Email Details Modal -->
            <div class="modal-overlay" id="email-detail-modal">
                <div class="modal" style="max-width: 700px;">
                    <div class="drawer-header"
                        style="margin: -28px -28px 20px -28px; padding: 20px; border-radius: 20px 20px 0 0;">
                        <h3>📧 Email Details</h3>
                        <button class="drawer-close-btn" onclick="closeEmailDetailModal()">×</button>
                    </div>
                    <div id="email-detail-content">
                        <!-- Content populated dynamically -->
                    </div>
                    <div class="form-actions" style="margin-top: 20px;">
                        <button class="action-btn" onclick="closeEmailDetailModal()">Close</button>
                        <button class="action-btn primary" id="email-resend-btn" onclick="resendEmailFromModal()">📤
                            Resend</button>
                    </div>
                </div>
            </div>

            <!-- Autonomous Components Modal -->
            <div class="modal-overlay" id="autonomous-modal">
                <div class="modal autonomous-modal">
                    <div class="autonomous-modal-header">
                        <h3 id="autonomous-modal-title">🤖 Autonomous Component</h3>
                        <button class="autonomous-modal-close" onclick="closeAutonomousModal()">×</button>
                    </div>
                    <div class="autonomous-modal-content" id="autonomous-modal-content">
                        <div class="autonomous-loading">Loading...</div>
                    </div>
                </div>
            </div>

            <!-- Calendar Tab Panel -->
            <div class="tab-panel" id="tab-calendar">
                <div class="dashboard-header">
                    <h2>📅 Calendar Events</h2>
                    <div class="dashboard-actions">
                        <input type="text" id="calendar-search" placeholder="Search events..." class="search-input"
                            oninput="debouncedCalendarSearch()" />
                        <select id="calendar-filter-status" class="filter-select" onchange="refreshCalendar()">
                            <option value="">All Status</option>
                            <option value="created">Created</option>
                            <option value="upcoming">Upcoming</option>
                            <option value="past">Past</option>
                        </select>
                        <button onclick="showCreateEventModal()" class="action-btn">➕ New Event</button>
                        <button onclick="refreshCalendar()" class="action-btn primary">🔄 Refresh</button>
                    </div>
                </div>

                <!-- Calendar Bulk Action Bar -->
                <div id="calendar-bulk-action-bar" class="bulk-action-bar">
                    <span class="bulk-selection-info" id="calendar-bulk-selection-count">0 selected</span>
                    <button class="bulk-action-btn" onclick="bulkDownloadICS()">📥 Download ICS</button>
                    <button class="bulk-action-btn" onclick="bulkRescheduleEvents()">🔄 Reschedule</button>
                    <button class="bulk-action-btn danger" onclick="bulkDeleteEvents()">🗑️ Delete</button>
                    <button class="bulk-clear-btn" onclick="clearCalendarSelection()">✕ Clear</button>
                </div>

                <div class="data-list" style="padding: 0;" id="calendar-container">
                    <div class="paper-list-header" id="calendar-list-header" style="display: none;">
                        <input type="checkbox" class="select-all-checkbox" id="select-all-calendar-checkbox"
                            onclick="toggleSelectAllCalendar()" title="Select all events" />
                        <span>Select All</span>
                        <div class="sort-controls">
                            <span style="font-weight: normal;">Sort by:</span>
                            <button class="sort-btn active" onclick="setCalendarSortOrder('start_time', this)"
                                data-sort="start_time">Date</button>
                            <button class="sort-btn" onclick="setCalendarSortOrder('title', this)"
                                data-sort="title">Title</button>
                            <button class="sort-btn" onclick="setCalendarSortOrder('duration_minutes', this)"
                                data-sort="duration_minutes">Duration</button>
                            <button class="sort-dir-btn" id="calendar-sort-dir-btn"
                                onclick="toggleCalendarSortDirection()" title="Toggle sort direction">↓</button>
                        </div>
                    </div>
                    <div id="calendar-list">
                        <div class="empty-state">
                            <div class="emoji">📅</div>
                            <div>No calendar events created yet.</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Calendar Event Details Modal -->
            <div class="modal-overlay" id="calendar-detail-modal">
                <div class="modal" style="max-width: 700px;">
                    <div class="drawer-header"
                        style="margin: -28px -28px 20px -28px; padding: 20px; border-radius: 20px 20px 0 0;">
                        <h3>📅 Event Details</h3>
                        <button class="drawer-close-btn" onclick="closeCalendarDetailModal()">×</button>
                    </div>
                    <div id="calendar-detail-content">
                        <!-- Content populated dynamically -->
                    </div>
                    <div class="form-actions" style="margin-top: 20px;">
                        <button class="action-btn" onclick="closeCalendarDetailModal()">Close</button>
                        <button class="action-btn" id="calendar-download-btn" onclick="downloadEventICS()">📥 Download
                            ICS</button>
                        <button class="action-btn primary" id="calendar-edit-btn" onclick="editEventFromModal()">✏️
                            Edit</button>
                    </div>
                </div>
            </div>

            <!-- Create/Edit Event Modal -->
            <div class="modal-overlay" id="create-event-modal">
                <div class="modal" style="max-width: 500px;">
                    <h3 id="event-modal-title">➕ Create New Event</h3>
                    <div class="form-group">
                        <label>Title *</label>
                        <input type="text" id="event-title" placeholder="Paper reading session" />
                    </div>
                    <div class="form-group">
                        <label>Date & Time *</label>
                        <input type="datetime-local" id="event-datetime" />
                    </div>
                    <div class="form-group">
                        <label>Duration (minutes)</label>
                        <input type="number" id="event-duration" value="30" min="5" step="5" />
                    </div>
                    <div class="form-group">
                        <label>Description</label>
                        <textarea id="event-description" rows="3"
                            placeholder="Notes about the paper or reading session"></textarea>
                    </div>
                    <div class="form-group">
                        <label>Reminder (minutes before)</label>
                        <select id="event-reminder">
                            <option value="0">No reminder</option>
                            <option value="5">5 minutes</option>
                            <option value="15" selected>15 minutes</option>
                            <option value="30">30 minutes</option>
                            <option value="60">1 hour</option>
                            <option value="1440">1 day</option>
                        </select>
                    </div>
                    <input type="hidden" id="event-edit-id" value="" />
                    <div class="form-actions">
                        <button class="action-btn" onclick="closeCreateEventModal()">Cancel</button>
                        <button class="action-btn primary" onclick="saveEvent()">💾 Save Event</button>
                    </div>
                </div>
            </div>

            <!-- Shares Tab Panel -->
            <div class="tab-panel" id="tab-shares">
                <div class="dashboard-header">
                    <h2>📤 Shares with Colleagues</h2>
                    <div class="dashboard-actions">
                        <input type="text" id="shares-search" placeholder="Search shares..." class="search-input"
                            oninput="debouncedShareSearch()" />
                        <select id="shares-filter-status" class="filter-select" onchange="refreshShares()">
                            <option value="">All Status</option>
                            <option value="sent">Sent</option>
                            <option value="pending">Pending</option>
                            <option value="failed">Failed</option>
                        </select>
                        <button onclick="refreshShares()" class="action-btn primary">🔄 Refresh</button>
                    </div>
                </div>

                <!-- Share Bulk Action Bar -->
                <div id="share-bulk-action-bar" class="bulk-action-bar">
                    <span class="bulk-selection-info" id="share-bulk-selection-count">0 selected</span>
                    <button class="bulk-action-btn danger" onclick="bulkDeleteShares()">🗑️ Delete</button>
                    <button class="bulk-clear-btn" onclick="clearShareSelection()">✕ Clear</button>
                </div>

                <div class="data-list" style="padding: 0;" id="shares-container">
                    <div class="paper-list-header" id="share-list-header" style="display: none;">
                        <input type="checkbox" class="select-all-checkbox" id="select-all-shares-checkbox"
                            onclick="toggleSelectAllShares()" title="Select all shares" />
                        <span>Select All</span>
                        <div class="sort-controls">
                            <span style="font-weight: normal;">Sort by:</span>
                            <button class="sort-btn active" onclick="setShareSortOrder('created_at', this)"
                                data-sort="created_at">Date</button>
                            <button class="sort-btn" onclick="setShareSortOrder('colleague_name', this)"
                                data-sort="colleague_name">Colleague</button>
                            <button class="sort-btn" onclick="setShareSortOrder('paper_title', this)"
                                data-sort="paper_title">Paper</button>
                            <button class="sort-btn" onclick="setShareSortOrder('status', this)"
                                data-sort="status">Status</button>
                            <button class="sort-dir-btn" id="share-sort-dir-btn" onclick="toggleShareSortDirection()"
                                title="Toggle sort direction">↓</button>
                        </div>
                    </div>
                    <div id="shares-list">
                        <div class="empty-state">
                            <div class="emoji">📤</div>
                            <div>No papers shared with colleagues yet.</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Colleagues Tab Panel -->
            <div class="tab-panel" id="tab-colleagues">
                <div class="dashboard-header">
                    <h2>👥 Colleagues</h2>
                    <div class="dashboard-actions">
                        <input type="text" id="colleagues-search" placeholder="Search colleagues..."
                            class="search-input" oninput="debouncedColleagueSearch()" />
                        <button onclick="refreshColleagues()" class="action-btn">🔄 Refresh</button>
                        <button onclick="showAddColleagueModal()" class="action-btn primary">➕ Add Colleague</button>
                    </div>
                </div>

                <!-- Colleague Bulk Action Bar -->
                <div id="colleague-bulk-action-bar" class="bulk-action-bar">
                    <span class="bulk-selection-info" id="colleague-bulk-selection-count">0 selected</span>
                    <button class="bulk-action-btn danger" onclick="bulkDeleteColleagues()">🗑️ Delete</button>
                    <button class="bulk-clear-btn" onclick="clearColleagueSelection()">✕ Clear</button>
                </div>

                <div class="data-list" style="padding: 0;" id="colleagues-container">
                    <div class="paper-list-header" id="colleague-list-header" style="display: none;">
                        <input type="checkbox" class="select-all-checkbox" id="select-all-colleagues-checkbox"
                            onclick="toggleSelectAllColleagues()" title="Select all colleagues" />
                        <span>Select All</span>
                        <div class="sort-controls">
                            <span style="font-weight: normal;">Sort by:</span>
                            <button class="sort-btn active" onclick="setColleagueSortOrder('name', this)"
                                data-sort="name">Name</button>
                            <button class="sort-btn" onclick="setColleagueSortOrder('email', this)"
                                data-sort="email">Email</button>
                            <button class="sort-btn" onclick="setColleagueSortOrder('created_at', this)"
                                data-sort="created_at">Added Date</button>
                            <button class="sort-dir-btn" id="colleague-sort-dir-btn"
                                onclick="toggleColleagueSortDirection()" title="Toggle sort direction">↑</button>
                        </div>
                    </div>
                    <div id="colleagues-list">
                        <div class="empty-state">
                            <div class="emoji">👥</div>
                            <div>No colleagues configured. Add colleagues to enable paper sharing!</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- About / Help Tab Panel -->
            <div class="tab-panel" id="tab-about">
                <div class="dashboard-header">
                    <h2>❓ About & Help</h2>
                </div>
                <div class="about-content glass-panel" style="padding: 24px; border-radius: 16px;">
                    <div class="about-intro" style="margin-bottom: 24px;">
                        <h3 style="margin: 0 0 12px 0; font-size: 1.25rem;">Welcome to ResearchPulse</h3>
                        <p style="color: var(--text-muted); line-height: 1.6;">ResearchPulse is your autonomous
                            AI-powered research
                            assistant that helps you discover, organize, and stay updated on the latest academic papers
                            relevant to your research interests.</p>
                    </div>

                    <h3 style="margin: 0 0 16px 0; font-size: 1.1rem;">Frequently Asked Questions</h3>
                    <div class="faq-list" id="faq-list">

                        <!-- ═══ Getting Started ═══ -->
                        <div class="faq-category">
                            <div class="faq-category-header">
                                <span class="faq-category-icon">🚀</span> Getting Started
                            </div>
                            <div class="faq-item">
                                <div class="faq-question" onclick="toggleFaq(this)">
                                    <span>How do I get started with ResearchPulse?</span>
                                    <span class="faq-chevron">▶</span>
                                </div>
                                <div class="faq-answer">
                                    <p>1. Go to <strong>My Settings</strong> and fill in your Research Profile — your
                                        name,
                                        interests, and any topics to exclude.</p>
                                    <p>2. Back on the <strong>Home</strong> tab, click <strong>"Search for me"</strong>
                                        to
                                        let the AI agent build a query from your profile, or type your own prompt.</p>
                                    <p>3. The agent searches arXiv, scores each paper for relevance and novelty, and
                                        pushes
                                        results to the <strong>Papers</strong> tab.</p>
                                </div>
                            </div>
                            <div class="faq-item">
                                <div class="faq-question" onclick="toggleFaq(this)">
                                    <span>Can I switch between light and dark mode?</span>
                                    <span class="faq-chevron">▶</span>
                                </div>
                                <div class="faq-answer">
                                    <p>Yes — use the sun/moon toggle in the top navigation bar to switch between light
                                        and
                                        dark themes. Your preference is saved automatically.</p>
                                </div>
                            </div>
                        </div>

                        <!-- ═══ Search & Discovery ═══ -->
                        <div class="faq-category">
                            <div class="faq-category-header">
                                <span class="faq-category-icon">🔍</span> Search & Discovery
                            </div>
                            <div class="faq-item">
                                <div class="faq-question" onclick="toggleFaq(this)">
                                    <span>What does "Search for me" actually do behind the scenes?</span>
                                    <span class="faq-chevron">▶</span>
                                </div>
                                <div class="faq-answer">
                                    <p>It reads your saved research interests and preferred time period from your
                                        profile,
                                        then generates a targeted arXiv search query. The ReAct agent fetches papers,
                                        checks
                                        them against your history via Pinecone RAG to avoid duplicates, scores each
                                        paper's
                                        relevance and novelty, and decides what action to take (notify you, share with a
                                        colleague, or just log it).</p>
                                </div>
                            </div>
                            <div class="faq-item">
                                <div class="faq-question" onclick="toggleFaq(this)">
                                    <span>How do Prompt Templates work?</span>
                                    <span class="faq-chevron">▶</span>
                                </div>
                                <div class="faq-answer">
                                    <p>Prompt Templates are reusable search queries shown at the bottom of the Home tab.
                                        Click any template to insert it into the chat input, then send it as-is or edit
                                        before sending. You can also create and save your own custom templates for
                                        searches
                                        you run frequently.</p>
                                </div>
                            </div>
                            <div class="faq-item">
                                <div class="faq-question" onclick="toggleFaq(this)">
                                    <span>What paper sources does ResearchPulse search?</span>
                                    <span class="faq-chevron">▶</span>
                                </div>
                                <div class="faq-answer">
                                    <p>ResearchPulse searches <strong>arXiv</strong>, covering fields such as computer
                                        science, physics, mathematics, biology, economics, and more. You can control
                                        which
                                        arXiv categories to include or exclude in your settings to narrow down results.
                                    </p>
                                </div>
                            </div>
                            <div class="faq-item">
                                <div class="faq-question" onclick="toggleFaq(this)">
                                    <span>How does the AI decide which papers are relevant to me?</span>
                                    <span class="faq-chevron">▶</span>
                                </div>
                                <div class="faq-answer">
                                    <p>The agent uses a multi-step process:</p>
                                    <ul>
                                        <li><strong>Relevance scoring</strong> — compares each paper's abstract against
                                            your
                                            research interests using the LLM.</li>
                                        <li><strong>Novelty detection</strong> — queries Pinecone vector search to see
                                            if
                                            similar papers have already been recommended.</li>
                                        <li><strong>Importance ranking</strong> — assigns high / medium / low importance
                                            based on both relevance and novelty scores.</li>
                                    </ul>
                                    <p>Only papers that pass the minimum importance threshold trigger an action.</p>
                                </div>
                            </div>
                            <div class="faq-item">
                                <div class="faq-question" onclick="toggleFaq(this)">
                                    <span>How does novelty detection prevent duplicate recommendations?</span>
                                    <span class="faq-chevron">▶</span>
                                </div>
                                <div class="faq-answer">
                                    <p>Every paper the agent processes is embedded as a vector and stored in
                                        <strong>Pinecone</strong>. On future runs, new papers are compared against this
                                        vector store using semantic similarity. If a paper is too similar to something
                                        you've already seen, it's flagged as low-novelty and deprioritized — so you only
                                        see
                                        genuinely new research.
                                    </p>
                                </div>
                            </div>
                        </div>

                        <!-- ═══ Papers & Organization ═══ -->
                        <div class="faq-category">
                            <div class="faq-category-header">
                                <span class="faq-category-icon">📄</span> Papers & Organization
                            </div>
                            <div class="faq-item">
                                <div class="faq-question" onclick="toggleFaq(this)">
                                    <span>How can I organize and manage my papers?</span>
                                    <span class="faq-chevron">▶</span>
                                </div>
                                <div class="faq-answer">
                                    <p>In the <strong>Papers</strong> tab you can:</p>
                                    <ul>
                                        <li>⭐ <strong>Star</strong> papers to bookmark them for later</li>
                                        <li>Toggle <strong>read / unread</strong> status</li>
                                        <li>Mark papers as <strong>"not relevant"</strong> so they're filtered out</li>
                                        <li>Use <strong>bulk actions</strong> — select multiple papers and star, toggle
                                            read, mark not relevant, download PDFs, email a summary, create calendar
                                            reminders, or delete them in one click</li>
                                        <li><strong>Sort</strong> by date, title, relevance, or importance</li>
                                        <li><strong>Filter</strong> by starred, unread, importance level, or arXiv
                                            category
                                        </li>
                                        <li><strong>Export to CSV</strong> for use in reference managers or spreadsheets
                                        </li>
                                    </ul>
                                </div>
                            </div>
                            <div class="faq-item">
                                <div class="faq-question" onclick="toggleFaq(this)">
                                    <span>Can I get an AI summary of a paper?</span>
                                    <span class="faq-chevron">▶</span>
                                </div>
                                <div class="faq-answer">
                                    <p>Yes. Open any paper's detail drawer and click <strong>"Summarize Paper"</strong>.
                                        The
                                        AI reads the PDF and generates a concise summary highlighting key contributions,
                                        methods, and findings. You can also click <strong>"Regenerate"</strong> to get a
                                        fresh summary if needed.</p>
                                </div>
                            </div>
                            <div class="faq-item">
                                <div class="faq-question" onclick="toggleFaq(this)">
                                    <span>What is the Live Document?</span>
                                    <span class="faq-chevron">▶</span>
                                </div>
                                <div class="faq-answer">
                                    <p>The <strong>Live Document</strong> is an auto-updating report generated after
                                        each
                                        agent run. It summarizes the latest findings, actions taken, and key statistics
                                        from
                                        the run — giving you a quick at-a-glance view of what the agent discovered and
                                        did.
                                        Access it from the Home tab.</p>
                                </div>
                            </div>
                            <div class="faq-item">
                                <div class="faq-question" onclick="toggleFaq(this)">
                                    <span>Does my profile improve over time?</span>
                                    <span class="faq-chevron">▶</span>
                                </div>
                                <div class="faq-answer">
                                    <p>Yes. ResearchPulse has a <strong>profile evolution</strong> feature. As you star
                                        papers, mark items as relevant or irrelevant, and interact with results, the
                                        system
                                        learns your preferences. Use the <strong>Profile Suggestions</strong> button on
                                        the
                                        Home tab to see AI-generated recommendations for refining your research
                                        interests.
                                    </p>
                                </div>
                            </div>
                            <div class="faq-item">
                                <div class="faq-question" onclick="toggleFaq(this)">
                                    <span>What are Profile Suggestions?</span>
                                    <span class="faq-chevron">▶</span>
                                </div>
                                <div class="faq-answer">
                                    <p><strong>Profile Suggestions</strong> analyze patterns in the papers you've
                                        starred or
                                        marked as relevant and recommend updates to your research profile. This helps
                                        the
                                        agent get better at finding papers you care about over time — a form of profile
                                        evolution.</p>
                                </div>
                            </div>
                        </div>

                        <!-- ═══ Colleagues & Sharing ═══ -->
                        <div class="faq-category">
                            <div class="faq-category-header">
                                <span class="faq-category-icon">👥</span> Colleagues & Sharing
                            </div>
                            <div class="faq-item">
                                <div class="faq-question" onclick="toggleFaq(this)">
                                    <span>How do I share papers with colleagues?</span>
                                    <span class="faq-chevron">▶</span>
                                </div>
                                <div class="faq-answer">
                                    <p>1. Add colleagues in the <strong>Colleagues</strong> tab with their name, email,
                                        and
                                        research interests.</p>
                                    <p>2. When the agent finds papers matching a colleague's interests, it can
                                        autonomously
                                        share them via email.</p>
                                    <p>3. Track all shares and their delivery status (sent, pending, failed) in the
                                        <strong>Shares</strong> tab.
                                    </p>
                                </div>
                            </div>
                            <div class="faq-item">
                                <div class="faq-question" onclick="toggleFaq(this)">
                                    <span>What is the Colleague Join Code?</span>
                                    <span class="faq-chevron">▶</span>
                                </div>
                                <div class="faq-answer">
                                    <p>The <strong>Join Code</strong> is a secret passphrase you set in <strong>My
                                            Settings → Colleague Join Code</strong>. It acts as a gatekeeper: only
                                        people who know the code can join your ResearchPulse network.</p>
                                    <p>There are <strong>two ways</strong> a colleague can join:</p>
                                    <ul>
                                        <li><strong>Via invite link</strong> — you add them in the Colleagues tab, they
                                            receive an email with a personalized link, and enter the join code on the
                                            web form to confirm.</li>
                                        <li><strong>Via email (autonomous)</strong> — a colleague can send an email
                                            directly to the ResearchPulse inbox mentioning they want to join and
                                            including the join code in the message body. The system's <strong>Inbox
                                                Monitor</strong> autonomously detects the join request, verifies the
                                            code,
                                            and adds them — no manual action needed from you.</li>
                                    </ul>
                                    <p>Share the code privately with trusted colleagues only.</p>
                                </div>
                            </div>
                            <div class="faq-item">
                                <div class="faq-question" onclick="toggleFaq(this)">
                                    <span>Can colleagues manage their own preferences?</span>
                                    <span class="faq-chevron">▶</span>
                                </div>
                                <div class="faq-answer">
                                    <p>Yes. Each colleague receives self-service links in the emails they get:</p>
                                    <ul>
                                        <li><strong>Update Interests</strong> — they can update their own research
                                            interests and preferred arXiv categories via a personal web form, so the
                                            agent shares more relevant papers with them.</li>
                                        <li><strong>Unsubscribe</strong> — a one-click link to remove themselves from
                                            your network at any time.</li>
                                    </ul>
                                </div>
                            </div>
                        </div>

                        <!-- ═══ Emails, Calendar & Alerts ═══ -->
                        <div class="faq-category">
                            <div class="faq-category-header">
                                <span class="faq-category-icon">📧</span> Emails, Calendar & Alerts
                            </div>
                            <div class="faq-item">
                                <div class="faq-question" onclick="toggleFaq(this)">
                                    <span>How do email notifications work?</span>
                                    <span class="faq-chevron">▶</span>
                                </div>
                                <div class="faq-answer">
                                    <p>Once your email is configured in My Settings, ResearchPulse can:</p>
                                    <ul>
                                        <li>Send you <strong>digest emails</strong> summarizing high-importance papers
                                            from
                                            a run</li>
                                        <li>Autonomously <strong>share papers</strong> with colleagues whose interests
                                            match</li>
                                        <li>Monitor your <strong>inbox</strong> for replies (e.g., a colleague
                                            responding to
                                            a shared paper)</li>
                                    </ul>
                                    <p>You can view all sent and pending emails in the <strong>Emails</strong> tab.</p>
                                </div>
                            </div>
                            <div class="faq-item">
                                <div class="faq-question" onclick="toggleFaq(this)">
                                    <span>How do Calendar Alerts work?</span>
                                    <span class="faq-chevron">▶</span>
                                </div>
                                <div class="faq-answer">
                                    <p>The agent can create reading reminders as calendar events. You can:</p>
                                    <ul>
                                        <li>Download <strong>.ics files</strong> and import them into Google Calendar,
                                            Outlook, or Apple Calendar</li>
                                        <li>Let the AI <strong>auto-suggest</strong> calendar events for high-importance
                                            papers</li>
                                        <li>Manage all events in the <strong>Alerts</strong> tab</li>
                                    </ul>
                                </div>
                            </div>
                            <div class="faq-item">
                                <div class="faq-question" onclick="toggleFaq(this)">
                                    <span>What is Inbox Check and how do I configure it?</span>
                                    <span class="faq-chevron">▶</span>
                                </div>
                                <div class="faq-answer">
                                    <p><strong>Inbox Check</strong> autonomously monitors your email for replies from
                                        colleagues you've shared papers with. Configure the check frequency in
                                        <strong>My
                                            Settings → Inbox Check Settings</strong>. You can also trigger a manual
                                        check
                                        with the <strong>"Check Now"</strong> button.
                                    </p>
                                </div>
                            </div>
                        </div>

                        <!-- ═══ Settings & Advanced ═══ -->
                        <div class="faq-category">
                            <div class="faq-category-header">
                                <span class="faq-category-icon">⚙️</span> Settings & Advanced
                            </div>
                            <div class="faq-item">
                                <div class="faq-question" onclick="toggleFaq(this)">
                                    <span>What are the Papers per Run and Execution Mode settings?</span>
                                    <span class="faq-chevron">▶</span>
                                </div>
                                <div class="faq-answer">
                                    <p>Under <strong>My Settings</strong> you'll find two configurable cards:</p>
                                    <ul>
                                        <li><strong>Papers per Run</strong> — controls how many papers the agent fetches
                                            from arXiv each run. Higher values consume more tokens and take longer.</li>
                                        <li><strong>Execution Mode</strong> — choose <em>Manual only</em> (you trigger
                                            each run) or <em>Keep alive (scheduled)</em> to have the agent run
                                            autonomously on a schedule (daily, every X days, weekly, or monthly).</li>
                                    </ul>
                                </div>
                            </div>
                            <div class="faq-item">
                                <div class="faq-question" onclick="toggleFaq(this)">
                                    <span>What are History Logs?</span>
                                    <span class="faq-chevron">▶</span>
                                </div>
                                <div class="faq-answer">
                                    <p><strong>History Logs</strong> provide a complete audit trail of every research
                                        run.
                                        Each entry shows how many papers were retrieved, scored, shared, and discarded,
                                        along with timing and stop-reason details. Access them via the
                                        <strong>"📋 History Logs"</strong> button on the Home tab.
                                    </p>
                                </div>
                            </div>
                            <div class="faq-item">
                                <div class="faq-question" onclick="toggleFaq(this)">
                                    <span>Can I stop or cancel a running agent?</span>
                                    <span class="faq-chevron">▶</span>
                                </div>
                                <div class="faq-answer">
                                    <p>Yes. While the agent is running, the <strong>"Run Agent"</strong> button turns
                                        into
                                        a <strong>Stop</strong> button. Click it to cancel the current run immediately.
                                        Any papers already processed will still appear in your results.</p>
                                </div>
                            </div>
                            <div class="faq-item">
                                <div class="faq-question" onclick="toggleFaq(this)">
                                    <span>What does the System Health check show?</span>
                                    <span class="faq-chevron">▶</span>
                                </div>
                                <div class="faq-answer">
                                    <p>In <strong>My Settings</strong>, the <strong>System Health</strong> section shows
                                        the
                                        connection status of your Database, Pinecone vector store, and Email Provider.
                                        Click <strong>"🔍 Check Health"</strong> to verify all services are reachable.
                                    </p>
                                </div>
                            </div>
                        </div>

                    </div>

                </div>
            </div>

            <!-- Settings Tab Panel -->
            <div class="tab-panel" id="tab-settings">
                <div class="dashboard-header">
                    <h2>⚙️ Research Profile & Personal Settings </h2>
                </div>
                <div class="settings-grid">
                    <!-- Research Profile Section -->
                    <div class="settings-section profile-section">
                        <h3>👤 Research Profile</h3>
                        <p class="section-desc">Update your research areas and preferences to get better paper
                            recommendations.</p>
                        <div class="profile-form">
                            <div class="form-row">
                                <label>Name:</label>
                                <input type="text" id="profile-name" placeholder="Your name" />
                            </div>
                            <div class="form-row">
                                <label>Email:</label>
                                <input type="email" id="profile-email" placeholder="your.email@example.com" />
                            </div>
                            <div class="form-row">
                                <label>Affiliation:</label>
                                <input type="text" id="profile-affiliation" placeholder="Your institution" />
                            </div>
                            <div class="form-row">
                                <label>Research Interests:</label>
                                <textarea id="profile-interests-include"
                                    placeholder="Describe your research areas (free text)&#10;e.g. machine learning, natural language processing, biology, AI agents"
                                    rows="4"></textarea>
                            </div>
                            <div class="form-row">
                                <label>Topics to Exclude:</label>
                                <textarea id="profile-interests-exclude"
                                    placeholder="Topics to filter out (free text)&#10;" rows="2"></textarea>
                            </div>
                            <div class="form-row">
                                <label>Preferred Search Time Period:</label>
                                <select id="profile-time-period">
                                    <option value="last week">Last week</option>
                                    <option value="last two weeks" selected>Last two weeks</option>
                                    <option value="last month">Last month</option>
                                    <option value="last 3 months">Last 3 months</option>
                                    <option value="last 6 months">Last 6 months</option>
                                </select>
                            </div>
                        </div>
                        <div style="display: flex; align-items: center; gap: 8px; flex-wrap: wrap;">
                            <button onclick="saveProfile()" class="action-btn primary">💾 Save Profile</button>
                            <button onclick="clearProfile()" class="action-btn">🗑️ Clear Details</button>
                            <span id="profile-save-status" class="save-status"></span>
                        </div>
                    </div>

                    <div class="settings-section">
                        <h3>🔗 System Health</h3>
                        <div id="health-status" class="health-status">
                            <div class="health-item"><span class="health-label">Database:</span><span id="health-db"
                                    class="health-value">Checking...</span></div>
                            <div class="health-item"><span class="health-label">Pinecone:</span><span
                                    id="health-pinecone" class="health-value">Checking...</span></div>
                            <div class="health-item"><span class="health-label">Email Provider:</span><span
                                    id="health-email" class="health-value">Checking...</span></div>
                        </div>
                        <button onclick="checkHealth()" class="action-btn">🔍 Check Health</button>
                    </div>

                    <!-- Inbox Check Settings -->
                    <div class="settings-section">
                        <h3>📬 Inbox Check Settings</h3>
                        <p class="section-desc">Configure automatic inbox monitoring for email replies and colleague
                            join requests.</p>
                        <div class="inbox-settings-form">
                            <div class="form-row">
                                <label>Inbox Check Frequency:</label>
                                <select id="inbox-check-frequency">
                                    <option value="">Disabled (power saving)</option>
                                    <option value="10">Every 10 seconds</option>
                                    <option value="30">Every 30 seconds</option>
                                    <option value="60">Every 1 minute</option>
                                    <option value="300">Every 5 minutes</option>
                                    <option value="900">Every 15 minutes</option>
                                    <option value="3600">Every 1 hour</option>
                                </select>
                            </div>
                            <div class="form-row" style="margin-top: 8px;">
                                <span id="inbox-last-check" style="font-size: 0.85em; color: #666;"></span>
                            </div>
                        </div>
                        <div style="margin-top: 12px; display: flex; align-items: center; gap: 8px; flex-wrap: wrap;">
                            <button onclick="saveInboxSettings()" class="action-btn primary">💾 Save Inbox
                                Settings</button>
                            <button onclick="checkInboxNow()" class="action-btn">📥 Check Now</button>
                        </div>
                        <span id="inbox-save-status" class="save-status"></span>
                    </div>

                    <!-- Bottom row: 3 boxes side by side -->
                    <div style="grid-column: 1 / -1; display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px;">
                        <!-- Colleague Join Code -->
                        <div class="settings-section">
                            <h3>🔐 Colleague Join Code</h3>
                            <p class="section-desc">Set a join code that colleagues must provide when requesting to join
                                via
                                email. Share this code privately with trusted colleagues.</p>
                            <div class="join-code-form">
                                <div class="form-row" style="margin-bottom: 8px;">
                                    <label>Current Code:</label>
                                    <span id="current-join-code-display"
                                        style="font-weight: bold; color: var(--accent);">Loading...</span>
                                </div>
                                <div class="form-row">
                                    <label>Set New Code:</label>
                                    <input type="text" id="colleague-join-code"
                                        placeholder="Enter a secret code (4-32 chars)" maxlength="32" />
                                </div>
                                <div id="join-code-status" style="font-size: 0.85em; color: #666; margin-top: 4px;">
                                </div>
                            </div>
                            <div
                                style="margin-top: 12px; display: flex; align-items: center; gap: 8px; flex-wrap: wrap;">
                                <button onclick="setJoinCode()" class="action-btn primary">🔑 Set Code</button>
                                <button onclick="clearJoinCode()" class="action-btn">🗑️ Clear</button>
                            </div>
                            <span id="join-code-save-status" class="save-status"></span>
                        </div>

                        <!-- Papers per Run -->
                        <div class="settings-section">
                            <h3>📊 Papers per Run</h3>
                            <p class="section-desc">How many papers to fetch from arXiv each run.</p>
                            <div class="form-row" style="margin-bottom: 8px;">
                                <label>Papers to fetch:</label>
                                <input type="number" id="exec-retrieval-max" min="1" max="50" value="7"
                                    style="width: 80px;" />
                            </div>
                            <p style="font-size: 0.8em; color: #888; margin: 0 0 12px 0;">
                                ⚠️ Increasing this will consume more tokens, cost more, and be slower.
                            </p>
                            <div style="display: flex; align-items: center; gap: 8px; flex-wrap: wrap;">
                                <button onclick="savePapersPerRunSettings()" class="action-btn primary">💾 Save
                                    Settings</button>
                                <button onclick="setDefaultPapersPerRun()" class="action-btn">🔄 Default</button>
                            </div>
                            <span id="exec-save-status" class="save-status"></span>
                        </div>

                        <!-- Execution Mode -->
                        <div class="settings-section">
                            <h3>⚙️ Execution Mode</h3>
                            <p class="section-desc">Configure whether runs happen manually or on a schedule.</p>
                            <div class="form-row" style="margin-bottom: 8px;">
                                <label>Execution Mode:</label>
                                <select id="exec-mode" onchange="toggleScheduleOptions()">
                                    <option value="manual">Manual only</option>
                                    <option value="scheduled">Keep alive (scheduled)</option>
                                </select>
                            </div>

                            <!-- Schedule Options (shown only when scheduled) -->
                            <div id="schedule-options"
                                style="display: none; margin-left: 16px; padding: 12px; border-left: 3px solid var(--accent); margin-bottom: 12px;">
                                <div class="form-row" style="margin-bottom: 8px;">
                                    <label>Frequency:</label>
                                    <select id="exec-frequency" onchange="toggleEveryXDays()">
                                        <option value="daily">Daily</option>
                                        <option value="every_x_days">Every X days</option>
                                        <option value="weekly">Weekly</option>
                                        <option value="monthly">Monthly</option>
                                    </select>
                                </div>
                                <div id="every-x-days-input" style="display: none;" class="form-row">
                                    <label>Every how many days?</label>
                                    <input type="number" id="exec-every-x-days" min="1" max="30" value="3"
                                        style="width: 80px;" />
                                </div>
                            </div>

                            <!-- Run timestamps (read-only) -->
                            <div style="font-size: 0.85em; color: #666; margin-bottom: 12px;">
                                <div>Last run: <span id="exec-last-run">—</span></div>
                                <div>Next run: <span id="exec-next-run">—</span></div>
                            </div>

                            <div style="display: flex; align-items: center; gap: 8px; flex-wrap: wrap;">
                                <button onclick="saveExecutionModeSettings()" class="action-btn primary">💾 Save
                                    Schedule</button>
                                <button onclick="setDefaultExecutionMode()" class="action-btn">🔄 Default</button>
                            </div>
                            <span id="exec-save-status-mode" class="save-status"></span>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        // =============================================================================
        // State
        // =============================================================================
        const state = {
            currentRunId: null,
            pollInterval: null,
            isRunning: false,
            abortController: null,
            buttonMode: 'send',  // 'send' or 'stop' - tracks button visual state
        };

        // =============================================================================
        // DOM Elements
        // =============================================================================
        const elements = {
            chatMessages: document.getElementById('chat-messages'),
            messageInput: document.getElementById('message-input'),
            sendBtn: document.getElementById('send-btn'),
            statusBadge: document.getElementById('status-badge'),
            reportPanel: document.getElementById('report-panel'),
            reportContent: document.getElementById('report-content'),
        };

        // =============================================================================
        // Utilities
        // =============================================================================
        function formatTime(isoString) {
            try {
                const date = new Date(isoString);
                return date.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
            } catch {
                return isoString;
            }
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function scrollToBottom(element) {
            element.scrollTop = element.scrollHeight;
        }

        // =============================================================================
        // UI Updates
        // =============================================================================
        function setStatus(status) {
            const badge = elements.statusBadge;
            badge.className = 'status-badge status-' + status.toLowerCase();
            badge.textContent = status.charAt(0).toUpperCase() + status.slice(1);
        }

        function setInputEnabled(enabled) {
            elements.messageInput.disabled = !enabled;
            // Update button state tracking
            state.buttonMode = enabled ? 'send' : 'stop';

            if (!enabled) {
                // Show Stop button when agent is running (round with white square SVG)
                elements.sendBtn.innerHTML = '<svg class="stop-icon" width="16" height="16" viewBox="0 0 24 24" fill="white"><rect x="4" y="4" width="16" height="16" rx="2"/></svg>';
                elements.sendBtn.classList.add('stop-mode');
                elements.sendBtn.disabled = false;
            } else {
                // Show Send button when ready for input
                elements.sendBtn.innerHTML = `
                    <span>Run Agent</span>
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M22 2L11 13M22 2L15 22L11 13M22 2L2 9L11 13"/>
                    </svg>
                `;
                elements.sendBtn.classList.remove('stop-mode');
                elements.sendBtn.disabled = false;
            }
        }

        // Unified button click handler - delegates based on current mode
        function handleButtonClick() {
            if (state.buttonMode === 'stop' || state.isRunning) {
                cancelRun();
            } else {
                handleSend();
            }
        }

        // Cancel a running agent
        async function cancelRun() {
            console.log('[DEBUG] cancelRun called, currentRunId:', state.currentRunId);
            if (!state.currentRunId) {
                // If no run ID, just reset the UI
                console.log('[DEBUG] No run ID, just resetting UI');
                state.isRunning = false;
                removeAgentThinking();
                setInputEnabled(true);
                setStatus('cancelled');
                addMessage('Run cancelled', false);
                return;
            }
            try {
                console.log('[DEBUG] Sending cancel request for run_id:', state.currentRunId);
                const response = await fetch('/api/cancel', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ run_id: state.currentRunId, reason: 'User cancelled' })
                });
                const result = await response.json();
                console.log('[DEBUG] Cancel response:', result);
                state.isRunning = false;
                state.currentRunId = null;
                removeAgentThinking();
                addMessage('Run cancelled', false);
                setInputEnabled(true);
                setStatus('cancelled');
            } catch (e) {
                console.error('Cancel error:', e);
                state.isRunning = false;
                setInputEnabled(true);
                setStatus('error');
            }
        }

        // Start a new chat - clear all state
        function newChat() {
            // Cancel any running agent
            if (state.isRunning) {
                cancelRun();
            }

            // Clear chat messages and restore empty state
            elements.chatMessages.innerHTML = `
                <div class="empty-state">
                    <div class="chat-empty-logo">
                        <img src="/static/public/logo2.png" alt="ResearchPulse" class="chat-empty-logo-img">
                    </div>
                    <div>Start by asking ResearchPulse to find papers!</div>
                    <div style="margin-top:8px;font-size:0.9rem;color:#94a3b8;">
                        Try: "Find recent papers on transformer architectures"
                    </div>
                </div>
            `;

            // Clear input
            elements.messageInput.value = '';
            resetTextareaHeight(elements.messageInput);

            // Reset state
            state.currentRunId = null;
            state.isRunning = false;
            state.abortController = null;

            // Update UI
            elements.reportPanel.classList.remove('visible');
            setStatus('idle');
            setInputEnabled(true);
        }

        function clearEmptyState() {
            const emptyState = elements.chatMessages.querySelector('.empty-state');
            if (emptyState) {
                emptyState.remove();
            }
        }

        function addMessage(text, isUser, timestamp = new Date().toISOString()) {
            clearEmptyState();

            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${isUser ? 'user' : 'agent'}`;

            messageDiv.innerHTML = `
        <div class="message-bubble">${escapeHtml(text)}</div>
        <div class="message-time">${formatTime(timestamp)}</div>
      `;

            elements.chatMessages.appendChild(messageDiv);
            scrollToBottom(elements.chatMessages);
        }

        /**
         * Parse papers from the agent response text.
         * Extracts titles and arXiv IDs deterministically (no LLM calls).
         */
        function parsePapersFromResponse(responseText) {
            if (!responseText) return [];
            const papers = [];
            // Try JSON parse first (if response is JSON)
            try {
                const parsed = JSON.parse(responseText);
                if (parsed && Array.isArray(parsed.papers)) {
                    return parsed.papers.map(p => ({
                        title: p.title || 'Untitled',
                        arxiv_id: p.arxiv_id || p.external_id || ''
                    }));
                }
            } catch { /* not JSON, use regex */ }
            // Regex extraction: look for arXiv IDs
            const arxivRegex = /(?:arxiv[:\s]*)?(\d{4}\.\d{4,5})/gi;
            const titleLineRegex = /^\d+\.\s*['"]?(.+?)['"]?\s*[-–—]\s*/gm;
            let match;
            // Extract lines that look like paper listings
            const lines = responseText.split('\n');
            for (const line of lines) {
                const numMatch = line.match(/^\d+\.\s*['"](.+?)['"]/);
                if (numMatch) {
                    const idMatch = line.match(/(\d{4}\.\d{4,5})/);
                    papers.push({
                        title: numMatch[1],
                        arxiv_id: idMatch ? idMatch[1] : ''
                    });
                }
            }
            // If no papers found by listing format, just extract arXiv IDs
            if (papers.length === 0) {
                while ((match = arxivRegex.exec(responseText)) !== null) {
                    papers.push({ title: '', arxiv_id: match[1] });
                }
            }
            return papers;
        }

        /**
         * Extract structured data from execution steps.
         * Pure deterministic transformation – no LLM, no API calls.
         * Returns { fetchedCount, seenCount, unseenCount, deliveredCount,
         *           seenPapers: [...], unseenPapers: [...], deliveredPapers: [...],
         *           papers: [{title, arxiv_id, published, importance, relevance, explanation, status}],
         *           actions: [string], stopReason: string }
         */
        function extractDataFromSteps(steps) {
            if (!steps || steps.length === 0) return null;

            const data = {
                fetchedCount: 0,
                seenCount: 0,
                unseenCount: 0,
                deliveredCount: 0,
                papers: [],
                seenPapers: [],
                unseenPapers: [],
                deliveredPapers: [],
                actions: [],
                stopReason: ''
            };

            // Map to deduplicate papers by arxiv_id
            const paperMap = new Map();
            // Sets to track status
            const seenIds = new Set();
            const unseenIds = new Set();
            const deliveredIds = new Set();

            for (const step of steps) {
                const mod = step.module || '';
                const result = (step.response && step.response.result) || {};

                if (mod === 'FetchArxivPapers') {
                    // result may have papers array and total_found
                    if (Array.isArray(result.papers)) {
                        data.fetchedCount = result.papers.length;
                        for (const p of result.papers) {
                            const id = p.arxiv_id || p.external_id || '';
                            if (id && !paperMap.has(id)) {
                                paperMap.set(id, {
                                    title: p.title || '',
                                    arxiv_id: id,
                                    published: p.published || p.date || '',
                                    importance: null,
                                    relevance: null,
                                    explanation: '',
                                    status: 'fetched'
                                });
                            }
                        }
                    }
                    if (typeof result.total_found === 'number') {
                        data.fetchedCount = Math.max(data.fetchedCount, result.total_found);
                    }
                }

                if (mod === 'CheckSeenPapers') {
                    const summary = result.summary || {};
                    if (typeof summary.seen === 'number') data.seenCount = summary.seen;
                    if (typeof summary.unseen === 'number') data.unseenCount = summary.unseen;
                    if (typeof summary.total === 'number' && data.fetchedCount === 0) {
                        data.fetchedCount = summary.total;
                    }
                    // Track seen paper IDs
                    if (Array.isArray(result.seen_papers)) {
                        for (const p of result.seen_papers) {
                            const id = p.arxiv_id || p.external_id || p || '';
                            if (id) {
                                seenIds.add(typeof id === 'string' ? id : (id.arxiv_id || ''));
                            }
                        }
                    }
                    // Track unseen paper IDs
                    if (Array.isArray(result.unseen_papers)) {
                        for (const p of result.unseen_papers) {
                            const id = p.arxiv_id || p.external_id || p || '';
                            if (id) {
                                unseenIds.add(typeof id === 'string' ? id : (id.arxiv_id || ''));
                            }
                        }
                    }
                }

                if (mod === 'ScoreRelevanceAndImportance') {
                    // Each invocation scores one paper; input_args should contain the paper
                    const input = step.prompt || {};
                    const paperId = (input.paper && (input.paper.arxiv_id || input.paper.external_id))
                        || input.arxiv_id || '';
                    if (paperId && paperMap.has(paperId)) {
                        const entry = paperMap.get(paperId);
                        if (typeof result.importance === 'number') entry.importance = result.importance;
                        if (typeof result.relevance_score === 'number') entry.relevance = result.relevance_score;
                        if (result.explanation) entry.explanation = result.explanation;
                    }
                }

                if (mod === 'DecideDeliveryAction') {
                    const action = result.action || result.decision || '';
                    const input = step.prompt || {};
                    const paperId = (input.paper && (input.paper.arxiv_id || input.paper.external_id))
                        || input.arxiv_id || '';
                    if (action) data.actions.push(action);
                    if (action === 'deliver' || action === 'email' || action === 'send') {
                        data.deliveredCount++;
                        if (paperId) deliveredIds.add(paperId);
                    }
                }

                if (mod === 'TerminateRun') {
                    data.stopReason = result.reason || result.stop_reason || '';
                }
            }

            // Assign status to each paper and sort into groups
            for (const [id, paper] of paperMap) {
                if (deliveredIds.has(id)) {
                    paper.status = 'delivered';
                    data.deliveredPapers.push(paper);
                } else if (unseenIds.has(id)) {
                    paper.status = 'new';
                    data.unseenPapers.push(paper);
                } else if (seenIds.has(id)) {
                    paper.status = 'seen';
                    data.seenPapers.push(paper);
                } else {
                    // If no CheckSeenPapers data, infer from presence
                    paper.status = 'fetched';
                    data.seenPapers.push(paper);
                }
            }

            data.papers = Array.from(paperMap.values());
            return data;
        }

        /**
         * Extract run stats from response text.
         */
        function parseRunStats(responseText) {
            if (!responseText) return {};
            const stats = {};
            const runIdMatch = responseText.match(/Run ID:\s*(\S+)/);
            if (runIdMatch) stats.runId = runIdMatch[1];
            const papersMatch = responseText.match(/Papers Processed:\s*(\d+)/);
            if (papersMatch) stats.papersProcessed = parseInt(papersMatch[1]);
            const decisionsMatch = responseText.match(/Decisions Made:\s*(\d+)/);
            if (decisionsMatch) stats.decisionsMade = parseInt(decisionsMatch[1]);
            const artifactsMatch = responseText.match(/Artifacts Generated:\s*(\d+)/);
            if (artifactsMatch) stats.artifactsGenerated = parseInt(artifactsMatch[1]);
            const stopMatch = responseText.match(/Stop Reason:\s*(.+)/);
            if (stopMatch) stats.stopReason = stopMatch[1].trim();
            // Detect "New Papers Found but Filtered" scenario
            stats.hasFilteredPapers = /New Papers Found but Filtered/.test(responseText);
            stats.hasNoNewPapers = /No New Papers Found/.test(responseText);
            stats.hasNoPapersRetrieved = /No Papers Retrieved/.test(responseText);
            stats.isOutOfScope = /topic_outside_arxiv_scope/.test(responseText) || /does not appear to fall within/.test(responseText);
            // Extract unseen/filtered counts from the new message format
            const unseenMatch = responseText.match(/Found (\d+) new \(unseen\) papers/);
            if (unseenMatch) stats.unseenCount = parseInt(unseenMatch[1]);
            const filteredMatch = responseText.match(/(\d+) paper\(s\) filtered out/);
            if (filteredMatch) stats.filteredCount = parseInt(filteredMatch[1]);
            return stats;
        }

        /**
         * Render the dual-layer execute result: summary view + expandable raw details.
         * The raw API response is preserved exactly for grading.
         */
        function renderExecuteResult(result) {
            clearEmptyState();
            const container = document.createElement('div');
            container.className = 'message agent';

            const isOk = result.status === 'ok';
            const stats = parseRunStats(result.response);
            const steps = result.steps || [];
            const stepsData = extractDataFromSteps(steps);

            // Prefer structured step data; fall back to regex-parsed papers
            const papers = (stepsData && stepsData.papers.length > 0)
                ? stepsData.papers
                : parsePapersFromResponse(result.response);

            // Determine summary variant
            const isFiltered = isOk && stats.hasFilteredPapers;
            const isNoNew = isOk && stats.hasNoNewPapers;
            const isNoRetrieved = isOk && stats.hasNoPapersRetrieved;
            const isOutOfScope = isOk && stats.isOutOfScope;

            // Build summary HTML
            let html = '<div class="message-bubble chat-summary">';

            // Status badge
            if (!isOk) {
                html += '<div class="chat-summary-status error">❌ Error</div>';
            } else if (isFiltered) {
                html += '<div class="chat-summary-status filtered">🔍 New papers found but filtered</div>';
            } else if (isNoNew) {
                html += '<div class="chat-summary-status ok">📭 You\'re up to date</div>';
            } else if (isNoRetrieved) {
                html += '<div class="chat-summary-status error">⚠️ No papers retrieved</div>';
            } else if (isOutOfScope) {
                html += '<div class="chat-summary-status ok">✅ Run completed</div>';
            } else {
                html += '<div class="chat-summary-status ok">✅ Run completed</div>';
            }

            if (!isOk) {
                html += `<div style="margin:8px 0;color:var(--error);">${escapeHtml(result.error || 'Unknown error')}</div>`;
                html += '<div style="font-size:0.85rem;color:var(--text-muted);">Open the details below to inspect the full trace.</div>';
            } else {
                // --- Result paragraph ---
                if (stepsData) {
                    const parts = [];
                    if (stepsData.fetchedCount > 0) parts.push(`Fetched <strong>${stepsData.fetchedCount}</strong> paper(s) from arXiv`);
                    if (stepsData.seenCount > 0) parts.push(`<strong>${stepsData.seenCount}</strong> already seen`);
                    if (stepsData.unseenCount > 0) parts.push(`<strong>${stepsData.unseenCount}</strong> new candidate(s)`);
                    if (stepsData.deliveredCount > 0) parts.push(`<strong>${stepsData.deliveredCount}</strong> delivered`);
                    else if (stats.papersProcessed !== undefined) parts.push(`<strong>${stats.papersProcessed}</strong> delivered`);
                    if (parts.length > 0) {
                        html += `<div class="chat-summary-stats">${parts.join(' · ')}</div>`;
                    }
                } else {
                    // Fall back to regex-based stats
                    const statParts = [];
                    if (stats.runId) statParts.push(`Run: <code>${escapeHtml(stats.runId.substring(0, 8))}…</code>`);
                    if (stats.papersProcessed !== undefined) statParts.push(`${stats.papersProcessed} paper(s) delivered`);
                    if (stats.unseenCount !== undefined) statParts.push(`${stats.unseenCount} unseen found`);
                    if (stats.filteredCount !== undefined) statParts.push(`${stats.filteredCount} filtered out`);
                    if (stats.decisionsMade !== undefined && stats.decisionsMade > 0) statParts.push(`${stats.decisionsMade} decisions`);
                    if (stats.artifactsGenerated !== undefined && stats.artifactsGenerated > 0) statParts.push(`${stats.artifactsGenerated} artifacts`);
                    if (statParts.length > 0) {
                        html += `<div class="chat-summary-stats">${statParts.join(' · ')}</div>`;
                    }
                }

                // Filtered explanation
                if (isFiltered) {
                    html += '<div style="font-size:0.85rem;color:var(--text-muted);margin:6px 0 10px 0;">';
                    html += 'New papers were discovered but none met your relevance or quality criteria. ';
                    html += 'Adjust your research topics or thresholds in <strong>Settings</strong> to broaden matches.';
                    html += '</div>';
                }

                // Out-of-scope topic explanation
                if (isOutOfScope) {
                    html += '<div style="font-size:0.85rem;color:var(--text-muted);margin:6px 0 10px 0;white-space:pre-line;">';
                    html += escapeHtml(result.response || '');
                    html += '</div>';
                }

                // No new papers explanation
                if (isNoNew) {
                    html += '<div style="font-size:0.85rem;color:var(--text-muted);margin:6px 0 10px 0;">';
                    html += 'All fetched papers have already been processed. You\'re up to date! ';
                    html += 'New papers are typically published on arXiv weekdays.';
                    html += '</div>';
                }

                // --- Paper cards grouped by status ---
                function renderPaperCard(p) {
                    const title = escapeHtml(p.title || p.arxiv_id || 'Untitled');
                    const id = p.arxiv_id ? escapeHtml(p.arxiv_id) : '';
                    const published = p.published ? escapeHtml(String(p.published).substring(0, 10)) : '';
                    let card = '<div class="paper-card">';
                    card += `<div class="paper-card-title">${title}</div>`;
                    card += '<div class="paper-card-meta">';
                    if (id) card += `<span class="paper-card-id">${id}</span>`;
                    if (published) card += `<span class="paper-card-date">${published}</span>`;
                    if (typeof p.relevance === 'number') {
                        const cls = p.relevance >= 7 ? 'high' : (p.relevance >= 4 ? 'mid' : 'low');
                        card += `<span class="paper-tag ${cls}">relevance ${p.relevance}</span>`;
                    }
                    if (typeof p.importance === 'number') {
                        const cls = p.importance >= 7 ? 'high' : (p.importance >= 4 ? 'mid' : 'low');
                        card += `<span class="paper-tag ${cls}">importance ${p.importance}</span>`;
                    }
                    card += '</div></div>';
                    return card;
                }

                if (stepsData && (stepsData.deliveredPapers.length > 0 || stepsData.unseenPapers.length > 0 || stepsData.seenPapers.length > 0)) {
                    // Delivered papers
                    if (stepsData.deliveredPapers.length > 0) {
                        html += `<div class="paper-group-label delivered">📬 Delivered (${stepsData.deliveredPapers.length})</div>`;
                        html += '<div class="chat-summary-papers">';
                        stepsData.deliveredPapers.forEach(p => { html += renderPaperCard(p); });
                        html += '</div>';
                    }
                    // New candidates (unseen but not delivered)
                    if (stepsData.unseenPapers.length > 0) {
                        html += `<div class="paper-group-label new">🆕 New Candidates (${stepsData.unseenPapers.length})</div>`;
                        html += '<div class="chat-summary-papers">';
                        stepsData.unseenPapers.forEach(p => { html += renderPaperCard(p); });
                        html += '</div>';
                    }
                    // Already seen
                    if (stepsData.seenPapers.length > 0) {
                        html += `<div class="paper-group-label seen">👁️ Already Seen (${stepsData.seenPapers.length})</div>`;
                        html += '<div class="chat-summary-papers">';
                        stepsData.seenPapers.forEach(p => { html += renderPaperCard(p); });
                        html += '</div>';
                    }
                } else if (papers.length > 0) {
                    // Fallback: no structured grouping available
                    html += '<div class="chat-summary-papers">';
                    papers.forEach(p => { html += renderPaperCard(p); });
                    html += '</div>';
                    html += '</div>';
                }

                // Pipeline module headlines
                if (steps.length > 0) {
                    html += '<div style="font-size:0.8rem;font-weight:600;color:var(--text-muted);margin-bottom:4px;">Pipeline steps:</div>';
                    html += '<div class="chat-summary-pipeline">';
                    const seenModules = [];
                    steps.forEach(s => {
                        const mod = s.module || 'Unknown';
                        if (!seenModules.includes(mod)) {
                            seenModules.push(mod);
                            html += `<span class="pipeline-step">${escapeHtml(mod)}</span>`;
                        }
                    });
                    html += '</div>';
                }
            }

            // Toggle button for raw details
            const detailId = 'raw-detail-' + Date.now();
            html += `<button class="chat-summary-toggle" onclick="document.getElementById('${detailId}').classList.toggle('expanded'); this.textContent = document.getElementById('${detailId}').classList.contains('expanded') ? '▲ Hide full course trace' : '▼ Show full course trace';">▼ Show full course trace</button>`;

            // Raw details section (hidden by default)
            html += `<div id="${detailId}" class="chat-summary-raw">`;
            html += '<div class="chat-summary-raw-label">Response (raw)</div>';
            html += `<pre>${escapeHtml(result.response || '(null)')}</pre>`;
            html += '<div class="chat-summary-raw-label">Steps (raw)</div>';
            html += `<pre>${escapeHtml(JSON.stringify(steps, null, 2))}</pre>`;
            html += '</div>';

            html += '</div>';
            html += `<div class="message-time">${formatTime(new Date().toISOString())}</div>`;
            container.innerHTML = html;
            elements.chatMessages.appendChild(container);
            scrollToBottom(elements.chatMessages);
        }

        /**
         * Render execution steps trace in the chat UI.
         * Course Project requirement: display module, prompt, response for each step.
         */
        function renderStepsTrace(steps) {
            if (!steps || steps.length === 0) return;

            clearEmptyState();
            const container = document.createElement('div');
            container.className = 'message agent steps-trace-container';

            let html = '<div class="message-bubble steps-trace">';
            html += '<div class="steps-trace-header">🔍 Execution Steps Trace</div>';

            steps.forEach((step, idx) => {
                const moduleName = escapeHtml(step.module || `Step ${idx + 1}`);
                const promptStr = typeof step.prompt === 'object'
                    ? escapeHtml(JSON.stringify(step.prompt, null, 2))
                    : escapeHtml(String(step.prompt || ''));
                const responseStr = typeof step.response === 'object'
                    ? escapeHtml(JSON.stringify(step.response, null, 2))
                    : escapeHtml(String(step.response || ''));

                html += `
                    <details class="step-detail">
                        <summary class="step-summary">
                            <span class="step-number">#${idx + 1}</span>
                            <span class="step-module">${moduleName}</span>
                        </summary>
                        <div class="step-content">
                            <div class="step-section">
                                <div class="step-label">Prompt</div>
                                <pre class="step-data">${promptStr}</pre>
                            </div>
                            <div class="step-section">
                                <div class="step-label">Response</div>
                                <pre class="step-data">${responseStr}</pre>
                            </div>
                        </div>
                    </details>`;
            });

            html += '</div>';
            html += `<div class="message-time">${formatTime(new Date().toISOString())}</div>`;
            container.innerHTML = html;
            elements.chatMessages.appendChild(container);
            scrollToBottom(elements.chatMessages);
        }

        function addAgentThinking() {
            clearEmptyState();

            const messageDiv = document.createElement('div');
            messageDiv.className = 'message agent';
            messageDiv.id = 'thinking-message';

            messageDiv.innerHTML = `
        <div class="message-bubble">
          <span class="spinner"></span> Processing your request...
        </div>
      `;

            elements.chatMessages.appendChild(messageDiv);
            scrollToBottom(elements.chatMessages);
        }

        function removeAgentThinking() {
            const thinking = document.getElementById('thinking-message');
            if (thinking) {
                thinking.remove();
            }
        }



        function renderReport(report) {
            if (!report) {
                elements.reportPanel.classList.remove('visible');
                return;
            }

            elements.reportPanel.classList.add('visible');

            const stopReasonEmoji = getStopReasonEmoji(report.stop_reason);
            const artifacts = report.artifacts || [];
            const papers = report.papers || [];
            const decisions = report.decisions || [];
            const actions = report.actions || [];

            let html = '';

            // Stop Reason
            if (report.stop_reason) {
                html += `
          <div class="stop-reason">
            <span class="stop-reason-icon">${stopReasonEmoji}</span>
            <span class="stop-reason-text">Stop Reason: ${escapeHtml(report.stop_reason)}</span>
          </div>
        `;
            }

            // Summary Cards
            html += `
        <div class="report-summary">
          <div class="summary-card">
            <div class="value">${report.papers_processed || 0}</div>
            <div class="label">Papers Processed</div>
          </div>
          <div class="summary-card">
            <div class="value">${report.decisions_made || 0}</div>
            <div class="label">Decisions Made</div>
          </div>
          <div class="summary-card">
            <div class="value">${report.actions_taken || 0}</div>
            <div class="label">Actions Taken</div>
          </div>
          <div class="summary-card">
            <div class="value">${artifacts.length}</div>
            <div class="label">Artifacts Generated</div>
          </div>
        </div>
      `;

            // Papers Section
            if (papers.length > 0) {
                html += `
          <div class="report-section">
            <h3>Papers Processed</h3>
            <table class="papers-table">
              <thead>
                <tr>
                  <th>Title</th>
                  <th>Importance</th>
                  <th>Categories</th>
                </tr>
              </thead>
              <tbody>
        `;

                for (const paper of papers) {
                    const importance = paper.importance || 'low';
                    const title = paper.title || paper.arxiv_id || 'Unknown';
                    const categories = (paper.categories || []).slice(0, 3).join(', ') || '-';

                    html += `
            <tr>
              <td>${escapeHtml(title.substring(0, 60))}${title.length > 60 ? '...' : ''}</td>
              <td><span class="importance-badge importance-${importance}">${importance.replace('_', ' ').toUpperCase()}</span></td>
              <td>${escapeHtml(categories)}</td>
            </tr>
          `;
                }

                html += '</tbody></table></div>';
            }

            // Decisions Section
            if (decisions.length > 0) {
                html += `<div class="report-section"><h3>Decisions</h3><div class="decisions-list">`;

                for (const decision of decisions) {
                    const icon = getDecisionIcon(decision.decision);
                    html += `
            <div class="decision-item">
              <span class="decision-icon">${icon}</span>
              <div class="decision-info">
                <div class="decision-title">${escapeHtml(decision.title || decision.paper_id || 'Paper')}</div>
                <div class="decision-detail">${escapeHtml(decision.decision || 'Processed')} • Importance: ${decision.importance || '-'}</div>
              </div>
            </div>
          `;
                }

                html += '</div></div>';
            }

            // Artifacts Section
            if (artifacts.length > 0) {
                html += `
          <div class="report-section">
            <h3>Generated Artifacts</h3>
            <ul class="artifacts-list">
        `;

                for (const artifact of artifacts) {
                    const path = typeof artifact === 'string' ? artifact : (artifact.path || artifact.file_path || JSON.stringify(artifact));
                    const icon = getArtifactIcon(path);

                    html += `
            <li>
              <span class="artifact-icon">${icon}</span>
              <span class="artifact-path">${escapeHtml(path)}</span>
            </li>
          `;
                }

                html += '</ul></div>';
            } else {
                // Check actions for file artifacts
                const fileActions = actions.filter(a => a.action_type === 'file_write' || a.file_path);
                if (fileActions.length > 0) {
                    html += `
            <div class="report-section">
              <h3>Generated Artifacts</h3>
              <ul class="artifacts-list">
          `;

                    for (const action of fileActions) {
                        const path = action.file_path || action.path || 'Unknown';
                        const icon = getArtifactIcon(path);

                        html += `
              <li>
                <span class="artifact-icon">${icon}</span>
                <span class="artifact-path">${escapeHtml(path)}</span>
              </li>
            `;
                    }

                    html += '</ul></div>';
                }
            }

            // Run Metadata
            html += `
        <div class="report-section">
          <h3>Run Details</h3>
          <div style="background:var(--bg);padding:12px;border-radius:8px;font-family:monospace;font-size:0.8rem;">
            <div><strong>Run ID:</strong> ${escapeHtml(report.run_id || '-')}</div>
            <div><strong>Start:</strong> ${formatTime(report.start_time || '')}</div>
            <div><strong>End:</strong> ${formatTime(report.end_time || '')}</div>
            <div><strong>Tool Calls:</strong> ${report.tool_calls_count || 0}</div>
          </div>
        </div>
      `;

            elements.reportContent.innerHTML = html;
            scrollToBottom(elements.chatMessages);
        }

        function getStopReasonEmoji(reason) {
            if (!reason) return '✅';
            const lower = reason.toLowerCase();
            if (lower.includes('max_runtime')) return '⏱️';
            if (lower.includes('max_papers')) return '📄';
            if (lower.includes('no_new_papers')) return '🔍';
            if (lower.includes('max_rag')) return '🗄️';
            if (lower.includes('importance')) return '📊';
            if (lower.includes('terminate')) return '🛑';
            if (lower.includes('success') || lower.includes('completed')) return '✅';
            return '🏁';
        }

        function getDecisionIcon(decision) {
            if (!decision) return '📄';
            const lower = decision.toLowerCase();
            if (lower.includes('save') || lower.includes('saved')) return '💾';
            if (lower.includes('share')) return '📤';
            if (lower.includes('ignore')) return '🚫';
            if (lower.includes('log')) return '📝';
            return '📄';
        }

        function getArtifactIcon(path) {
            if (!path) return '📄';
            const lower = path.toLowerCase();
            if (lower.includes('email')) return '📧';
            if (lower.includes('calendar') || lower.includes('.ics')) return '📅';
            if (lower.includes('share')) return '📤';
            if (lower.includes('reading')) return '📚';
            if (lower.includes('.md')) return '📝';
            if (lower.includes('.json')) return '📋';
            return '📄';
        }

        // =============================================================================
        // API Calls
        // =============================================================================

        // Generate a UUID for run tracking
        function generateUUID() {
            return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function (c) {
                const r = Math.random() * 16 | 0;
                const v = c === 'x' ? r : (r & 0x3 | 0x8);
                return v.toString(16);
            });
        }

        async function executeAgent(inputMessage, runId) {
            // Use the required /api/execute endpoint (per Course Project requirements)
            console.log('[DEBUG] executeAgent called with runId:', runId);
            try {
                const response = await fetch('/api/execute', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ prompt: inputMessage, run_id: runId }),
                });

                if (!response.ok) {
                    // Try to parse as JSON, but handle plain text error responses
                    let errorMsg = `Server error (${response.status})`;
                    try {
                        const error = await response.json();
                        errorMsg = error.detail || error.message || errorMsg;
                    } catch {
                        const text = await response.text();
                        errorMsg = text || errorMsg;
                    }
                    throw new Error(errorMsg);
                }

                return await response.json();
            } catch (err) {
                console.error('Execute agent error:', err);
                throw err;
            }
        }

        async function startChat(message) {
            // Legacy endpoint - use executeAgent for new code
            try {
                const response = await fetch('/api/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ message }),
                });

                if (!response.ok) {
                    let errorMsg = `Server error (${response.status})`;
                    try {
                        const error = await response.json();
                        errorMsg = error.detail || error.message || errorMsg;
                    } catch {
                        const text = await response.text();
                        errorMsg = text || errorMsg;
                    }
                    throw new Error(errorMsg);
                }

                return await response.json();
            } catch (err) {
                console.error('Start chat error:', err);
                throw err;
            }
        }

        async function pollStatus(runId) {
            try {
                const response = await fetch(`/api/status?run_id=${encodeURIComponent(runId)}`);

                if (!response.ok) {
                    if (response.status === 404) {
                        throw new Error('Run not found');
                    }
                    let errorMsg = `Server error (${response.status})`;
                    try {
                        const error = await response.json();
                        errorMsg = error.detail || error.message || errorMsg;
                    } catch {
                        const text = await response.text();
                        errorMsg = text || errorMsg;
                    }
                    throw new Error(errorMsg);
                }

                return await response.json();
            } catch (err) {
                console.error('Poll status error:', err);
                throw err;
            }
        }

        // =============================================================================
        // Event Handlers
        // =============================================================================
        async function handleSend() {
            const message = elements.messageInput.value.trim();
            if (!message || state.isRunning) return;

            // Generate run_id upfront so we can cancel it
            const runId = generateUUID();
            state.currentRunId = runId;
            console.log('[DEBUG] handleSend - generated runId:', runId);

            // Reset UI
            state.isRunning = true;
            elements.messageInput.value = '';
            resetTextareaHeight(elements.messageInput);
            setInputEnabled(false);
            setStatus('running');
            elements.reportPanel.classList.remove('visible');
            // Show user message
            addMessage(message, true);
            addAgentThinking();

            try {
                // Use the /api/execute endpoint (per Course Project requirements)
                const result = await executeAgent(message, runId);

                // Check if cancelled
                if (result.response && result.response.includes('cancelled')) {
                    console.log('[DEBUG] Run was cancelled');
                    return; // UI already reset by cancelRun
                }

                state.isRunning = false;
                state.currentRunId = null;
                removeAgentThinking();
                setInputEnabled(true);

                // Handle new response format: { status, error, response, steps }
                if (result.status === 'ok') {
                    setStatus('done');
                } else {
                    setStatus('error');
                }

                // Dual rendering: summary + expandable raw course trace
                renderExecuteResult(result);

                // Also render the visual steps trace for quick inspection
                if (result.status === 'ok' && result.steps && result.steps.length > 0) {
                    renderStepsTrace(result.steps);
                }

            } catch (err) {
                state.isRunning = false;
                removeAgentThinking();
                addMessage(`Error: ${err.message}`, false);
                setInputEnabled(true);
                setStatus('error');
            }
        }

        function startPolling(runId) {
            if (state.pollInterval) {
                clearInterval(state.pollInterval);
            }

            // Poll immediately
            pollAndUpdate(runId);

            // Then poll every 1 second
            state.pollInterval = setInterval(() => {
                pollAndUpdate(runId);
            }, 1000);
        }

        async function pollAndUpdate(runId) {
            try {
                const status = await pollStatus(runId);

                // Check if done
                if (status.status === 'done' || status.status === 'error') {
                    stopPolling();
                    state.isRunning = false;
                    removeAgentThinking();
                    setInputEnabled(true);
                    setStatus(status.status);

                    if (status.status === 'done') {
                        const papersCount = status.report?.papers_processed || 0;
                        const actionsCount = status.report?.actions_taken || 0;
                        addMessage(
                            `✅ Run completed! Processed ${papersCount} papers, took ${actionsCount} actions.`,
                            false,
                            status.report?.end_time
                        );
                        renderReport(status.report);
                    } else if (status.status === 'error') {
                        addMessage(`❌ Error: ${status.error || 'Unknown error'}`, false);
                    }
                }

            } catch (err) {
                console.error('Polling error:', err);
                // Don't stop polling on transient errors
                if (err.message === 'Run not found') {
                    stopPolling();
                    state.isRunning = false;
                    removeAgentThinking();
                    addMessage(`Error: Run not found`, false);
                    setInputEnabled(true);
                    setStatus('error');
                }
            }
        }

        function stopPolling() {
            if (state.pollInterval) {
                clearInterval(state.pollInterval);
                state.pollInterval = null;
            }
        }

        // =============================================================================
        // Event Listeners
        // =============================================================================
        // Use unified click handler to properly handle send/stop modes
        elements.sendBtn.addEventListener('click', handleButtonClick);

        elements.messageInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                handleButtonClick();
            }
        });

        // Auto-grow textarea as user types (grows upward via flex-end alignment)
        function autoResizeTextarea(el) {
            el.style.height = 'auto';
            el.style.height = Math.min(el.scrollHeight, 200) + 'px';
        }
        function resetTextareaHeight(el) {
            el.style.height = '';
        }
        elements.messageInput.addEventListener('input', () => {
            autoResizeTextarea(elements.messageInput);
        });

        // Focus input on load
        elements.messageInput.focus();

        // Check health on load
        fetch('/api/health')
            .then(r => r.json())
            .then(data => {
                console.log('ResearchPulse backend:', data);
            })
            .catch(err => {
                console.warn('Backend health check failed:', err);
                addMessage('⚠️ Backend may not be running. Please start the server.', false);
            });

        // =============================================================================
        // Dashboard Tab Switching
        // =============================================================================
        document.querySelectorAll('.nav-tab').forEach(tab => {
            tab.addEventListener('click', () => {
                // Update active tab
                document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
                tab.classList.add('active');

                // Update active panel
                const tabId = tab.dataset.tab;
                document.querySelectorAll('.tab-panel').forEach(p => p.classList.remove('active'));
                const panel = document.getElementById('tab-' + tabId);
                if (panel) panel.classList.add('active');

                // Load data for the tab
                if (tabId === 'papers') refreshPapers();
                else if (tabId === 'emails') refreshEmails();
                else if (tabId === 'calendar') refreshCalendar();
                else if (tabId === 'shares') refreshShares();
                else if (tabId === 'colleagues') refreshColleagues();
                else if (tabId === 'runs') refreshRuns();
                else if (tabId === 'settings') { checkHealth(); loadProfile(); loadInboxSettings(); loadExecutionSettings(); loadCurrentJoinCode(); }
                else if (tabId === 'chat') { populatePromptBuilder(); }
            });
        });

        // Load profile and saved prompts on page load
        loadProfile();
        loadSavedPrompts();
        loadInboxSettings();
        loadExecutionSettings();
        loadCurrentJoinCode();

        // =============================================================================
        // Dashboard Data Functions
        // =============================================================================

        // ========== Papers Tab State Management ==========
        let selectedPaperIds = new Set();
        let allPaperIds = [];
        let allPapersData = [];
        let currentSortField = 'added_at'; // 'added_at', 'importance', 'published_at', 'title'
        let currentSortDir = 'desc'; // 'asc' or 'desc'
        let paperSearchTimeout = null;

        // Debounced search function
        function debouncedPaperSearch() {
            clearTimeout(paperSearchTimeout);
            paperSearchTimeout = setTimeout(() => {
                refreshPapers();
            }, 250);
        }

        // Sort order management
        function setSortOrder(field, btn) {
            currentSortField = field;
            document.querySelectorAll('.sort-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            refreshPapers(); // Re-fetch with new sort params
        }

        // Toggle sort direction (asc/desc)
        function toggleSortDirection() {
            currentSortDir = currentSortDir === 'desc' ? 'asc' : 'desc';
            const btn = document.getElementById('sort-dir-btn');
            btn.textContent = currentSortDir === 'desc' ? '↓' : '↑';
            btn.title = currentSortDir === 'desc' ? 'Descending (click to toggle)' : 'Ascending (click to toggle)';
            refreshPapers(); // Re-fetch with new sort direction
        }

        // Sort papers is now handled by backend, but keep for fallback
        function sortPapers(papers) {
            // Backend handles sorting now, just return as-is
            return papers;
        }

        async function refreshPapers() {
            const list = document.getElementById('papers-list');
            const header = document.getElementById('paper-list-header');

            // Show loading skeleton
            list.innerHTML = Array(5).fill(0).map(() => `
                <div class="skeleton-row">
                    <div class="skeleton-box skeleton-checkbox"></div>
                    <div class="skeleton-content">
                        <div class="skeleton-box skeleton-title"></div>
                        <div class="skeleton-box skeleton-meta"></div>
                        <div class="skeleton-box skeleton-badges"></div>
                    </div>
                </div>
            `).join('');

            try {
                const q = document.getElementById('papers-search')?.value || '';
                const importance = document.getElementById('papers-filter-importance')?.value || '';
                const params = new URLSearchParams({
                    limit: 100,
                    sort_by: currentSortField,
                    sort_dir: currentSortDir
                });
                if (q) params.append('q', q);
                if (importance) params.append('importance', importance);

                const response = await fetch('/api/papers?' + params.toString());
                if (!response.ok) throw new Error('Failed to fetch papers');
                const data = await response.json();

                // Store for later reference
                allPapersData = data.papers || [];
                allPaperIds = allPapersData.map(p => p.paper_id || p.paper?.id || p.id);

                // Filter out deleted papers
                allPapersData = allPapersData.filter(p => !p.is_deleted);

                // Clean up selection (remove IDs that are no longer visible)
                const visibleIds = new Set(allPaperIds);
                selectedPaperIds.forEach(id => {
                    if (!visibleIds.has(id)) selectedPaperIds.delete(id);
                });

                if (allPapersData.length === 0) {
                    list.innerHTML = `
                        <div class="papers-empty-state">
                            <div class="emoji">📄</div>
                            <p>${q || importance ? 'No papers match your filters.' : 'No papers yet. Run the agent to discover papers!'}</p>
                            ${q || importance ? '<button class="clear-filters-btn" onclick="clearPaperFilters()">Clear Filters</button>' : ''}
                        </div>
                    `;
                    header.style.display = 'none';
                    updateBulkActionBar();
                    return;
                }

                header.style.display = 'flex';
                renderPapersList();
                updateBulkActionBar();
                updateSelectAllCheckbox();
            } catch (err) {
                console.error('Error fetching papers:', err);
                list.innerHTML = '<div class="papers-empty-state"><div class="emoji">❌</div><p>Failed to load papers.</p></div>';
            }
        }

        function renderPapersList() {
            const list = document.getElementById('papers-list');
            const sortedPapers = sortPapers(allPapersData);

            list.innerHTML = sortedPapers.map(p => {
                const paper = p.paper || {};
                const title = paper.title || p.title || 'Untitled';
                const externalId = paper.external_id || '';
                const arxivUrl = externalId ? `https://arxiv.org/abs/${externalId}` : (paper.url || p.url || '#');
                const pdfUrl = externalId ? `https://arxiv.org/pdf/${externalId}.pdf` : '';
                const categories = paper.categories_display || paper.categories || p.categories || [];
                const publishedAt = paper.published_at || p.published_at;
                const firstSeenAt = p.first_seen_at;
                const paperId = p.paper_id || paper.id || p.id;
                const authors = paper.authors || [];
                const importance = (p.importance || 'low').toLowerCase();
                const isSelected = selectedPaperIds.has(paperId);
                const isRead = p.is_read || false;
                const isStarred = p.is_starred || false;
                const relevanceState = p.relevance_state || 'unknown';
                const isNotRelevant = relevanceState === 'not_relevant';
                const agentEmail = p.agent_email_decision;
                const agentCalendar = p.agent_calendar_decision;

                // Format authors (first 2-3 + et al.)
                let authorsText = '';
                if (authors.length > 0) {
                    const displayAuthors = authors.slice(0, 3);
                    authorsText = displayAuthors.join(', ');
                    if (authors.length > 3) authorsText += ' et al.';
                }

                return `
                <div class="paper-row ${isSelected ? 'selected' : ''} ${isNotRelevant ? 'not-relevant' : ''}" id="paper-row-${paperId}">
                    <input type="checkbox" 
                           class="paper-checkbox" 
                           ${isSelected ? 'checked' : ''} 
                           onclick="togglePaperSelection('${paperId}')"
                           title="Select paper" />
                    <div class="paper-content">
                        <div class="paper-title-row">
                            <a href="${escapeHtml(arxivUrl)}" 
                               target="_blank" 
                               class="paper-title-link ${isRead ? '' : 'unread'}"
                               onclick="markPaperRead('${paperId}', event)"
                               title="${escapeHtml(title)}">
                                ${isStarred ? '⭐ ' : ''}${escapeHtml(title)}
                            </a>
                            ${isNotRelevant ? '<span class="not-relevant-badge">Not Relevant</span>' : ''}
                            ${pdfUrl ? `<a href="${pdfUrl}" target="_blank" class="paper-pdf-link" onclick="markPaperRead('${paperId}', event)" title="Download PDF">📄 PDF</a>` : ''}
                            <span class="importance-badge importance-${importance}">${importance.replace('_', ' ').toUpperCase()}</span>
                        </div>
                        ${authorsText ? `<div class="paper-authors">👤 ${escapeHtml(authorsText)}</div>` : ''}
                        <div class="paper-meta-row">
                            ${publishedAt ? `<span class="paper-meta-item">📅 Published: ${new Date(publishedAt).toLocaleDateString()}</span>` : '<span class="paper-meta-item">📅 Published: N/A</span>'}
                            <span class="paper-meta-item">📥 Added: ${firstSeenAt ? formatRelativeTime(new Date(firstSeenAt)) : 'N/A'}</span>
                            ${categories.length > 0 ? `<span class="paper-meta-item">🏷️ ${categories.slice(0, 3).join(', ')}</span>` : ''}
                        </div>
                        <div class="paper-agent-decisions">
                            <span class="agent-decision-badge ${agentEmail === true ? 'email-yes' : 'email-no'}">
                                📧 Email: ${agentEmail === true ? 'Yes' : agentEmail === false ? 'No' : 'Pending'}
                            </span>
                            <span class="agent-decision-badge ${agentCalendar === true ? 'calendar-yes' : 'calendar-no'}">
                                📅 Calendar: ${agentCalendar === true ? 'Yes' : agentCalendar === false ? 'No' : 'Pending'}
                            </span>
                        </div>
                    </div>
                    <button class="paper-expand-btn" onclick="openPaperDrawer('${paperId}')" title="View details">
                        Details →
                    </button>
                </div>
            `}).join('');
        }

        // Helper: Format relative time (e.g., "2 hours ago")
        function formatRelativeTime(date) {
            const now = new Date();
            const diffMs = now - date;
            const diffMins = Math.floor(diffMs / 60000);
            const diffHours = Math.floor(diffMs / 3600000);
            const diffDays = Math.floor(diffMs / 86400000);

            if (diffMins < 1) return 'Just now';
            if (diffMins < 60) return `${diffMins}m ago`;
            if (diffHours < 24) return `${diffHours}h ago`;
            if (diffDays < 7) return `${diffDays}d ago`;
            return date.toLocaleDateString();
        }

        // ========== Selection Management ==========
        function togglePaperSelection(paperId) {
            if (selectedPaperIds.has(paperId)) {
                selectedPaperIds.delete(paperId);
            } else {
                selectedPaperIds.add(paperId);
            }
            updatePaperRowHighlight(paperId);
            updateBulkActionBar();
            updateSelectAllCheckbox();
        }

        function toggleSelectAll() {
            const checkbox = document.getElementById('select-all-checkbox');
            if (selectedPaperIds.size === allPaperIds.length && allPaperIds.length > 0) {
                // Deselect all
                selectedPaperIds.clear();
                checkbox.checked = false;
            } else {
                // Select all visible
                allPaperIds.forEach(id => selectedPaperIds.add(id));
                checkbox.checked = true;
            }
            renderPapersList();
            updateBulkActionBar();
        }

        function clearSelection() {
            selectedPaperIds.clear();
            document.getElementById('select-all-checkbox').checked = false;
            renderPapersList();
            updateBulkActionBar();
        }

        function updatePaperRowHighlight(paperId) {
            const row = document.getElementById(`paper-row-${paperId}`);
            if (row) {
                const checkbox = row.querySelector('.paper-checkbox');
                if (selectedPaperIds.has(paperId)) {
                    row.classList.add('selected');
                    if (checkbox) checkbox.checked = true;
                } else {
                    row.classList.remove('selected');
                    if (checkbox) checkbox.checked = false;
                }
            }
        }

        function updateBulkActionBar() {
            const bar = document.getElementById('bulk-action-bar');
            const count = document.getElementById('bulk-selection-count');
            if (selectedPaperIds.size > 0) {
                bar.classList.add('visible');
                count.textContent = `${selectedPaperIds.size} selected`;
            } else {
                bar.classList.remove('visible');
            }
        }

        function updateSelectAllCheckbox() {
            const checkbox = document.getElementById('select-all-checkbox');
            if (allPaperIds.length > 0 && selectedPaperIds.size === allPaperIds.length) {
                checkbox.checked = true;
                checkbox.indeterminate = false;
            } else if (selectedPaperIds.size > 0) {
                checkbox.checked = false;
                checkbox.indeterminate = true;
            } else {
                checkbox.checked = false;
                checkbox.indeterminate = false;
            }
        }

        function clearPaperFilters() {
            document.getElementById('papers-search').value = '';
            document.getElementById('papers-filter-importance').value = '';
            refreshPapers();
        }

        // ========== Paper Details Drawer ==========
        function openPaperDrawer(paperId) {
            const paper = allPapersData.find(p => (p.paper_id || p.paper?.id || p.id) === paperId);
            if (!paper) return;

            const drawerContent = document.getElementById('drawer-content');
            const paperData = paper.paper || {};
            const title = paperData.title || paper.title || 'Untitled';
            const externalId = paperData.external_id || '';
            const arxivUrl = externalId ? `https://arxiv.org/abs/${externalId}` : (paperData.url || paper.url || '#');
            const pdfUrl = externalId ? `https://arxiv.org/pdf/${externalId}.pdf` : '';
            const abstract = paperData.abstract || '';
            const authors = paperData.authors || [];
            const categories = paperData.categories_display || paperData.categories || paper.categories || [];
            const publishedAt = paperData.published_at || paper.published_at;
            const firstSeenAt = paper.first_seen_at;
            const importance = (paper.importance || 'low').toUpperCase();
            const decision = paper.decision || 'pending';
            const agentNotes = paper.agent_decision_notes || '';
            const tags = paper.tags || [];

            drawerContent.innerHTML = `
                <div class="drawer-section">
                    <h4>Title</h4>
                    <p style="font-weight: 600; font-size: 1.1rem;">${escapeHtml(title)}</p>
                </div>

                <div class="drawer-section">
                    <h4>Links</h4>
                    <div class="drawer-links">
                        <a href="${escapeHtml(arxivUrl)}" target="_blank" class="drawer-link">🔗 View on arXiv</a>
                        ${pdfUrl ? `<a href="${pdfUrl}" target="_blank" class="drawer-link secondary">📄 Download PDF</a>` : ''}
                        ${pdfUrl ? `<button class="drawer-link summarize" onclick="summarizePaper('${paperId}', this)" id="summarize-btn-${paperId}">📝 Summarize Paper</button>` : ''}
                    </div>
                </div>

                <div class="drawer-section" id="summary-section-${paperId}" style="${paper.summary ? '' : 'display:none;'}">
                    <h4>AI Summary
                        <span style="font-weight: 400; font-size: 0.8rem; color: var(--text-muted); margin-left: 8px;">
                            ${paper.summary_generated_at ? '(Generated ' + new Date(paper.summary_generated_at).toLocaleDateString() + ')' : ''}
                        </span>
                    </h4>
                    <div class="summary-container" id="summary-content-${paperId}">
                        ${paper.summary ? renderMarkdownBasic(paper.summary) : ''}
                    </div>
                    <div class="summary-actions">
                        <button class="summary-action-btn" onclick="downloadSummary('${paperId}')">💾 Download Summary</button>
                        <button class="summary-action-btn" onclick="summarizePaper('${paperId}', document.getElementById('summarize-btn-${paperId}'), true)">🔄 Regenerate</button>
                    </div>
                </div>

                ${abstract ? `
                <div class="drawer-section">
                    <h4>Abstract</h4>
                    <p>${escapeHtml(abstract)}</p>
                </div>
                ` : ''}

                ${authors.length > 0 ? `
                <div class="drawer-section">
                    <h4>Authors</h4>
                    <p>${escapeHtml(authors.join(', '))}</p>
                </div>
                ` : ''}

                <div class="drawer-section">
                    <h4>Importance</h4>
                    <span class="importance-badge importance-${importance.toLowerCase()}">${importance.replace('_', ' ')}</span>
                </div>

                <div class="drawer-section">
                    <h4>Dates</h4>
                    <p>
                        📥 Added: ${firstSeenAt ? new Date(firstSeenAt).toLocaleString() : 'N/A'}<br>
                        ${publishedAt ? `📅 Published: ${new Date(publishedAt).toLocaleDateString()}` : ''}
                    </p>
                </div>

                <div class="drawer-section">
                    <h4>Agent Decision</h4>
                    <p>
                        Decision: <strong>${escapeHtml(decision)}</strong><br>
                        📧 Email: ${paper.agent_email_decision === true ? 'Recommended' : paper.agent_email_decision === false ? 'Not recommended' : 'Pending'}<br>
                        📅 Calendar: ${paper.agent_calendar_decision === true ? 'Recommended' : paper.agent_calendar_decision === false ? 'Not recommended' : 'Pending'}
                    </p>
                    ${agentNotes ? `<p style="margin-top: 8px; font-style: italic;">"${escapeHtml(agentNotes)}"</p>` : ''}
                </div>

                ${categories.length > 0 || tags.length > 0 ? `
                <div class="drawer-section">
                    <h4>Categories & Tags</h4>
                    <div class="drawer-tags">
                        ${categories.map(c => `<span class="drawer-tag">🏷️ ${escapeHtml(c)}</span>`).join('')}
                        ${tags.map(t => `<span class="drawer-tag">${escapeHtml(t)}</span>`).join('')}
                    </div>
                </div>
                ` : ''}
            `;

            // Restore saved size from localStorage
            const modal = document.getElementById('paper-drawer');
            const savedW = localStorage.getItem('paperModalWidth');
            const savedH = localStorage.getItem('paperModalHeight');
            if (savedW) modal.style.width = savedW;
            if (savedH) modal.style.height = savedH;

            document.getElementById('paper-drawer-overlay').classList.add('visible');
            modal.classList.add('visible');
        }

        function closePaperDrawer() {
            const modal = document.getElementById('paper-drawer');
            // Save current size before closing
            if (modal.offsetWidth > 0) localStorage.setItem('paperModalWidth', modal.style.width || modal.offsetWidth + 'px');
            if (modal.offsetHeight > 0) localStorage.setItem('paperModalHeight', modal.style.height || modal.offsetHeight + 'px');
            document.getElementById('paper-drawer-overlay').classList.remove('visible');
            modal.classList.remove('visible');
        }

        // Track resize via ResizeObserver so we persist even CSS resize: both changes
        (function () {
            const modal = document.getElementById('paper-drawer');
            if (modal && typeof ResizeObserver !== 'undefined') {
                let resizeTimer;
                new ResizeObserver(() => {
                    if (!modal.classList.contains('visible')) return;
                    clearTimeout(resizeTimer);
                    resizeTimer = setTimeout(() => {
                        localStorage.setItem('paperModalWidth', modal.offsetWidth + 'px');
                        localStorage.setItem('paperModalHeight', modal.offsetHeight + 'px');
                    }, 300);
                }).observe(modal);
            }
        })();

        // ========== Paper Summary Functions ==========
        function renderMarkdownBasic(md) {
            // Simple markdown → HTML: headers, bold, italic, bullets, paragraphs
            if (!md) return '';
            let html = escapeHtml(md);
            // Headers ## → <h2>
            html = html.replace(/^## (.+)$/gm, '<h2>$1</h2>');
            // Bold **text**
            html = html.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');
            // Italic *text*
            html = html.replace(/\*(.+?)\*/g, '<em>$1</em>');
            // Bullet lists
            html = html.replace(/^- (.+)$/gm, '<li>$1</li>');
            html = html.replace(/(<li>.*<\/li>\n?)+/g, '<ul>$&</ul>');
            // Line breaks → paragraphs
            html = html.replace(/\n{2,}/g, '</p><p>');
            html = '<p>' + html + '</p>';
            // Clean up empty paragraphs around elements
            html = html.replace(/<p>\s*<(h2|ul|li)/g, '<$1');
            html = html.replace(/<\/(h2|ul|li)>\s*<\/p>/g, '</$1>');
            html = html.replace(/<p>\s*<\/p>/g, '');
            return html;
        }

        async function summarizePaper(paperId, btnElement, force = false) {
            if (!btnElement) return;

            const originalText = btnElement.textContent;
            btnElement.textContent = '⏳ Summarizing...';
            btnElement.classList.add('loading');

            try {
                const url = `/api/papers/${paperId}/summarize${force ? '?force=true' : ''}`;
                const response = await fetch(url, { method: 'POST' });
                const result = await response.json();

                if (!response.ok) {
                    throw new Error(result.detail || 'Summarisation failed');
                }

                if (result.success && result.summary) {
                    // Update local data cache
                    const paper = allPapersData.find(p => (p.paper_id || p.paper?.id || p.id) === paperId);
                    if (paper) {
                        paper.summary = result.summary;
                        paper.summary_generated_at = result.generated_at;
                    }

                    // Show the summary section
                    const section = document.getElementById(`summary-section-${paperId}`);
                    const content = document.getElementById(`summary-content-${paperId}`);
                    if (section && content) {
                        content.innerHTML = renderMarkdownBasic(result.summary);
                        section.style.display = '';
                        // Update header date
                        const h4 = section.querySelector('h4');
                        if (h4 && result.generated_at) {
                            const dateStr = new Date(result.generated_at).toLocaleDateString();
                            h4.innerHTML = `AI Summary <span style="font-weight: 400; font-size: 0.8rem; color: var(--text-muted); margin-left: 8px;">(Generated ${dateStr})</span>`;
                        }
                    }

                    btnElement.textContent = '✅ Summary Ready';
                    btnElement.classList.remove('loading');
                    showToast(result.cached ? 'Loaded cached summary' : 'Summary generated successfully');
                } else {
                    throw new Error('No summary returned');
                }
            } catch (err) {
                console.error('Summarisation error:', err);
                btnElement.textContent = originalText;
                btnElement.classList.remove('loading');
                showToast('Failed to summarize: ' + err.message, 'error');
            }
        }

        function downloadSummary(paperId) {
            const paper = allPapersData.find(p => (p.paper_id || p.paper?.id || p.id) === paperId);
            if (!paper || !paper.summary) {
                showToast('No summary available to download', 'error');
                return;
            }

            const paperData = paper.paper || {};
            const title = paperData.title || paper.title || 'Untitled';
            const externalId = paperData.external_id || '';
            const header = `# Summary: ${title}\n\narXiv: ${externalId}\nGenerated: ${paper.summary_generated_at ? new Date(paper.summary_generated_at).toLocaleString() : 'N/A'}\n\n---\n\n`;
            const fullContent = header + paper.summary;

            const blob = new Blob([fullContent], { type: 'text/markdown;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `summary_${externalId || paperId}.md`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            showToast('Summary downloaded');
        }

        // ========== Bulk Actions ==========
        async function bulkMarkRead() {
            if (selectedPaperIds.size === 0) return;
            try {
                const response = await fetch('/api/bulk/papers/mark-read', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(Array.from(selectedPaperIds))
                });
                if (!response.ok) throw new Error('Failed to mark as read');
                const result = await response.json();
                showToast(`Marked ${result.updated_count} papers as read`);
                clearSelection();
                refreshPapers();
            } catch (err) {
                console.error('Error:', err);
                alert('Failed to mark papers as read: ' + err.message);
            }
        }

        async function bulkMarkUnread() {
            if (selectedPaperIds.size === 0) return;
            try {
                const response = await fetch('/api/bulk/papers/mark-unread', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(Array.from(selectedPaperIds))
                });
                if (!response.ok) throw new Error('Failed to mark as unread');
                const result = await response.json();
                showToast(`Marked ${result.updated_count} papers as unread`);
                clearSelection();
                refreshPapers();
            } catch (err) {
                console.error('Error:', err);
                alert('Failed to mark papers as unread: ' + err.message);
            }
        }

        async function bulkStar() {
            if (selectedPaperIds.size === 0) return;
            try {
                const response = await fetch('/api/bulk/papers/star', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(Array.from(selectedPaperIds))
                });
                if (!response.ok) throw new Error('Failed to star papers');
                const result = await response.json();
                showToast(`Starred ${result.updated_count} papers`);
                clearSelection();
                refreshPapers();
            } catch (err) {
                console.error('Error:', err);
                alert('Failed to star papers: ' + err.message);
            }
        }

        async function bulkMarkNotRelevant() {
            if (selectedPaperIds.size === 0) return;
            try {
                const response = await fetch('/api/bulk/papers/set-relevance', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        paper_view_ids: Array.from(selectedPaperIds),
                        relevance_state: 'not_relevant'
                    })
                });
                if (!response.ok) throw new Error('Failed to mark as not relevant');
                const result = await response.json();
                showToast(`Marked ${result.updated_count} papers as not relevant`);
                clearSelection();
                refreshPapers();
            } catch (err) {
                console.error('Error:', err);
                alert('Failed to mark papers as not relevant: ' + err.message);
            }
        }

        // ========== Single Paper Toggle Actions ==========
        async function markPaperRead(paperId, event) {
            console.log('markPaperRead called for:', paperId);

            // Find and update the paper row immediately
            const paperRow = document.getElementById('paper-row-' + paperId);
            console.log('Found paper row:', paperRow);
            if (paperRow) {
                const titleLink = paperRow.querySelector('.paper-title-link');
                console.log('Found title link:', titleLink, 'has unread:', titleLink?.classList?.contains('unread'));
                if (titleLink) {
                    titleLink.classList.remove('unread');
                    titleLink.style.fontWeight = '400';  // Force normal weight
                    console.log('Removed unread class and set fontWeight to 400');
                }
            }

            try {
                const response = await fetch(`/api/papers/${paperId}/mark-read`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                console.log('API response:', response.status);
                // Update local data
                const paper = allPapersData.find(p => (p.paper_id || p.paper?.id || p.id) === paperId);
                if (paper) {
                    paper.is_read = true;
                }
            } catch (err) {
                console.error('Error marking paper as read:', err);
            }
        }

        async function toggleStar(paperId) {
            try {
                const response = await fetch(`/api/papers/${paperId}/toggle-star`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                if (!response.ok) throw new Error('Failed to toggle star');
                const result = await response.json();
                // Update local data
                const paper = allPapersData.find(p => (p.paper_id || p.paper?.id || p.id) === paperId);
                if (paper) {
                    paper.is_starred = result.is_starred;
                }
                showToast(result.is_starred ? 'Paper starred' : 'Paper unstarred');
                renderPapersList();
            } catch (err) {
                console.error('Error toggling star:', err);
                alert('Failed to toggle star: ' + err.message);
            }
        }

        async function toggleRelevance(paperId) {
            try {
                const response = await fetch(`/api/papers/${paperId}/toggle-relevance`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                if (!response.ok) throw new Error('Failed to toggle relevance');
                const result = await response.json();
                // Update local data
                const paper = allPapersData.find(p => (p.paper_id || p.paper?.id || p.id) === paperId);
                if (paper) {
                    paper.relevance_state = result.relevance_state;
                }
                const isNotRelevant = result.relevance_state === 'not_relevant';
                showToast(isNotRelevant ? 'Marked as not relevant' : 'Marked as relevant');
                renderPapersList();
            } catch (err) {
                console.error('Error toggling relevance:', err);
                alert('Failed to toggle relevance: ' + err.message);
            }
        }

        async function togglePaperRead(paperId) {
            try {
                const response = await fetch(`/api/papers/${paperId}/toggle-read`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                if (!response.ok) throw new Error('Failed to toggle read status');
                const result = await response.json();
                // Update local data
                const paper = allPapersData.find(p => (p.paper_id || p.paper?.id || p.id) === paperId);
                if (paper) {
                    paper.is_read = result.is_read;
                }
                showToast(result.is_read ? 'Marked as read' : 'Marked as unread');
                renderPapersList();
            } catch (err) {
                console.error('Error toggling read status:', err);
                alert('Failed to toggle read status: ' + err.message);
            }
        }

        // ========== Bulk Toggle Actions (Updated) ==========
        async function bulkToggleRead() {
            if (selectedPaperIds.size === 0) return;
            try {
                const response = await fetch('/api/bulk/papers/toggle-read', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(Array.from(selectedPaperIds))
                });
                if (!response.ok) throw new Error('Failed to toggle read status');
                const result = await response.json();
                showToast(result.message || `Toggled read status for ${result.count || result.updated_count || 0} papers`);
                clearSelection();
                refreshPapers();
            } catch (err) {
                console.error('Error:', err);
                alert('Failed to toggle read status: ' + err.message);
            }
        }

        async function bulkToggleStar() {
            if (selectedPaperIds.size === 0) return;
            try {
                const response = await fetch('/api/bulk/papers/toggle-star', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(Array.from(selectedPaperIds))
                });
                if (!response.ok) throw new Error('Failed to toggle star');
                const result = await response.json();
                showToast(result.message || `Toggled star for ${result.updated_count} papers`);
                clearSelection();
                refreshPapers();
            } catch (err) {
                console.error('Error:', err);
                alert('Failed to toggle star: ' + err.message);
            }
        }

        async function bulkDownloadPDF() {
            if (selectedPaperIds.size === 0) return;
            try {
                const response = await fetch('/api/bulk/papers/download-pdf', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(Array.from(selectedPaperIds))
                });
                if (!response.ok) throw new Error('Failed to get PDF URLs');
                const result = await response.json();

                if (result.pdf_urls && result.pdf_urls.length > 0) {
                    // Open each PDF in a new tab (or download)
                    result.pdf_urls.forEach((item, index) => {
                        setTimeout(() => {
                            window.open(item.pdf_url, '_blank');
                        }, index * 300); // Stagger to avoid popup blocking
                    });
                    showToast(`Opening ${result.pdf_urls.length} PDFs`);
                } else {
                    alert('No PDF URLs found for selected papers');
                }
            } catch (err) {
                console.error('Error:', err);
                alert('Failed to download PDFs: ' + err.message);
            }
        }

        async function bulkCreateReminder() {
            if (selectedPaperIds.size === 0) return;
            try {
                const response = await fetch('/api/bulk/papers/create-reminder', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(Array.from(selectedPaperIds))
                });

                const result = await response.json();

                if (!response.ok) {
                    throw new Error(result.detail || 'Failed to create reminder');
                }

                if (result.success) {
                    // Show success toast with email status info
                    showToast(`📅 ${result.message}`);

                    // Show additional warning if email was not sent
                    if (!result.email_sent) {
                        setTimeout(() => {
                            showToast('⚠️ Email reminder not sent - configure SMTP in Settings to receive calendar invites by email', 'warning');
                        }, 1500);
                    }

                    clearSelection();
                    refreshPapers();
                    // Refresh calendar tab to show the new event
                    refreshCalendar();
                } else {
                    throw new Error(result.message || 'Failed to create reminder');
                }
            } catch (err) {
                console.error('Error:', err);
                alert('Failed to create reminder: ' + err.message);
            }
        }

        async function bulkEmailSummary() {
            if (selectedPaperIds.size === 0) return;
            try {
                const response = await fetch('/api/bulk/papers/email-summary', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(Array.from(selectedPaperIds))
                });

                const result = await response.json();

                if (!response.ok) {
                    throw new Error(result.detail || 'Failed to send email summary');
                }

                if (result.success) {
                    showToast(`📧 ${result.message}`);
                    clearSelection();
                    // Refresh emails tab to show the new email
                    refreshEmails();
                } else {
                    throw new Error(result.message || 'Failed to send email summary');
                }
            } catch (err) {
                console.error('Error:', err);
                alert('Failed to send email summary: ' + err.message);
            }
        }

        async function bulkDelete() {
            if (selectedPaperIds.size === 0) return;
            if (!confirm(`Are you sure you want to delete ${selectedPaperIds.size} paper(s)? This action cannot be undone.`)) return;

            try {
                const response = await fetch('/api/bulk/papers/delete', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(Array.from(selectedPaperIds))
                });
                if (!response.ok) throw new Error('Failed to delete papers');
                const result = await response.json();
                showToast(`Deleted ${result.total} papers`);
                clearSelection();
                refreshPapers();
            } catch (err) {
                console.error('Error:', err);
                alert('Failed to delete papers: ' + err.message);
            }
        }

        // Single paper actions (kept for backward compatibility)
        async function deletePaper(paperId) {
            if (!confirm('Are you sure you want to delete this paper? This will remove it from your seen list and delete related vectors.')) return;
            try {
                const response = await fetch('/api/papers/' + paperId, { method: 'DELETE' });
                if (!response.ok) throw new Error('Failed to delete paper');
                refreshPapers();
            } catch (err) {
                console.error('Error deleting paper:', err);
                alert('Failed to delete paper: ' + err.message);
            }
        }

        async function markUnseen(paperId) {
            try {
                const response = await fetch('/api/papers/' + paperId + '/mark-unseen', { method: 'POST' });
                if (!response.ok) throw new Error('Failed to mark unseen');
                refreshPapers();
            } catch (err) {
                console.error('Error marking unseen:', err);
                alert('Failed to mark paper as unseen: ' + err.message);
            }
        }

        async function exportPapersCSV() {
            try {
                // Check if selection exists, offer choice
                if (selectedPaperIds.size > 0) {
                    const exportChoice = confirm(`Export ${selectedPaperIds.size} selected papers? Click Cancel to export all filtered papers.`);
                    if (exportChoice) {
                        // Export selected (would need backend support for selected IDs)
                        // For now, copy to clipboard as CSV
                        const selectedPapers = allPapersData.filter(p => selectedPaperIds.has(p.paper_id || p.paper?.id || p.id));
                        const csvContent = generatePapersCSV(selectedPapers);
                        await navigator.clipboard.writeText(csvContent);
                        showToast('Selected papers CSV copied to clipboard');
                        return;
                    }
                }

                const response = await fetch('/api/papers/export/csv');
                if (!response.ok) throw new Error('Failed to export');
                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'papers_export.csv';
                a.click();
            } catch (err) {
                console.error('Error exporting:', err);
                alert('Failed to export papers: ' + err.message);
            }
        }

        function generatePapersCSV(papers) {
            const headers = ['Title', 'Authors', 'Importance', 'URL', 'Published', 'Added'];
            const rows = papers.map(p => {
                const paper = p.paper || {};
                const externalId = paper.external_id || '';
                return [
                    (paper.title || p.title || '').replace(/"/g, '""'),
                    (paper.authors || []).join('; '),
                    p.importance || '',
                    externalId ? `https://arxiv.org/abs/${externalId}` : (paper.url || ''),
                    paper.published_at || '',
                    p.first_seen_at || ''
                ].map(v => `"${v}"`).join(',');
            });
            return [headers.join(','), ...rows].join('\n');
        }

        // Toast notification helper
        function showToast(message, type = 'info') {
            // Create a simple toast notification
            const toast = document.createElement('div');
            const bgColor = type === 'warning' ? '#d97706' : type === 'error' ? '#dc2626' : '#1e293b';
            toast.style.cssText = `
                position: fixed;
                bottom: 20px;
                right: 20px;
                background: ${bgColor};
                color: white;
                padding: 12px 20px;
                border-radius: 8px;
                font-size: 0.9rem;
                z-index: 10000;
                max-width: 400px;
                animation: slideIn 0.3s ease;
            `;
            toast.textContent = message;
            document.body.appendChild(toast);
            const duration = type === 'warning' ? 5000 : 3000;
            setTimeout(() => {
                toast.style.animation = 'slideOut 0.3s ease';
                setTimeout(() => toast.remove(), 300);
            }, duration);
        }

        // Keyboard shortcuts for papers
        document.addEventListener('keydown', (e) => {
            // Only handle if Papers tab is active
            const papersTab = document.getElementById('tab-papers');
            if (!papersTab?.classList.contains('active')) return;

            if (e.key === 'Escape') {
                // Close drawer if open
                if (document.getElementById('paper-drawer').classList.contains('visible')) {
                    closePaperDrawer();
                } else {
                    // Clear selection
                    clearSelection();
                }
            } else if ((e.ctrlKey || e.metaKey) && e.key === 'a') {
                e.preventDefault();
                toggleSelectAll();
            } else if (e.key === 'Delete' && selectedPaperIds.size > 0) {
                bulkDelete();
            }
        });

        // ========== Email Tab State Management ==========
        let selectedEmailIds = new Set();
        let allEmailsData = [];
        let allEmailIds = [];
        let currentEmailSortField = 'created_at';
        let currentEmailSortDir = 'desc';
        let emailSearchTimeout = null;
        let currentEmailDetailId = null;

        function debouncedEmailSearch() {
            clearTimeout(emailSearchTimeout);
            emailSearchTimeout = setTimeout(() => {
                refreshEmails();
            }, 250);
        }

        function setEmailSortOrder(field, btn) {
            currentEmailSortField = field;
            document.querySelectorAll('#email-list-header .sort-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            refreshEmails();
        }

        function toggleEmailSortDirection() {
            currentEmailSortDir = currentEmailSortDir === 'desc' ? 'asc' : 'desc';
            const btn = document.getElementById('email-sort-dir-btn');
            btn.textContent = currentEmailSortDir === 'desc' ? '↓' : '↑';
            refreshEmails();
        }

        async function refreshEmails() {
            const list = document.getElementById('emails-list');
            const header = document.getElementById('email-list-header');

            list.innerHTML = Array(3).fill(0).map(() => `
                <div class="skeleton-row">
                    <div class="skeleton-box skeleton-checkbox"></div>
                    <div class="skeleton-content">
                        <div class="skeleton-box skeleton-title"></div>
                        <div class="skeleton-box skeleton-meta"></div>
                    </div>
                </div>
            `).join('');

            try {
                const q = document.getElementById('emails-search')?.value || '';
                const statusFilter = document.getElementById('emails-filter-status')?.value || '';

                const response = await fetch('/api/emails');
                if (!response.ok) throw new Error('Failed to fetch emails');
                const data = await response.json();

                let emails = data.emails || [];

                // Client-side filtering
                if (q) {
                    const query = q.toLowerCase();
                    emails = emails.filter(e =>
                        (e.subject || '').toLowerCase().includes(query) ||
                        (e.recipient_email || '').toLowerCase().includes(query) ||
                        (e.body_preview || '').toLowerCase().includes(query)
                    );
                }
                if (statusFilter) {
                    emails = emails.filter(e => e.status === statusFilter);
                }

                // Client-side sorting
                emails.sort((a, b) => {
                    let aVal = a[currentEmailSortField] || '';
                    let bVal = b[currentEmailSortField] || '';
                    if (currentEmailSortField === 'created_at') {
                        aVal = new Date(aVal).getTime();
                        bVal = new Date(bVal).getTime();
                    }
                    if (currentEmailSortDir === 'asc') {
                        return aVal > bVal ? 1 : -1;
                    } else {
                        return aVal < bVal ? 1 : -1;
                    }
                });

                allEmailsData = emails;
                allEmailIds = emails.map(e => e.id);

                // Clean up selection
                const visibleIds = new Set(allEmailIds);
                selectedEmailIds.forEach(id => {
                    if (!visibleIds.has(id)) selectedEmailIds.delete(id);
                });

                if (emails.length === 0) {
                    list.innerHTML = `
                        <div class="empty-state">
                            <div class="emoji">📧</div>
                            <div>${q || statusFilter ? 'No emails match your filters.' : 'No emails sent yet.'}</div>
                            ${q || statusFilter ? '<button class="clear-filters-btn" onclick="clearEmailFilters()">Clear Filters</button>' : ''}
                        </div>
                    `;
                    header.style.display = 'none';
                    updateEmailBulkActionBar();
                    return;
                }

                header.style.display = 'flex';
                renderEmailsList();
                updateEmailBulkActionBar();
                updateSelectAllEmailsCheckbox();
            } catch (err) {
                console.error('Error fetching emails:', err);
                list.innerHTML = '<div class="empty-state"><div class="emoji">❌</div><div>Failed to load emails.</div></div>';
            }
        }

        function renderEmailsList() {
            const list = document.getElementById('emails-list');

            list.innerHTML = allEmailsData.map(e => {
                const isSelected = selectedEmailIds.has(e.id);
                const triggeredBadge = e.triggered_by === 'user'
                    ? '<span class="triggered-badge user"><span class="icon">👤</span>Sent by you</span>'
                    : '<span class="triggered-badge agent"><span class="icon">🤖</span>Sent by ResearchPulse</span>';

                const paperCount = e.paper_ids && e.paper_ids.length > 0 ? e.paper_ids.length : 0;
                const statusClass = e.status === 'sent' ? 'sent' : e.status === 'failed' ? 'failed' : 'pending';

                return `
                <div class="email-row ${isSelected ? 'selected' : ''}" id="email-row-${e.id}" onclick="openEmailDetailModal('${e.id}')">
                    <input type="checkbox" 
                           class="email-checkbox" 
                           ${isSelected ? 'checked' : ''} 
                           onclick="event.stopPropagation(); toggleEmailSelection('${e.id}')"
                           title="Select email" />
                    <div class="email-content">
                        <div class="email-subject">
                            <span class="status-dot ${statusClass}"></span>
                            ${escapeHtml(e.subject || 'No Subject')}
                            ${triggeredBadge}
                        </div>
                        <div class="email-meta">
                            <span class="email-meta-item">📬 ${escapeHtml(e.recipient_email)}</span>
                            <span class="email-meta-item">📅 ${new Date(e.created_at).toLocaleString()}</span>
                            ${paperCount > 0 ? `<span class="email-meta-item">📄 ${paperCount} paper(s)</span>` : ''}
                            <span class="importance-badge importance-${e.status === 'sent' ? 'high' : e.status === 'failed' ? 'low' : 'medium'}">${e.status}</span>
                        </div>
                        ${e.body_preview ? `<div class="email-preview">${escapeHtml(e.body_preview)}</div>` : ''}
                    </div>
                    <div class="email-actions" onclick="event.stopPropagation()">
                        <button class="email-action-btn" onclick="openEmailDetailModal('${e.id}')" title="View details">👁️ View</button>
                        <button class="email-action-btn" onclick="deleteEmail('${e.id}')" title="Delete">🗑️</button>
                    </div>
                </div>
            `;
            }).join('');
        }

        function toggleEmailSelection(emailId) {
            if (selectedEmailIds.has(emailId)) {
                selectedEmailIds.delete(emailId);
            } else {
                selectedEmailIds.add(emailId);
            }
            updateEmailRowHighlight(emailId);
            updateEmailBulkActionBar();
            updateSelectAllEmailsCheckbox();
        }

        function toggleSelectAllEmails() {
            const checkbox = document.getElementById('select-all-emails-checkbox');
            if (selectedEmailIds.size === allEmailIds.length && allEmailIds.length > 0) {
                selectedEmailIds.clear();
                checkbox.checked = false;
            } else {
                allEmailIds.forEach(id => selectedEmailIds.add(id));
                checkbox.checked = true;
            }
            renderEmailsList();
            updateEmailBulkActionBar();
        }

        function clearEmailSelection() {
            selectedEmailIds.clear();
            document.getElementById('select-all-emails-checkbox').checked = false;
            renderEmailsList();
            updateEmailBulkActionBar();
        }

        function updateEmailRowHighlight(emailId) {
            const row = document.getElementById(`email-row-${emailId}`);
            if (row) {
                const checkbox = row.querySelector('.email-checkbox');
                if (selectedEmailIds.has(emailId)) {
                    row.classList.add('selected');
                    if (checkbox) checkbox.checked = true;
                } else {
                    row.classList.remove('selected');
                    if (checkbox) checkbox.checked = false;
                }
            }
        }

        function updateEmailBulkActionBar() {
            const bar = document.getElementById('email-bulk-action-bar');
            const count = document.getElementById('email-bulk-selection-count');
            if (selectedEmailIds.size > 0) {
                bar.classList.add('visible');
                count.textContent = `${selectedEmailIds.size} selected`;
            } else {
                bar.classList.remove('visible');
            }
        }

        function updateSelectAllEmailsCheckbox() {
            const checkbox = document.getElementById('select-all-emails-checkbox');
            if (allEmailIds.length > 0 && selectedEmailIds.size === allEmailIds.length) {
                checkbox.checked = true;
                checkbox.indeterminate = false;
            } else if (selectedEmailIds.size > 0) {
                checkbox.checked = false;
                checkbox.indeterminate = true;
            } else {
                checkbox.checked = false;
                checkbox.indeterminate = false;
            }
        }

        function clearEmailFilters() {
            document.getElementById('emails-search').value = '';
            document.getElementById('emails-filter-status').value = '';
            refreshEmails();
        }

        function openEmailDetailModal(emailId) {
            const email = allEmailsData.find(e => e.id === emailId);
            if (!email) return;

            currentEmailDetailId = emailId;
            const content = document.getElementById('email-detail-content');
            const statusClass = email.status === 'sent' ? 'sent' : email.status === 'failed' ? 'failed' : 'pending';

            content.innerHTML = `
                <div class="detail-section">
                    <h4>Subject</h4>
                    <p style="font-weight: 600; font-size: 1.1rem;">${escapeHtml(email.subject || 'No Subject')}</p>
                </div>
                
                <div class="detail-section">
                    <h4>Status</h4>
                    <div class="detail-badge-row">
                        <span class="status-dot ${statusClass}"></span>
                        <span class="importance-badge importance-${email.status === 'sent' ? 'high' : email.status === 'failed' ? 'low' : 'medium'}">${email.status}</span>
                        ${email.triggered_by === 'user'
                    ? '<span class="triggered-badge user"><span class="icon">👤</span>Sent by your request</span>'
                    : '<span class="triggered-badge agent"><span class="icon">🤖</span>Sent automatically</span>'}
                    </div>
                </div>
                
                <div class="detail-section">
                    <h4>Recipient</h4>
                    <p>📬 ${escapeHtml(email.recipient_email)}</p>
                </div>
                
                <div class="detail-section">
                    <h4>Sent At</h4>
                    <p>📅 ${new Date(email.created_at).toLocaleString()}</p>
                </div>
                
                ${email.paper_ids && email.paper_ids.length > 0 ? `
                <div class="detail-section">
                    <h4>Related Papers (${email.paper_ids.length})</h4>
                    <div class="detail-badge-row">
                        ${email.paper_ids.map(pid => `<span class="detail-paper-link">📄 ${pid.substring(0, 8)}...</span>`).join('')}
                    </div>
                </div>
                ` : ''}
                
                <div class="detail-section">
                    <h4>Email Body</h4>
                    <div style="background: var(--bg); padding: 16px; border-radius: 8px; white-space: pre-wrap; font-size: 0.9rem; max-height: 300px; overflow-y: auto;">
                        ${escapeHtml(email.body_preview || email.body || 'No content available')}
                    </div>
                </div>
            `;

            document.getElementById('email-detail-modal').classList.add('active');
        }

        function closeEmailDetailModal() {
            document.getElementById('email-detail-modal').classList.remove('active');
            currentEmailDetailId = null;
        }

        async function resendEmailFromModal() {
            if (!currentEmailDetailId) return;
            try {
                const response = await fetch(`/api/emails/${currentEmailDetailId}/resend`, { method: 'POST' });
                if (!response.ok) throw new Error('Failed to resend email');
                showToast('Email resent successfully!');
                closeEmailDetailModal();
                refreshEmails();
            } catch (err) {
                alert('Failed to resend email: ' + err.message);
            }
        }

        async function deleteEmail(emailId) {
            if (!confirm('Are you sure you want to delete this email record?')) return;
            try {
                const response = await fetch(`/api/emails/${emailId}`, { method: 'DELETE' });
                if (!response.ok) throw new Error('Failed to delete email');
                showToast('Email deleted');
                refreshEmails();
            } catch (err) {
                alert('Failed to delete email: ' + err.message);
            }
        }

        async function bulkDeleteEmails() {
            if (selectedEmailIds.size === 0) return;
            if (!confirm(`Delete ${selectedEmailIds.size} email(s)? This cannot be undone.`)) return;
            try {
                const response = await fetch('/api/bulk/emails/delete', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(Array.from(selectedEmailIds))
                });
                if (!response.ok) throw new Error('Failed to delete emails');
                const result = await response.json();
                showToast(`Deleted ${result.deleted || selectedEmailIds.size} emails`);
                clearEmailSelection();
                refreshEmails();
            } catch (err) {
                alert('Failed to delete emails: ' + err.message);
            }
        }

        async function bulkResendEmails() {
            if (selectedEmailIds.size === 0) return;
            try {
                const response = await fetch('/api/bulk/emails/resend', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(Array.from(selectedEmailIds))
                });
                if (!response.ok) throw new Error('Failed to resend emails');
                showToast(`Resent ${selectedEmailIds.size} emails`);
                clearEmailSelection();
                refreshEmails();
            } catch (err) {
                alert('Failed to resend emails: ' + err.message);
            }
        }

        function bulkExportEmails() {
            if (selectedEmailIds.size === 0) return;
            const selectedEmails = allEmailsData.filter(e => selectedEmailIds.has(e.id));
            const csvContent = generateEmailsCSV(selectedEmails);
            downloadCSV(csvContent, 'emails_export.csv');
            showToast(`Exported ${selectedEmails.length} emails`);
        }

        function generateEmailsCSV(emails) {
            const headers = ['Subject', 'Recipient', 'Status', 'Sent At', 'Triggered By'];
            const rows = emails.map(e => [
                (e.subject || '').replace(/"/g, '""'),
                e.recipient_email || '',
                e.status || '',
                e.created_at || '',
                e.triggered_by || ''
            ].map(v => `"${v}"`).join(','));
            return [headers.join(','), ...rows].join('\n');
        }

        function downloadCSV(content, filename) {
            const blob = new Blob([content], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            a.click();
            window.URL.revokeObjectURL(url);
        }

        // ========== Calendar Tab State Management ==========
        let selectedCalendarIds = new Set();
        let allCalendarData = [];
        let allCalendarIds = [];
        let currentCalendarSortField = 'start_time';
        let currentCalendarSortDir = 'desc';
        let calendarSearchTimeout = null;
        let currentCalendarDetailId = null;

        function debouncedCalendarSearch() {
            clearTimeout(calendarSearchTimeout);
            calendarSearchTimeout = setTimeout(() => {
                refreshCalendar();
            }, 250);
        }

        function setCalendarSortOrder(field, btn) {
            currentCalendarSortField = field;
            document.querySelectorAll('#calendar-list-header .sort-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            refreshCalendar();
        }

        function toggleCalendarSortDirection() {
            currentCalendarSortDir = currentCalendarSortDir === 'desc' ? 'asc' : 'desc';
            const btn = document.getElementById('calendar-sort-dir-btn');
            btn.textContent = currentCalendarSortDir === 'desc' ? '↓' : '↑';
            refreshCalendar();
        }

        async function refreshCalendar() {
            const list = document.getElementById('calendar-list');
            const header = document.getElementById('calendar-list-header');

            list.innerHTML = Array(3).fill(0).map(() => `
                <div class="skeleton-row">
                    <div class="skeleton-box skeleton-checkbox"></div>
                    <div class="skeleton-content">
                        <div class="skeleton-box skeleton-title"></div>
                        <div class="skeleton-box skeleton-meta"></div>
                    </div>
                </div>
            `).join('');

            try {
                const q = document.getElementById('calendar-search')?.value || '';
                const statusFilter = document.getElementById('calendar-filter-status')?.value || '';

                const response = await fetch('/api/calendar');
                if (!response.ok) throw new Error('Failed to fetch calendar');
                const data = await response.json();

                let events = data.events || [];
                const now = new Date();

                // Add computed time status
                events = events.map(e => ({
                    ...e,
                    timeStatus: new Date(e.start_time) > now ? 'upcoming' : 'past'
                }));

                // Client-side filtering
                if (q) {
                    const query = q.toLowerCase();
                    events = events.filter(e =>
                        (e.title || '').toLowerCase().includes(query) ||
                        (e.description || '').toLowerCase().includes(query)
                    );
                }
                if (statusFilter) {
                    if (statusFilter === 'upcoming' || statusFilter === 'past') {
                        events = events.filter(e => e.timeStatus === statusFilter);
                    } else {
                        events = events.filter(e => e.status === statusFilter);
                    }
                }

                // Client-side sorting
                events.sort((a, b) => {
                    let aVal = a[currentCalendarSortField] || '';
                    let bVal = b[currentCalendarSortField] || '';
                    if (currentCalendarSortField === 'start_time') {
                        aVal = new Date(aVal).getTime();
                        bVal = new Date(bVal).getTime();
                    } else if (currentCalendarSortField === 'duration_minutes') {
                        aVal = parseInt(aVal) || 0;
                        bVal = parseInt(bVal) || 0;
                    }
                    if (currentCalendarSortDir === 'asc') {
                        return aVal > bVal ? 1 : -1;
                    } else {
                        return aVal < bVal ? 1 : -1;
                    }
                });

                allCalendarData = events;
                allCalendarIds = events.map(e => e.id);

                // Clean up selection
                const visibleIds = new Set(allCalendarIds);
                selectedCalendarIds.forEach(id => {
                    if (!visibleIds.has(id)) selectedCalendarIds.delete(id);
                });

                if (events.length === 0) {
                    list.innerHTML = `
                        <div class="empty-state">
                            <div class="emoji">📅</div>
                            <div>${q || statusFilter ? 'No events match your filters.' : 'No calendar events yet.'}</div>
                            ${q || statusFilter ? '<button class="clear-filters-btn" onclick="clearCalendarFilters()">Clear Filters</button>' : ''}
                        </div>
                    `;
                    header.style.display = 'none';
                    updateCalendarBulkActionBar();
                    return;
                }

                header.style.display = 'flex';
                renderCalendarList();
                updateCalendarBulkActionBar();
                updateSelectAllCalendarCheckbox();
            } catch (err) {
                console.error('Error fetching calendar:', err);
                list.innerHTML = '<div class="empty-state"><div class="emoji">❌</div><div>Failed to load calendar.</div></div>';
            }
        }

        function renderCalendarList() {
            const list = document.getElementById('calendar-list');

            list.innerHTML = allCalendarData.map(e => {
                const isSelected = selectedCalendarIds.has(e.id);
                const triggeredBadge = e.triggered_by === 'user'
                    ? '<span class="triggered-badge user"><span class="icon">👤</span>Sent by you</span>'
                    : '<span class="triggered-badge agent"><span class="icon">🤖</span>Sent by ResearchPulse</span>';

                const paperCount = e.paper_ids && e.paper_ids.length > 0 ? e.paper_ids.length : 0;
                const isUpcoming = e.timeStatus === 'upcoming';
                const startDate = new Date(e.start_time);
                const timeStr = startDate.toLocaleString();

                // Format relative time
                const now = new Date();
                const diffMs = startDate - now;
                const diffHours = Math.abs(diffMs) / 3600000;
                let relativeTime = '';
                if (isUpcoming) {
                    if (diffHours < 1) relativeTime = 'in ' + Math.round(diffMs / 60000) + ' min';
                    else if (diffHours < 24) relativeTime = 'in ' + Math.round(diffHours) + ' hours';
                    else relativeTime = 'in ' + Math.round(diffHours / 24) + ' days';
                } else {
                    if (diffHours < 24) relativeTime = Math.round(diffHours) + ' hours ago';
                    else relativeTime = Math.round(diffHours / 24) + ' days ago';
                }

                const hasInvite = e.ics_uid ? '📨' : '';

                return `
                <div class="calendar-row ${isSelected ? 'selected' : ''}" id="calendar-row-${e.id}" onclick="openCalendarDetailModal('${e.id}')">
                    <input type="checkbox" 
                           class="calendar-checkbox" 
                           ${isSelected ? 'checked' : ''} 
                           onclick="event.stopPropagation(); toggleCalendarSelection('${e.id}')"
                           title="Select event" />
                    <div class="calendar-content">
                        <div class="calendar-title">
                            ${escapeHtml(e.title)} ${hasInvite}
                            <span class="calendar-time-badge ${isUpcoming ? '' : 'past'}">${isUpcoming ? '🕐' : '✓'} ${relativeTime}</span>
                            ${triggeredBadge}
                        </div>
                        <div class="calendar-meta">
                            <span class="calendar-meta-item">📅 ${timeStr}</span>
                            <span class="calendar-meta-item">⏱️ ${e.duration_minutes} min</span>
                            ${paperCount > 0 ? `<span class="calendar-meta-item">📄 ${paperCount} paper(s)</span>` : ''}
                            ${e.reminder_minutes ? `<span class="calendar-meta-item">🔔 ${e.reminder_minutes}min reminder</span>` : ''}
                        </div>
                        ${e.description ? `<div class="calendar-description">${escapeHtml(e.description)}</div>` : ''}
                    </div>
                    <div class="calendar-actions" onclick="event.stopPropagation()">
                        <button class="calendar-action-btn" onclick="openCalendarDetailModal('${e.id}')" title="View details">👁️ View</button>
                        <button class="calendar-action-btn" onclick="downloadSingleICS('${e.id}')" title="Download ICS">📥</button>
                        <button class="calendar-action-btn" onclick="deleteEvent('${e.id}')" title="Delete">🗑️</button>
                    </div>
                </div>
            `;
            }).join('');
        }

        function toggleCalendarSelection(eventId) {
            if (selectedCalendarIds.has(eventId)) {
                selectedCalendarIds.delete(eventId);
            } else {
                selectedCalendarIds.add(eventId);
            }
            updateCalendarRowHighlight(eventId);
            updateCalendarBulkActionBar();
            updateSelectAllCalendarCheckbox();
        }

        function toggleSelectAllCalendar() {
            const checkbox = document.getElementById('select-all-calendar-checkbox');
            if (selectedCalendarIds.size === allCalendarIds.length && allCalendarIds.length > 0) {
                selectedCalendarIds.clear();
                checkbox.checked = false;
            } else {
                allCalendarIds.forEach(id => selectedCalendarIds.add(id));
                checkbox.checked = true;
            }
            renderCalendarList();
            updateCalendarBulkActionBar();
        }

        function clearCalendarSelection() {
            selectedCalendarIds.clear();
            document.getElementById('select-all-calendar-checkbox').checked = false;
            renderCalendarList();
            updateCalendarBulkActionBar();
        }

        function updateCalendarRowHighlight(eventId) {
            const row = document.getElementById(`calendar-row-${eventId}`);
            if (row) {
                const checkbox = row.querySelector('.calendar-checkbox');
                if (selectedCalendarIds.has(eventId)) {
                    row.classList.add('selected');
                    if (checkbox) checkbox.checked = true;
                } else {
                    row.classList.remove('selected');
                    if (checkbox) checkbox.checked = false;
                }
            }
        }

        function updateCalendarBulkActionBar() {
            const bar = document.getElementById('calendar-bulk-action-bar');
            const count = document.getElementById('calendar-bulk-selection-count');
            if (selectedCalendarIds.size > 0) {
                bar.classList.add('visible');
                count.textContent = `${selectedCalendarIds.size} selected`;
            } else {
                bar.classList.remove('visible');
            }
        }

        function updateSelectAllCalendarCheckbox() {
            const checkbox = document.getElementById('select-all-calendar-checkbox');
            if (allCalendarIds.length > 0 && selectedCalendarIds.size === allCalendarIds.length) {
                checkbox.checked = true;
                checkbox.indeterminate = false;
            } else if (selectedCalendarIds.size > 0) {
                checkbox.checked = false;
                checkbox.indeterminate = true;
            } else {
                checkbox.checked = false;
                checkbox.indeterminate = false;
            }
        }

        function clearCalendarFilters() {
            document.getElementById('calendar-search').value = '';
            document.getElementById('calendar-filter-status').value = '';
            refreshCalendar();
        }

        function openCalendarDetailModal(eventId) {
            const event = allCalendarData.find(e => e.id === eventId);
            if (!event) return;

            currentCalendarDetailId = eventId;
            const content = document.getElementById('calendar-detail-content');
            const startDate = new Date(event.start_time);
            const endDate = new Date(startDate.getTime() + event.duration_minutes * 60000);
            const isUpcoming = event.timeStatus === 'upcoming';

            // Rescheduling info
            const sequenceNum = event.sequence_number || 0;
            const rescheduleNote = event.reschedule_note || '';
            const wasRescheduled = sequenceNum > 0 || rescheduleNote;

            content.innerHTML = `
                <div class="detail-section">
                    <h4>Title</h4>
                    <p style="font-weight: 600; font-size: 1.1rem;">${escapeHtml(event.title)}</p>
                </div>
                
                <div class="detail-section">
                    <h4>Status</h4>
                    <div class="detail-badge-row">
                        <span class="calendar-time-badge ${isUpcoming ? '' : 'past'}">${isUpcoming ? '🕐 Upcoming' : '✓ Past'}</span>
                        <span class="importance-badge importance-${event.status === 'created' ? 'high' : 'medium'}">${event.status}</span>
                        ${event.triggered_by === 'user'
                    ? '<span class="triggered-badge user"><span class="icon">👤</span>Created by you</span>'
                    : '<span class="triggered-badge agent"><span class="icon">🤖</span>Auto-scheduled</span>'}
                        ${event.ics_uid ? '<span style="color:#27ae60;font-size:0.85rem;">📨 Invite sent</span>' : ''}
                    </div>
                </div>
                
                <div class="detail-section">
                    <h4>Time</h4>
                    <p>
                        📅 <strong>Start:</strong> ${startDate.toLocaleString()}<br>
                        📅 <strong>End:</strong> ${endDate.toLocaleString()}<br>
                        ⏱️ <strong>Duration:</strong> ${event.duration_minutes} minutes
                    </p>
                </div>
                
                ${event.reminder_minutes ? `
                <div class="detail-section">
                    <h4>Reminder</h4>
                    <p>🔔 ${event.reminder_minutes} minutes before</p>
                </div>
                ` : ''}
                
                ${wasRescheduled ? `
                <div class="detail-section">
                    <h4>Rescheduling History</h4>
                    <p style="color: #e67e22;">🔄 ${escapeHtml(rescheduleNote || `Updated ${sequenceNum} time(s)`)}</p>
                </div>
                ` : ''}
                
                ${event.paper_ids && event.paper_ids.length > 0 ? `
                <div class="detail-section">
                    <h4>Related Papers (${event.paper_ids.length})</h4>
                    <div class="detail-badge-row">
                        ${event.paper_ids.map(pid => `<span class="detail-paper-link">📄 ${pid.substring(0, 8)}...</span>`).join('')}
                    </div>
                </div>
                ` : ''}
                
                ${event.description ? `
                <div class="detail-section">
                    <h4>Description</h4>
                    <div style="background: var(--bg); padding: 16px; border-radius: 8px; white-space: pre-wrap; font-size: 0.9rem; max-height: 200px; overflow-y: auto;">
                        ${escapeHtml(event.description)}
                    </div>
                </div>
                ` : ''}
            `;

            document.getElementById('calendar-detail-modal').classList.add('active');
        }

        function closeCalendarDetailModal() {
            document.getElementById('calendar-detail-modal').classList.remove('active');
            currentCalendarDetailId = null;
        }

        async function downloadEventICS() {
            if (!currentCalendarDetailId) return;
            await downloadSingleICS(currentCalendarDetailId);
        }

        async function downloadSingleICS(eventId) {
            try {
                const response = await fetch(`/api/calendar/${eventId}/ics`);
                if (!response.ok) throw new Error('Failed to generate ICS');
                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `event_${eventId.substring(0, 8)}.ics`;
                a.click();
                window.URL.revokeObjectURL(url);
                showToast('ICS file downloaded!');
            } catch (err) {
                alert('Failed to download ICS: ' + err.message);
            }
        }

        function editEventFromModal() {
            if (!currentCalendarDetailId) return;
            const event = allCalendarData.find(e => e.id === currentCalendarDetailId);
            if (!event) return;

            closeCalendarDetailModal();
            showEditEventModal(event);
        }

        function showCreateEventModal() {
            document.getElementById('event-modal-title').textContent = '➕ Create New Event';
            document.getElementById('event-title').value = '';
            document.getElementById('event-datetime').value = '';
            document.getElementById('event-duration').value = '30';
            document.getElementById('event-description').value = '';
            document.getElementById('event-reminder').value = '15';
            document.getElementById('event-edit-id').value = '';
            document.getElementById('create-event-modal').classList.add('active');
        }

        function showEditEventModal(event) {
            document.getElementById('event-modal-title').textContent = '✏️ Edit Event';
            document.getElementById('event-title').value = event.title || '';

            // Format datetime for input
            const dt = new Date(event.start_time);
            const localDt = new Date(dt.getTime() - dt.getTimezoneOffset() * 60000).toISOString().slice(0, 16);
            document.getElementById('event-datetime').value = localDt;

            document.getElementById('event-duration').value = event.duration_minutes || 30;
            document.getElementById('event-description').value = event.description || '';
            document.getElementById('event-reminder').value = event.reminder_minutes || 0;
            document.getElementById('event-edit-id').value = event.id;
            document.getElementById('create-event-modal').classList.add('active');
        }

        function closeCreateEventModal() {
            document.getElementById('create-event-modal').classList.remove('active');
        }

        async function saveEvent() {
            const title = document.getElementById('event-title').value.trim();
            const datetime = document.getElementById('event-datetime').value;
            const duration = parseInt(document.getElementById('event-duration').value) || 30;
            const description = document.getElementById('event-description').value.trim();
            const reminder = parseInt(document.getElementById('event-reminder').value) || 0;
            const editId = document.getElementById('event-edit-id').value;

            if (!title || !datetime) {
                alert('Please enter title and date/time');
                return;
            }

            const eventData = {
                title,
                start_time: new Date(datetime).toISOString(),
                duration_minutes: duration,
                description,
                reminder_minutes: reminder,
                triggered_by: 'user'
            };

            try {
                let response;
                if (editId) {
                    response = await fetch(`/api/calendar/${editId}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(eventData)
                    });
                } else {
                    response = await fetch('/api/calendar', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(eventData)
                    });
                }

                if (!response.ok) throw new Error('Failed to save event');
                showToast(editId ? 'Event updated!' : 'Event created!');
                closeCreateEventModal();
                refreshCalendar();
            } catch (err) {
                alert('Failed to save event: ' + err.message);
            }
        }

        async function deleteEvent(eventId) {
            if (!confirm('Are you sure you want to delete this event?')) return;
            try {
                const response = await fetch(`/api/calendar/${eventId}`, { method: 'DELETE' });
                if (!response.ok) throw new Error('Failed to delete event');
                showToast('Event deleted');
                refreshCalendar();
            } catch (err) {
                alert('Failed to delete event: ' + err.message);
            }
        }

        async function bulkDeleteEvents() {
            if (selectedCalendarIds.size === 0) return;
            if (!confirm(`Delete ${selectedCalendarIds.size} event(s)? This cannot be undone.`)) return;
            try {
                const response = await fetch('/api/bulk/calendar/delete', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(Array.from(selectedCalendarIds))
                });
                if (!response.ok) throw new Error('Failed to delete events');
                const result = await response.json();
                showToast(`Deleted ${result.deleted || selectedCalendarIds.size} events`);
                clearCalendarSelection();
                refreshCalendar();
            } catch (err) {
                alert('Failed to delete events: ' + err.message);
            }
        }

        function bulkDownloadICS() {
            if (selectedCalendarIds.size === 0) return;
            selectedCalendarIds.forEach((id, index) => {
                setTimeout(() => {
                    downloadSingleICS(id);
                }, index * 300);
            });
            showToast(`Downloading ${selectedCalendarIds.size} ICS files...`);
        }

        function bulkRescheduleEvents() {
            if (selectedCalendarIds.size === 0) return;
            const newTime = prompt('Enter new time (e.g., "tomorrow 2pm" or "2026-02-05 14:00"):');
            if (!newTime) return;

            // Parse the time (simplified - in production use a proper date parser)
            let parsedDate;
            try {
                parsedDate = new Date(newTime);
                if (isNaN(parsedDate.getTime())) {
                    throw new Error('Invalid date');
                }
            } catch {
                alert('Could not parse the date. Please use format like "2026-02-05 14:00"');
                return;
            }

            // Reschedule each event
            Promise.all(Array.from(selectedCalendarIds).map(async (id) => {
                const event = allCalendarData.find(e => e.id === id);
                if (!event) return;

                const response = await fetch(`/api/calendar/${id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        ...event,
                        start_time: parsedDate.toISOString(),
                        reschedule_note: 'Bulk rescheduled by user'
                    })
                });
                return response.ok;
            })).then(() => {
                showToast(`Rescheduled ${selectedCalendarIds.size} events`);
                clearCalendarSelection();
                refreshCalendar();
            }).catch(err => {
                alert('Failed to reschedule some events: ' + err.message);
            });
        }

        // ========== Shares Tab State Management ==========
        let selectedShareIds = new Set();
        let allShareIds = [];
        let allSharesData = [];
        let currentShareSortField = 'created_at';
        let currentShareSortDir = 'desc';
        let shareSearchTimeout = null;

        function debouncedShareSearch() {
            clearTimeout(shareSearchTimeout);
            shareSearchTimeout = setTimeout(() => {
                refreshShares();
            }, 250);
        }

        function setShareSortOrder(field, btn) {
            currentShareSortField = field;
            document.querySelectorAll('#share-list-header .sort-btn').forEach(b => b.classList.remove('active'));
            if (btn) btn.classList.add('active');
            refreshShares();
        }

        function toggleShareSortDirection() {
            currentShareSortDir = currentShareSortDir === 'asc' ? 'desc' : 'asc';
            const btn = document.getElementById('share-sort-dir-btn');
            if (btn) btn.textContent = currentShareSortDir === 'asc' ? '↑' : '↓';
            refreshShares();
        }

        function toggleSelectAllShares() {
            const cb = document.getElementById('select-all-shares-checkbox');
            if (cb && cb.checked) {
                allShareIds.forEach(id => selectedShareIds.add(id));
            } else {
                selectedShareIds.clear();
            }
            renderSharesList();
            updateShareBulkActionBar();
        }

        function toggleShareSelection(id) {
            if (selectedShareIds.has(id)) {
                selectedShareIds.delete(id);
            } else {
                selectedShareIds.add(id);
            }
            const row = document.getElementById(`share-row-${id}`);
            if (row) row.classList.toggle('selected', selectedShareIds.has(id));
            updateShareBulkActionBar();
            updateSelectAllSharesCheckbox();
        }

        function clearShareSelection() {
            selectedShareIds.clear();
            renderSharesList();
            updateShareBulkActionBar();
            updateSelectAllSharesCheckbox();
        }

        function updateShareBulkActionBar() {
            const bar = document.getElementById('share-bulk-action-bar');
            const count = document.getElementById('share-bulk-selection-count');
            if (bar) bar.style.display = selectedShareIds.size > 0 ? 'flex' : 'none';
            if (count) count.textContent = `${selectedShareIds.size} selected`;
        }

        function updateSelectAllSharesCheckbox() {
            const cb = document.getElementById('select-all-shares-checkbox');
            if (cb) {
                cb.checked = allShareIds.length > 0 && allShareIds.every(id => selectedShareIds.has(id));
                cb.indeterminate = selectedShareIds.size > 0 && !cb.checked;
            }
        }

        async function deleteShare(shareId) {
            if (!confirm('Are you sure you want to delete this share record?')) return;
            try {
                const response = await fetch(`/api/shares/${shareId}`, { method: 'DELETE' });
                if (!response.ok) throw new Error('Failed to delete share');
                showToast('Share deleted');
                refreshShares();
            } catch (err) {
                alert('Failed to delete share: ' + err.message);
            }
        }

        async function bulkDeleteShares() {
            if (selectedShareIds.size === 0) return;
            if (!confirm(`Delete ${selectedShareIds.size} share(s)? This cannot be undone.`)) return;
            try {
                const response = await fetch('/api/bulk/shares/delete', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(Array.from(selectedShareIds))
                });
                if (!response.ok) throw new Error('Failed to delete shares');
                const result = await response.json();
                showToast(`Deleted ${result.deleted || selectedShareIds.size} shares`);
                clearShareSelection();
                refreshShares();
            } catch (err) {
                alert('Failed to delete shares: ' + err.message);
            }
        }

        async function refreshShares() {
            const list = document.getElementById('shares-list');
            const header = document.getElementById('share-list-header');

            list.innerHTML = Array(3).fill(0).map(() => `
                <div class="skeleton-row">
                    <div class="skeleton-box skeleton-checkbox"></div>
                    <div class="skeleton-content">
                        <div class="skeleton-box skeleton-title"></div>
                        <div class="skeleton-box skeleton-meta"></div>
                    </div>
                </div>
            `).join('');

            try {
                const q = document.getElementById('shares-search')?.value || '';
                const statusFilter = document.getElementById('shares-filter-status')?.value || '';

                const response = await fetch('/api/shares');
                if (!response.ok) throw new Error('Failed to fetch shares');
                const data = await response.json();

                let shares = data.shares || [];

                // Client-side filtering
                if (q) {
                    const query = q.toLowerCase();
                    shares = shares.filter(s =>
                        (s.colleague_name || '').toLowerCase().includes(query) ||
                        (s.paper_title || '').toLowerCase().includes(query) ||
                        (s.reason || '').toLowerCase().includes(query)
                    );
                }
                if (statusFilter) {
                    shares = shares.filter(s => s.status === statusFilter);
                }

                // Client-side sorting
                shares.sort((a, b) => {
                    let aVal = a[currentShareSortField] || '';
                    let bVal = b[currentShareSortField] || '';
                    if (currentShareSortField === 'created_at') {
                        aVal = new Date(aVal).getTime();
                        bVal = new Date(bVal).getTime();
                    } else {
                        aVal = String(aVal).toLowerCase();
                        bVal = String(bVal).toLowerCase();
                    }
                    if (currentShareSortDir === 'asc') {
                        return aVal > bVal ? 1 : -1;
                    } else {
                        return aVal < bVal ? 1 : -1;
                    }
                });

                allSharesData = shares;
                allShareIds = shares.map(s => s.id);

                // Clean up selection
                const visibleIds = new Set(allShareIds);
                selectedShareIds.forEach(id => {
                    if (!visibleIds.has(id)) selectedShareIds.delete(id);
                });

                if (shares.length === 0) {
                    list.innerHTML = `
                        <div class="empty-state">
                            <div class="emoji">📤</div>
                            <div>${q || statusFilter ? 'No shares match your filters.' : 'No papers shared with colleagues yet.'}</div>
                            ${q || statusFilter ? '<button class="clear-filters-btn" onclick="clearShareFilters()">Clear Filters</button>' : ''}
                        </div>
                    `;
                    if (header) header.style.display = 'none';
                    updateShareBulkActionBar();
                    return;
                }

                if (header) header.style.display = 'flex';
                renderSharesList();
                updateShareBulkActionBar();
                updateSelectAllSharesCheckbox();
            } catch (err) {
                console.error('Error fetching shares:', err);
                list.innerHTML = '<div class="empty-state"><div class="emoji">❌</div><div>Failed to load shares.</div></div>';
            }
        }

        function clearShareFilters() {
            const search = document.getElementById('shares-search');
            const status = document.getElementById('shares-filter-status');
            if (search) search.value = '';
            if (status) status.value = '';
            refreshShares();
        }

        function renderSharesList() {
            const list = document.getElementById('shares-list');

            list.innerHTML = allSharesData.map(s => {
                const isSelected = selectedShareIds.has(s.id);
                const statusClass = s.status === 'sent' ? 'sent' : s.status === 'failed' ? 'failed' : 'pending';
                const colleagueName = s.colleague_name || (s.colleague && s.colleague.name) || 'Unknown';
                const paperTitle = s.paper_title || (s.paper && s.paper.title) || 'Untitled';
                const paperUrl = s.paper_url || (s.paper && s.paper.url) || '';

                return `
                <div class="email-row ${isSelected ? 'selected' : ''}" id="share-row-${s.id}">
                    <input type="checkbox"
                           class="email-checkbox"
                           ${isSelected ? 'checked' : ''}
                           onclick="event.stopPropagation(); toggleShareSelection('${s.id}')"
                           title="Select share" />
                    <div class="email-content" style="flex:1;min-width:0;">
                        <div class="email-subject">
                            📄 ${paperUrl ? `<a href="${escapeHtml(paperUrl)}" target="_blank" style="color:var(--text-primary);text-decoration:none;">${escapeHtml(paperTitle)}</a>` : escapeHtml(paperTitle)}
                        </div>
                        <div class="email-meta">
                            <span>👤 Shared with <strong>${escapeHtml(colleagueName)}</strong></span>
                            <span>📅 ${new Date(s.created_at).toLocaleString()}</span>
                            <span class="importance-badge importance-${statusClass === 'sent' ? 'high' : 'medium'}">${s.status}</span>
                            <span style="color:var(--text-secondary);font-size:0.85em;">🤖 Sent by ResearchPulse</span>
                        </div>
                    </div>
                    <div class="email-actions" style="display:flex;gap:4px;align-items:center;">
                        <button class="icon-btn" onclick="event.stopPropagation(); deleteShare('${s.id}')" title="Delete share">🗑️</button>
                    </div>
                </div>
                `;
            }).join('');
        }

        // ========== Colleagues Tab State Management ==========
        let selectedColleagueIds = new Set();
        let allColleagueIds = [];
        let allColleaguesData = [];
        let currentColleagueSortField = 'name';
        let currentColleagueSortDir = 'asc';
        let colleagueSearchTimeout = null;

        function debouncedColleagueSearch() {
            clearTimeout(colleagueSearchTimeout);
            colleagueSearchTimeout = setTimeout(() => {
                refreshColleagues();
            }, 250);
        }

        function setColleagueSortOrder(field, btn) {
            currentColleagueSortField = field;
            document.querySelectorAll('#colleague-list-header .sort-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            refreshColleagues();
        }

        function toggleColleagueSortDirection() {
            currentColleagueSortDir = currentColleagueSortDir === 'desc' ? 'asc' : 'desc';
            const btn = document.getElementById('colleague-sort-dir-btn');
            btn.textContent = currentColleagueSortDir === 'desc' ? '↓' : '↑';
            btn.title = currentColleagueSortDir === 'desc' ? 'Descending (click to toggle)' : 'Ascending (click to toggle)';
            refreshColleagues();
        }

        function toggleColleagueSelection(colleagueId) {
            if (selectedColleagueIds.has(colleagueId)) {
                selectedColleagueIds.delete(colleagueId);
            } else {
                selectedColleagueIds.add(colleagueId);
            }
            updateColleagueBulkActionBar();
            updateColleagueRowStyles();
        }

        function toggleSelectAllColleagues() {
            if (selectedColleagueIds.size === allColleagueIds.length && allColleagueIds.length > 0) {
                // Deselect all
                selectedColleagueIds.clear();
            } else {
                // Select all
                allColleagueIds.forEach(id => selectedColleagueIds.add(id));
            }
            updateColleagueBulkActionBar();
            updateColleagueRowStyles();
        }

        function clearColleagueSelection() {
            selectedColleagueIds.clear();
            updateColleagueBulkActionBar();
            updateColleagueRowStyles();
        }

        function updateColleagueRowStyles() {
            allColleagueIds.forEach(colleagueId => {
                const row = document.getElementById('colleague-row-' + colleagueId);
                const checkbox = document.getElementById('colleague-cb-' + colleagueId);
                if (row && checkbox) {
                    if (selectedColleagueIds.has(colleagueId)) {
                        row.classList.add('selected');
                        checkbox.checked = true;
                    } else {
                        row.classList.remove('selected');
                        checkbox.checked = false;
                    }
                }
            });

            // Update select-all checkbox state
            const selectAllCb = document.getElementById('select-all-colleagues-checkbox');
            if (selectAllCb) {
                if (allColleagueIds.length > 0 && selectedColleagueIds.size === allColleagueIds.length) {
                    selectAllCb.checked = true;
                    selectAllCb.indeterminate = false;
                } else if (selectedColleagueIds.size > 0) {
                    selectAllCb.checked = false;
                    selectAllCb.indeterminate = true;
                } else {
                    selectAllCb.checked = false;
                    selectAllCb.indeterminate = false;
                }
            }
        }

        function updateColleagueBulkActionBar() {
            const bar = document.getElementById('colleague-bulk-action-bar');
            const count = document.getElementById('colleague-bulk-selection-count');
            if (selectedColleagueIds.size > 0) {
                bar.classList.add('visible');
                count.textContent = `${selectedColleagueIds.size} selected`;
            } else {
                bar.classList.remove('visible');
            }
        }

        async function bulkDeleteColleagues() {
            if (selectedColleagueIds.size === 0) return;
            if (!confirm(`Are you sure you want to delete ${selectedColleagueIds.size} colleague(s)?`)) return;

            try {
                const response = await fetch('/api/bulk/colleagues/delete', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(Array.from(selectedColleagueIds))
                });
                if (!response.ok) throw new Error('Failed to delete colleagues');
                const result = await response.json();
                showToast(`Deleted ${result.deleted_count} colleague(s)`);
                clearColleagueSelection();
                refreshColleagues();
            } catch (err) {
                console.error('Error:', err);
                alert('Failed to delete colleagues: ' + err.message);
            }
        }

        async function refreshColleagues() {
            const list = document.getElementById('colleagues-list');
            const header = document.getElementById('colleague-list-header');

            try {
                const q = document.getElementById('colleagues-search')?.value || '';
                const params = new URLSearchParams({
                    sort_by: currentColleagueSortField,
                    sort_dir: currentColleagueSortDir
                });

                const response = await fetch('/api/colleagues?' + params.toString());
                if (!response.ok) throw new Error('Failed to fetch colleagues');
                const data = await response.json();

                // Store data
                allColleaguesData = data.colleagues || [];

                // Filter by search query if present
                if (q) {
                    const searchLower = q.toLowerCase();
                    allColleaguesData = allColleaguesData.filter(c =>
                        (c.name || '').toLowerCase().includes(searchLower) ||
                        (c.email || '').toLowerCase().includes(searchLower) ||
                        (c.keywords || []).some(k => k.toLowerCase().includes(searchLower)) ||
                        (c.categories || []).some(cat => cat.toLowerCase().includes(searchLower))
                    );
                }

                allColleagueIds = allColleaguesData.map(c => c.id);

                // Clean up selection
                const visibleIds = new Set(allColleagueIds);
                selectedColleagueIds.forEach(id => {
                    if (!visibleIds.has(id)) selectedColleagueIds.delete(id);
                });

                if (allColleaguesData.length === 0) {
                    list.innerHTML = `<div class="empty-state"><div class="emoji">👥</div><div>${q ? 'No colleagues match your search.' : 'No colleagues configured. Add colleagues to enable paper sharing!'}</div></div>`;
                    header.style.display = 'none';
                    updateColleagueBulkActionBar();
                    return;
                }

                header.style.display = 'flex';

                list.innerHTML = allColleaguesData.map(c => {
                    const isSelected = selectedColleagueIds.has(c.id);
                    // Show badge based on how colleague was added
                    const addedByBadge = c.added_by === 'email'
                        ? '<span class="importance-badge importance-medium" title="This colleague signed up via email">🤖 Added by ResearchPulse</span>'
                        : '<span class="importance-badge importance-low" title="You added this colleague manually">👤 Added by You</span>';

                    // Auto-send badge - show enabled/disabled state (consistent naming)
                    const autoSendBadge = c.auto_send_emails !== false
                        ? '<span class="importance-badge importance-high" title="Auto-sending research emails enabled">📬 Auto-send Enabled</span>'
                        : '<span class="importance-badge importance-low" title="Auto-sending disabled">📭 Auto-send Disabled</span>';

                    // Generate interest headline for display
                    // Uses interest_headline if available, or falls back to a computed summary
                    let interestDisplay;
                    if (c.interest_headline) {
                        interestDisplay = `<span class="paper-meta-item">🔬 ${escapeHtml(c.interest_headline)}</span>`;
                    } else if (c.interests || c.research_interests) {
                        // Fallback: Show truncated interests
                        const interests = c.interests || c.research_interests;
                        const shortInterests = interests.length > 60 ? interests.slice(0, 60) + '...' : interests;
                        interestDisplay = `<span class="paper-meta-item">🔬 ${escapeHtml(shortInterests)}</span>`;
                    } else {
                        interestDisplay = '<span class="paper-meta-item" style="color: var(--text-muted);">🔬 Interests not provided yet</span>';
                    }

                    return `
                    <div class="paper-row ${isSelected ? 'selected' : ''}" id="colleague-row-${c.id}">
                        <input type="checkbox" class="paper-checkbox" id="colleague-cb-${c.id}" 
                            ${isSelected ? 'checked' : ''} 
                            onchange="toggleColleagueSelection('${c.id}')" />
                        <div class="paper-content" onclick="showColleagueDetails('${c.id}')" style="cursor: pointer;">
                            <div class="paper-title-row">
                                <span class="paper-title-link">${escapeHtml(c.name)}</span>
                            </div>
                            <div class="paper-meta-row">
                                <span class="paper-meta-item">📧 ${escapeHtml(c.email)}</span>
                                ${interestDisplay}
                            </div>
                            <div class="paper-agent-decisions" style="margin-top: 4px;">
                                ${addedByBadge}
                                ${autoSendBadge}
                            </div>
                        </div>
                        <div class="data-actions">
                            <button class="data-btn" onclick="showColleagueDetails('${c.id}')">👁️ View</button>
                            <button class="data-btn" onclick="editColleague('${c.id}')">✏️ Edit</button>
                            <button class="data-btn danger" onclick="deleteColleague('${c.id}')">🗑️ Delete</button>
                        </div>
                    </div>
                `;
                }).join('');

                updateColleagueBulkActionBar();
            } catch (err) {
                console.error('Error fetching colleagues:', err);
                list.innerHTML = '<div class="empty-state"><div class="emoji">❌</div><div>Failed to load colleagues.</div></div>';
            }
        }

        function showAddColleagueModal() {
            const existing = document.getElementById('colleague-modal');
            if (existing) existing.remove();

            // Simplified modal - categories are derived from interests, not manually set
            const modal = document.createElement('div');
            modal.id = 'colleague-modal';
            modal.className = 'modal-overlay active';
            modal.innerHTML = `
                <div class="modal" style="max-width: 500px;">
                    <h3>Add Colleague</h3>
                    <div class="form-group">
                        <label>Name *</label>
                        <input type="text" id="colleague-name" placeholder="Dr. Jane Smith" />
                    </div>
                    <div class="form-group">
                        <label>Email *</label>
                        <input type="email" id="colleague-email" placeholder="jane@university.edu" />
                    </div>
                    <div class="form-group">
                        <label>Research Interests</label>
                        <textarea id="colleague-research-interests" rows="4" placeholder="e.g., I'm interested in machine learning, particularly deep learning for natural language processing and transformer architectures..."></textarea>
                        <small style="color: var(--text-muted); display: block; margin-top: 4px;">
                            Describe their research interests. ResearchPulse will automatically derive relevant categories and keywords.
                        </small>
                    </div>
                    <div class="form-group">
                        <label><input type="checkbox" id="colleague-auto-send" checked /> Enable automatic research emails</label>
                        <small style="color: var(--text-muted); display: block; margin-top: 4px;">When enabled, ResearchPulse sends paper recommendations automatically.</small>
                    </div>
                    <div class="form-actions">
                        <button class="action-btn" onclick="closeColleagueModal()">Cancel</button>
                        <button class="action-btn primary" onclick="saveColleague()">Save</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        function closeColleagueModal() {
            const modal = document.getElementById('colleague-modal');
            if (modal) modal.remove();
        }

        async function saveColleague() {
            const name = document.getElementById('colleague-name').value.trim();
            const email = document.getElementById('colleague-email').value.trim();
            const researchInterests = document.getElementById('colleague-research-interests')?.value.trim() || '';
            const autoSendEmails = document.getElementById('colleague-auto-send')?.checked ?? true;

            if (!name || !email) {
                alert('Name and email are required');
                return;
            }

            try {
                // Categories are derived from interests on the server - don't send them
                const response = await fetch('/api/colleagues', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        name,
                        email,
                        research_interests: researchInterests,
                        auto_send_emails: autoSendEmails
                    })
                });

                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    throw new Error(errorData.detail || 'Failed to save colleague');
                }

                closeColleagueModal();
                showToast('Colleague added successfully');
                refreshColleagues();
            } catch (err) {
                console.error('Error saving colleague:', err);
                alert('Failed to save colleague: ' + err.message);
            }
        }

        async function deleteColleague(colleagueId) {
            if (!confirm('Are you sure you want to delete this colleague?')) return;
            try {
                const response = await fetch('/api/colleagues/' + colleagueId, { method: 'DELETE' });
                if (!response.ok) throw new Error('Failed to delete colleague');
                showToast('Colleague deleted');
                refreshColleagues();
            } catch (err) {
                console.error('Error deleting colleague:', err);
                alert('Failed to delete colleague: ' + err.message);
            }
        }

        async function editColleague(colleagueId) {
            // Fetch colleague data and show edit modal
            try {
                const response = await fetch('/api/colleagues/' + colleagueId);
                if (!response.ok) throw new Error('Failed to fetch colleague');
                const colleague = await response.json();

                showEditColleagueModal(colleague);
            } catch (err) {
                console.error('Error fetching colleague:', err);
                alert('Failed to load colleague: ' + err.message);
            }
        }

        function showEditColleagueModal(colleague) {
            const existing = document.getElementById('colleague-modal');
            if (existing) existing.remove();

            const modal = document.createElement('div');
            modal.id = 'colleague-modal';
            modal.className = 'modal-overlay active';
            modal.innerHTML = `
                <div class="modal" style="max-width: 500px;">
                    <h3>Edit Colleague</h3>
                    <div class="form-group">
                        <label>Name *</label>
                        <input type="text" id="colleague-name" value="${escapeHtml(colleague.name || '')}" />
                    </div>
                    <div class="form-group">
                        <label>Email (read-only)</label>
                        <input type="email" id="colleague-email" value="${escapeHtml(colleague.email || '')}" readonly style="background: var(--surface); color: var(--text-muted);" />
                    </div>
                    <div class="form-group">
                        <label>Research Interests</label>
                        <textarea id="colleague-research-interests" rows="4">${escapeHtml(colleague.interests || colleague.research_interests || '')}</textarea>
                        <small style="color: var(--text-muted); display: block; margin-top: 4px;">
                            Update interests to regenerate derived categories automatically.
                        </small>
                    </div>
                    <div class="form-group">
                        <label><input type="checkbox" id="colleague-auto-send" ${colleague.auto_send_emails !== false ? 'checked' : ''} /> Enable automatic research emails</label>
                    </div>
                    <div class="form-actions">
                        <button class="action-btn" onclick="closeColleagueModal()">Cancel</button>
                        <button class="action-btn primary" onclick="updateColleague('${colleague.id}')">Save Changes</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        async function updateColleague(colleagueId) {
            const name = document.getElementById('colleague-name').value.trim();
            const researchInterests = document.getElementById('colleague-research-interests')?.value.trim() || '';
            const autoSendEmails = document.getElementById('colleague-auto-send')?.checked ?? true;

            if (!name) {
                alert('Name is required');
                return;
            }

            try {
                const response = await fetch('/api/colleagues/' + colleagueId, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        name,
                        research_interests: researchInterests,
                        auto_send_emails: autoSendEmails
                    })
                });

                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    throw new Error(errorData.detail || 'Failed to update colleague');
                }

                closeColleagueModal();
                showToast('Colleague updated');
                refreshColleagues();
            } catch (err) {
                console.error('Error updating colleague:', err);
                alert('Failed to update colleague: ' + err.message);
            }
        }

        async function showColleagueDetails(colleagueId) {
            // Fetch colleague data and email stats
            try {
                const [colleagueRes, statsRes] = await Promise.all([
                    fetch('/api/colleagues/' + colleagueId),
                    fetch('/api/colleagues/' + colleagueId + '/email-stats')
                ]);

                if (!colleagueRes.ok) throw new Error('Failed to fetch colleague');
                const colleague = await colleagueRes.json();
                const stats = statsRes.ok ? await statsRes.json() : { stats: { last_24h: 0, last_7d: 0, last_30d: 0, total: 0 } };

                showColleagueDetailsModal(colleague, stats.stats);
            } catch (err) {
                console.error('Error fetching colleague details:', err);
                alert('Failed to load colleague details: ' + err.message);
            }
        }

        function showColleagueDetailsModal(colleague, stats) {
            const existing = document.getElementById('colleague-details-modal');
            if (existing) existing.remove();

            // Format categories display (read-only)
            const categoriesDisplay = (colleague.categories || []).length > 0
                ? colleague.categories.join(', ')
                : '<em style="color: var(--text-muted);">No categories derived yet</em>';

            // Format added by display
            const addedByDisplay = colleague.added_by === 'email'
                ? '🤖 Added by ResearchPulse (via email signup)'
                : '👤 Added by You';

            // Format auto-send status
            const autoSendDisplay = colleague.auto_send_emails !== false
                ? '📬 Auto-send Enabled'
                : '📭 Auto-send Disabled';

            const modal = document.createElement('div');
            modal.id = 'colleague-details-modal';
            modal.className = 'modal-overlay active';
            modal.innerHTML = `
                <div class="modal" style="max-width: 600px;">
                    <h3 style="margin-bottom: 16px;">👤 ${escapeHtml(colleague.name)}</h3>
                    
                    <div style="display: grid; gap: 16px;">
                        <!-- Basic Info -->
                        <div class="glass-panel" style="padding: 16px; border-radius: 8px;">
                            <div style="display: grid; gap: 8px;">
                                <div><strong>Email:</strong> ${escapeHtml(colleague.email)}</div>
                                <div><strong>Status:</strong> ${addedByDisplay} &bull; ${autoSendDisplay}</div>
                            </div>
                        </div>

                        <!-- Interests Section -->
                        <div class="glass-panel" style="padding: 16px; border-radius: 8px;">
                            <h4 style="margin: 0 0 8px 0; font-size: 14px;">🔬 Research Interests</h4>
                            <p style="margin: 0; white-space: pre-wrap;">${escapeHtml(colleague.interests || colleague.research_interests || 'Not provided yet')}</p>
                        </div>

                        <!-- Derived Categories (Read-only) -->
                        <div class="glass-panel" style="padding: 16px; border-radius: 8px;">
                            <h4 style="margin: 0 0 8px 0; font-size: 14px;">🏷️ Derived Categories <small style="font-weight: normal; color: var(--text-muted);">(auto-generated from interests)</small></h4>
                            <p style="margin: 0;">${categoriesDisplay}</p>
                        </div>

                        <!-- Email Activity Stats -->
                        <div class="glass-panel" style="padding: 16px; border-radius: 8px;">
                            <h4 style="margin: 0 0 12px 0; font-size: 14px;">📧 Email Activity</h4>
                            <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; text-align: center;">
                                <div>
                                    <div style="font-size: 24px; font-weight: bold; color: var(--primary);">${stats.last_24h || 0}</div>
                                    <div style="font-size: 12px; color: var(--text-muted);">Last 24h</div>
                                </div>
                                <div>
                                    <div style="font-size: 24px; font-weight: bold; color: var(--primary);">${stats.last_7d || 0}</div>
                                    <div style="font-size: 12px; color: var(--text-muted);">Last 7 days</div>
                                </div>
                                <div>
                                    <div style="font-size: 24px; font-weight: bold; color: var(--primary);">${stats.last_30d || 0}</div>
                                    <div style="font-size: 12px; color: var(--text-muted);">Last 30 days</div>
                                </div>
                                <div>
                                    <div style="font-size: 24px; font-weight: bold; color: var(--primary);">${stats.total || 0}</div>
                                    <div style="font-size: 12px; color: var(--text-muted);">Total Ever</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="form-actions" style="margin-top: 20px;">
                        <button class="action-btn" onclick="document.getElementById('colleague-details-modal').remove()">Close</button>
                        <button class="action-btn primary" onclick="document.getElementById('colleague-details-modal').remove(); editColleague('${colleague.id}');">Edit</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        async function refreshRuns() {
            const list = document.getElementById('runs-list');
            try {
                const response = await fetch('/api/runs');
                if (!response.ok) throw new Error('Failed to fetch runs');
                const data = await response.json();

                if (!data.runs || data.runs.length === 0) {
                    list.innerHTML = '<div class="empty-state"><div class="emoji">🚀</div><div>No runs recorded yet.</div></div>';
                    return;
                }

                list.innerHTML = data.runs.map(r => `
                    <div class="data-item">
                        <div class="data-info">
                            <div class="data-title">Run ${r.run_id || r.id}</div>
                            <div class="data-meta">
                                <span>📅 ${new Date(r.started_at).toLocaleString()}</span>
                                <span>⏱️ ${r.ended_at ? ((new Date(r.ended_at) - new Date(r.started_at)) / 1000).toFixed(1) + 's' : 'In Progress'}</span>
                                <span class="importance-badge importance-${r.status === 'done' ? 'high' : r.status === 'error' ? 'low' : 'medium'}">${r.status}</span>
                                ${r.stop_reason ? `<span>🛑 ${escapeHtml(r.stop_reason)}</span>` : ''}
                            </div>
                        </div>
                    </div>
                `).join('');
            } catch (err) {
                console.error('Error fetching runs:', err);
                list.innerHTML = '<div class="empty-state"><div class="emoji">❌</div><div>Failed to load runs.</div></div>';
            }
        }

        async function triggerRun() {
            try {
                const response = await fetch('/api/run', { method: 'POST' });
                if (!response.ok) throw new Error('Failed to trigger run');
                alert('Run triggered successfully!');
                refreshRuns();
            } catch (err) {
                console.error('Error triggering run:', err);
                alert('Failed to trigger run: ' + err.message);
            }
        }

        // =============================================================================
        // Research Profile Functions
        // =============================================================================
        async function loadProfile() {
            try {
                const response = await fetch('/api/profile');
                if (!response.ok) return;
                const profile = await response.json();

                // Fill in form fields
                document.getElementById('profile-name').value = profile.researcher_name || '';
                document.getElementById('profile-email').value = profile.email || '';
                document.getElementById('profile-affiliation').value = profile.affiliation || '';
                document.getElementById('profile-interests-include').value = profile.interests_include || '';
                document.getElementById('profile-interests-exclude').value = profile.interests_exclude || '';
                document.getElementById('profile-time-period').value = profile.preferred_time_period || 'last two weeks';

                // Store profile globally for quick search
                window.currentProfile = profile;

                // Populate prompt builder dropdowns
                populatePromptBuilder(profile);
            } catch (err) {
                console.error('Error loading profile:', err);
            }
        }

        async function saveProfile() {
            const statusEl = document.getElementById('profile-save-status');
            statusEl.textContent = 'Saving...';
            statusEl.className = 'save-status';

            try {
                const profile = {
                    researcher_name: document.getElementById('profile-name').value.trim(),
                    email: document.getElementById('profile-email').value.trim(),
                    affiliation: document.getElementById('profile-affiliation').value.trim(),
                    interests_include: document.getElementById('profile-interests-include').value.trim(),
                    interests_exclude: document.getElementById('profile-interests-exclude').value.trim(),
                    preferred_time_period: document.getElementById('profile-time-period').value,
                };

                const response = await fetch('/api/profile', {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(profile)
                });

                if (!response.ok) throw new Error('Failed to save profile');

                statusEl.textContent = '✅ Saved!';
                statusEl.className = 'save-status success';

                // Refresh prompt builder
                populatePromptBuilder(profile);

                setTimeout(() => { statusEl.textContent = ''; }, 3000);
            } catch (err) {
                console.error('Error saving profile:', err);
                statusEl.textContent = '❌ Failed to save';
                statusEl.className = 'save-status error';
            }
        }

        async function clearProfile() {
            if (!confirm('Are you sure you want to clear all profile details? This will delete your info from the database.')) return;
            const statusEl = document.getElementById('profile-save-status');
            statusEl.textContent = 'Clearing...';
            statusEl.className = 'save-status';
            try {
                const emptyProfile = {
                    researcher_name: '',
                    email: '',
                    affiliation: '',
                    interests_include: '',
                    interests_exclude: '',
                    preferred_time_period: 'last two weeks',
                };
                const response = await fetch('/api/profile', {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(emptyProfile)
                });
                if (!response.ok) throw new Error('Failed to clear profile');
                // Clear form fields
                document.getElementById('profile-name').value = '';
                document.getElementById('profile-email').value = '';
                document.getElementById('profile-affiliation').value = '';
                document.getElementById('profile-interests-include').value = '';
                document.getElementById('profile-interests-exclude').value = '';
                document.getElementById('profile-time-period').value = 'last two weeks';
                window.currentProfile = null;
                statusEl.textContent = '✅ Profile cleared!';
                statusEl.className = 'save-status success';
                setTimeout(() => { statusEl.textContent = ''; }, 3000);
            } catch (err) {
                console.error('Error clearing profile:', err);
                statusEl.textContent = '❌ Failed to clear';
                statusEl.className = 'save-status error';
            }
        }

        // =============================================================================
        // Search For Me - Quick Search Function
        // =============================================================================
        async function searchForMe() {
            // Fetch profile if not cached
            let profile = window.currentProfile;
            if (!profile) {
                try {
                    const response = await fetch('/api/profile');
                    if (response.ok) {
                        profile = await response.json();
                        window.currentProfile = profile;
                    }
                } catch (err) {
                    console.error('Error fetching profile:', err);
                }
            }

            // Get research interests
            const interests = profile?.interests_include || document.getElementById('profile-interests-include')?.value?.trim() || '';
            const excludeTopics = profile?.interests_exclude || document.getElementById('profile-interests-exclude')?.value?.trim() || '';
            const timePeriod = profile?.preferred_time_period || document.getElementById('profile-time-period')?.value || 'last two weeks';

            if (!interests) {
                alert('Please set your Research Interests in Settings first.');
                // Switch to settings tab
                document.querySelector('[data-tab="settings"]')?.click();
                return;
            }

            // Build the prompt
            let prompt = `Find recent research papers related to the following research interests: \n${interests}. `;

            if (excludeTopics) {
                prompt += `\n\nExclude the following topics if applicable:\n${excludeTopics}`;
            }

            prompt += `\n\nFocus on papers published within the ${timePeriod}.`;

            // Insert into chat input
            document.getElementById('message-input').value = prompt;
            autoResizeTextarea(document.getElementById('message-input'));
            document.getElementById('message-input').focus();

            // Show toast notification
            showToast('📝 Search prompt generated from your research interests!');
        }

        // =============================================================================
        // Prompt Builder Functions
        // =============================================================================
        function populatePromptBuilder(profile) {
            // Store profile globally for quick search
            window.currentProfile = profile;
        }

        function togglePromptBuilder() {
            const content = document.getElementById('prompt-builder-content');
            const btn = document.getElementById('toggle-prompt-builder');
            if (content.classList.contains('collapsed')) {
                content.classList.remove('collapsed');
                btn.textContent = '▲';
            } else {
                content.classList.add('collapsed');
                btn.textContent = '▼';
            }
        }

        function buildPrompt() {
            const areas = Array.from(document.getElementById('prompt-areas').selectedOptions).map(o => o.value);
            const categories = Array.from(document.getElementById('prompt-categories').selectedOptions).map(o => o.value);
            const time = document.getElementById('prompt-time').value;

            let prompt = 'Find and analyze';
            if (areas.length > 0) {
                prompt += ` research papers in the areas of ${areas.join(', ')}`;
            } else {
                prompt += ' research papers';
            }
            if (categories.length > 0) {
                prompt += ` focusing on topics like ${categories.join(', ')}`;
            }
            prompt += ` published in the ${time}.`;
            prompt += ' Prioritize papers based on my research interests and provide a summary of the most relevant ones.';

            // Set the prompt in the input field
            document.getElementById('message-input').value = prompt;
            autoResizeTextarea(document.getElementById('message-input'));
        }

        function buildAndSend() {
            buildPrompt();
            // Trigger send
            elements.sendBtn.click();
        }

        // Saved prompts management - uses database API
        let savedPromptsCache = [];  // Local cache of saved prompts

        async function loadSavedPrompts() {
            const select = document.getElementById('saved-prompts-select');
            select.innerHTML = '<option value="">-- Loading... --</option>';

            try {
                console.log('[DEBUG] Fetching saved prompts from /api/saved-prompts');
                const response = await fetch('/api/saved-prompts');
                console.log('[DEBUG] Response status:', response.status, response.statusText);

                if (!response.ok) {
                    console.error('[ERROR] Failed to fetch prompts:', response.status, response.statusText);
                    select.innerHTML = '<option value="">-- Error: ' + response.status + ' --</option>';
                    return;
                }

                const data = await response.json();
                console.log('[DEBUG] Received data:', data);
                console.log('[DEBUG] Prompts count:', data.prompts ? data.prompts.length : 0);

                if (data.success && data.prompts) {
                    savedPromptsCache = data.prompts;
                    select.innerHTML = '<option value="">-- Select a saved prompt --</option>';

                    data.prompts.forEach((p) => {
                        const opt = document.createElement('option');
                        opt.value = p.id;
                        opt.textContent = p.name || 'Untitled Prompt';
                        select.appendChild(opt);
                    });

                    // Add delete option if there are prompts
                    if (data.prompts.length > 0) {
                        const deleteOpt = document.createElement('option');
                        deleteOpt.value = '__delete__';
                        deleteOpt.textContent = '🗑️ Delete a prompt...';
                        deleteOpt.style.color = '#dc3545';
                        select.appendChild(deleteOpt);
                    }
                    console.log('[DEBUG] Loaded', data.prompts.length, 'saved prompts');
                } else {
                    console.log('[DEBUG] No saved prompts found or empty response');
                    select.innerHTML = '<option value="">-- No saved prompts --</option>';
                }
            } catch (err) {
                console.error('[ERROR] Exception loading saved prompts:', err);
                select.innerHTML = '<option value="">-- Network error --</option>';
            }
        }

        function loadSavedPrompt() {
            const select = document.getElementById('saved-prompts-select');
            const promptId = select.value;

            if (!promptId) return;

            // Handle delete option
            if (promptId === '__delete__') {
                showDeletePromptDialog();
                select.value = '';
                return;
            }

            // Find prompt in cache
            const prompt = savedPromptsCache.find(p => p.id === promptId);
            if (prompt) {
                document.getElementById('message-input').value = prompt.prompt_text;
                autoResizeTextarea(document.getElementById('message-input'));

                // Optionally restore builder state
                if (prompt.areas && prompt.areas.length > 0) {
                    const areasInput = document.getElementById('research-areas');
                    if (areasInput) areasInput.value = prompt.areas.join(', ');
                }
                if (prompt.topics && prompt.topics.length > 0) {
                    const topicsInput = document.getElementById('focus-topics');
                    if (topicsInput) topicsInput.value = prompt.topics.join(', ');
                }
                if (prompt.time_period) {
                    const timeSelect = document.getElementById('time-period');
                    if (timeSelect) timeSelect.value = prompt.time_period;
                }
            }
        }

        async function saveCurrentPrompt() {
            const promptText = document.getElementById('message-input').value.trim();
            if (!promptText) {
                alert('Please enter or build a prompt first.');
                return;
            }

            const name = window.prompt('Enter a name for this prompt:', '');
            if (!name) return;

            // Get builder state
            const areasInput = document.getElementById('research-areas');
            const topicsInput = document.getElementById('focus-topics');
            const timeSelect = document.getElementById('time-period');

            const areas = areasInput ? areasInput.value.split(',').map(s => s.trim()).filter(Boolean) : [];
            const topics = topicsInput ? topicsInput.value.split(',').map(s => s.trim()).filter(Boolean) : [];
            const timePeriod = timeSelect ? timeSelect.value : null;

            try {
                const response = await fetch('/api/saved-prompts', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        name: name,
                        prompt_text: promptText,
                        template_type: 'custom',
                        areas: areas,
                        topics: topics,
                        time_period: timePeriod,
                        paper_count: null
                    })
                });

                const data = await response.json();

                if (data.success) {
                    await loadSavedPrompts();
                    alert('✅ Prompt saved to database!');
                } else {
                    alert('❌ Failed to save prompt: ' + (data.message || 'Unknown error'));
                }
            } catch (err) {
                console.error('Error saving prompt:', err);
                alert('❌ Error saving prompt: ' + err.message);
            }
        }

        function showDeletePromptDialog() {
            if (savedPromptsCache.length === 0) {
                alert('No saved prompts to delete.');
                return;
            }

            const names = savedPromptsCache.map((p, i) => `${i + 1}. ${p.name}`).join('\n');
            const choice = window.prompt(`Enter the number of the prompt to delete:\n\n${names}`);

            if (!choice) return;

            const idx = parseInt(choice) - 1;
            if (isNaN(idx) || idx < 0 || idx >= savedPromptsCache.length) {
                alert('Invalid selection.');
                return;
            }

            const promptToDelete = savedPromptsCache[idx];
            if (confirm(`Delete "${promptToDelete.name}"?`)) {
                deleteSavedPrompt(promptToDelete.id);
            }
        }

        async function deleteSavedPrompt(promptId) {
            try {
                const response = await fetch(`/api/saved-prompts/${promptId}`, {
                    method: 'DELETE'
                });

                const data = await response.json();

                if (data.success) {
                    await loadSavedPrompts();
                    alert('✅ Prompt deleted!');
                } else {
                    alert('❌ Failed to delete prompt: ' + (data.message || 'Unknown error'));
                }
            } catch (err) {
                console.error('Error deleting prompt:', err);
                alert('❌ Error deleting prompt: ' + err.message);
            }
        }

        async function checkHealth() {
            const healthDb = document.getElementById('health-db');
            const healthPinecone = document.getElementById('health-pinecone');
            const healthEmail = document.getElementById('health-email');

            if (healthDb) healthDb.textContent = 'Checking...';
            if (healthPinecone) healthPinecone.textContent = 'Checking...';
            if (healthEmail) healthEmail.textContent = 'Checking...';

            try {
                const response = await fetch('/api/health');
                if (!response.ok) throw new Error('Health check failed');
                const data = await response.json();

                const dbStatus = data.database?.status;
                const dbOk = dbStatus === 'healthy';
                const dbLocal = dbStatus === 'local_storage';

                const pcStatus = data.pinecone?.status;
                const pcOk = pcStatus === 'healthy';
                const pcOptional = pcStatus === 'optional' || pcStatus === 'not_configured';

                const emailStatus = data.email?.status;
                const emailOk = emailStatus === 'configured';
                const emailOptional = emailStatus === 'optional' || emailStatus === 'not_configured';

                if (healthDb) {
                    if (dbOk) {
                        healthDb.textContent = '✅ Connected';
                        healthDb.className = 'health-value ok';
                    } else if (dbLocal) {
                        healthDb.textContent = '📁 ' + (data.database?.message || 'Using local files');
                        healthDb.className = 'health-value';
                    } else {
                        healthDb.textContent = '❌ ' + (data.database?.message || 'Not connected');
                        healthDb.className = 'health-value error';
                    }
                }
                if (healthPinecone) {
                    if (pcOk) {
                        healthPinecone.textContent = '✅ Connected';
                        healthPinecone.className = 'health-value ok';
                    } else if (pcOptional) {
                        healthPinecone.textContent = 'ℹ️ ' + (data.pinecone?.message || 'Optional feature');
                        healthPinecone.className = 'health-value';
                    } else {
                        healthPinecone.textContent = '❌ ' + (data.pinecone?.message || 'Not connected');
                        healthPinecone.className = 'health-value error';
                    }
                }
                if (healthEmail) {
                    if (emailOk) {
                        healthEmail.textContent = '✅ Configured';
                        healthEmail.className = 'health-value ok';
                    } else if (emailOptional) {
                        healthEmail.textContent = 'ℹ️ ' + (data.email?.message || 'Optional feature');
                        healthEmail.className = 'health-value';
                    } else {
                        healthEmail.textContent = '⚠️ ' + (data.email?.message || 'Not configured');
                        healthEmail.className = 'health-value';
                    }
                }
            } catch (err) {
                console.error('Health check error:', err);
                if (healthDb) { healthDb.textContent = '❌ Error'; healthDb.className = 'health-value error'; }
                if (healthPinecone) { healthPinecone.textContent = '❌ Error'; healthPinecone.className = 'health-value error'; }
                if (healthEmail) { healthEmail.textContent = '❌ Error'; healthEmail.className = 'health-value error'; }
            }
        }

        async function savePolicy() {
            // Delivery Policy removed - this function is a no-op stub for backward compat
            console.log('savePolicy called but Delivery Policy section removed');
        }

        // =============================================================================
        // Inbox Settings Functions
        // =============================================================================

        async function loadInboxSettings() {
            try {
                const response = await fetch('/api/settings/inbox');
                if (!response.ok) return;
                const data = await response.json();

                if (data.settings) {
                    const settings = data.settings;
                    const frequencySelect = document.getElementById('inbox-check-frequency');
                    const lastCheckSpan = document.getElementById('inbox-last-check');
                    const joinCodeStatus = document.getElementById('join-code-status');

                    if (frequencySelect) {
                        const freq = settings.inbox_check_enabled && settings.inbox_check_frequency_seconds
                            ? settings.inbox_check_frequency_seconds.toString()
                            : '';
                        frequencySelect.value = freq;
                    }

                    if (lastCheckSpan) {
                        if (settings.last_inbox_check_at) {
                            const date = new Date(settings.last_inbox_check_at);
                            lastCheckSpan.textContent = `Last checked: ${date.toLocaleString()}`;
                        } else {
                            lastCheckSpan.textContent = 'No inbox check yet';
                        }
                    }

                    if (joinCodeStatus) {
                        if (settings.has_join_code) {
                            const updatedAt = settings.colleague_join_code_updated_at
                                ? new Date(settings.colleague_join_code_updated_at).toLocaleDateString()
                                : 'unknown';
                            joinCodeStatus.innerHTML = `<span style="color: green;">✅ Join code is set (last updated: ${updatedAt})</span>`;
                        } else {
                            joinCodeStatus.innerHTML = `<span style="color: #888;">ℹ️ No join code set - email signups disabled</span>`;
                        }
                    }
                }
            } catch (err) {
                console.error('Error loading inbox settings:', err);
            }
        }

        async function saveInboxSettings() {
            const frequencySelect = document.getElementById('inbox-check-frequency');
            const statusSpan = document.getElementById('inbox-save-status');

            const frequencyValue = frequencySelect?.value;
            const enabled = !!frequencyValue;
            const frequencySeconds = frequencyValue ? parseInt(frequencyValue) : null;

            try {
                statusSpan.textContent = 'Saving...';
                statusSpan.style.color = '#666';

                const response = await fetch('/api/settings/inbox', {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        enabled: enabled,
                        frequency_seconds: frequencySeconds
                    })
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || 'Failed to save');
                }

                const data = await response.json();
                statusSpan.textContent = '✅ ' + (data.message || 'Saved');
                statusSpan.style.color = 'green';

                setTimeout(() => { statusSpan.textContent = ''; }, 3000);

                // Reload settings to update timestamps
                loadInboxSettings();

            } catch (err) {
                console.error('Error saving inbox settings:', err);
                statusSpan.textContent = '❌ ' + err.message;
                statusSpan.style.color = 'red';
            }
        }

        async function checkInboxNow() {
            const statusSpan = document.getElementById('inbox-save-status');

            try {
                statusSpan.textContent = '📥 Checking inbox...';
                statusSpan.style.color = '#666';

                const response = await fetch('/api/settings/inbox/check-now', {
                    method: 'POST'
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || 'Check failed');
                }

                const data = await response.json();
                const results = data.results || {};

                const rescheduleProcessed = results.reschedule_replies?.processed || 0;
                const rescheduleSucceeded = results.reschedule_replies?.succeeded || 0;
                const joinProcessed = results.colleague_joins?.processed || 0;
                const joinSucceeded = results.colleague_joins?.succeeded || 0;

                let message = '✅ Inbox checked: ';
                if (rescheduleProcessed > 0 || joinProcessed > 0) {
                    message += `${rescheduleSucceeded}/${rescheduleProcessed} reschedules, ${joinSucceeded}/${joinProcessed} joins`;
                } else {
                    message += 'No new emails';
                }

                statusSpan.textContent = message;
                statusSpan.style.color = 'green';

                setTimeout(() => { statusSpan.textContent = ''; }, 5000);

                // Reload settings to update last check time
                loadInboxSettings();

            } catch (err) {
                console.error('Error checking inbox:', err);
                statusSpan.textContent = '❌ ' + err.message;
                statusSpan.style.color = 'red';
            }
        }

        async function setJoinCode() {
            const codeInput = document.getElementById('colleague-join-code');
            const statusSpan = document.getElementById('join-code-save-status');

            const code = codeInput?.value?.trim();

            if (!code) {
                alert('Please enter a join code');
                return;
            }

            if (code.length < 4) {
                alert('Join code must be at least 4 characters');
                return;
            }

            try {
                statusSpan.textContent = 'Setting...';
                statusSpan.style.color = '#666';

                const response = await fetch('/api/settings/colleague-join-code', {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ code: code })
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || 'Failed to set code');
                }

                codeInput.value = '';  // Clear input for security
                statusSpan.textContent = '✅ Join code set successfully';
                statusSpan.style.color = 'green';

                setTimeout(() => { statusSpan.textContent = ''; }, 3000);

                // Reload settings and current code display
                loadInboxSettings();
                loadCurrentJoinCode();

            } catch (err) {
                console.error('Error setting join code:', err);
                statusSpan.textContent = '❌ ' + err.message;
                statusSpan.style.color = 'red';
            }
        }

        async function clearJoinCode() {
            if (!confirm('Clear the join code? This will disable email signups for colleagues.')) return;

            const statusSpan = document.getElementById('join-code-save-status');

            try {
                statusSpan.textContent = 'Clearing...';
                statusSpan.style.color = '#666';

                const response = await fetch('/api/settings/colleague-join-code', {
                    method: 'DELETE'
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || 'Failed to clear code');
                }

                statusSpan.textContent = '✅ Join code cleared';
                statusSpan.style.color = 'green';

                setTimeout(() => { statusSpan.textContent = ''; }, 3000);

                // Reload settings and current code display
                loadInboxSettings();
                loadCurrentJoinCode();

            } catch (err) {
                console.error('Error clearing join code:', err);
                statusSpan.textContent = '❌ ' + err.message;
                statusSpan.style.color = 'red';
            }
        }

        // =============================================================================
        // Join Code Display (decrypted)
        // =============================================================================

        async function loadCurrentJoinCode() {
            const display = document.getElementById('current-join-code-display');
            if (!display) return;
            try {
                const response = await fetch('/api/settings/colleague-join-code/current');
                if (!response.ok) {
                    display.textContent = 'Error loading';
                    return;
                }
                const data = await response.json();
                if (data.has_code && data.code) {
                    display.textContent = data.code;
                    display.style.color = 'var(--accent)';
                } else {
                    display.textContent = 'None';
                    display.style.color = '#888';
                }
            } catch (err) {
                console.error('Error loading join code:', err);
                display.textContent = 'Error';
            }
        }

        // =============================================================================
        // Execution Settings Functions
        // =============================================================================

        function toggleScheduleOptions() {
            const mode = document.getElementById('exec-mode')?.value;
            const opts = document.getElementById('schedule-options');
            if (opts) {
                opts.style.display = mode === 'scheduled' ? 'block' : 'none';
            }
        }

        function toggleEveryXDays() {
            const freq = document.getElementById('exec-frequency')?.value;
            const input = document.getElementById('every-x-days-input');
            if (input) {
                input.style.display = freq === 'every_x_days' ? 'flex' : 'none';
            }
        }

        async function loadExecutionSettings() {
            try {
                const response = await fetch('/api/settings/execution');
                if (!response.ok) return;
                const data = await response.json();
                if (!data.settings) return;

                const s = data.settings;

                const maxEl = document.getElementById('exec-retrieval-max');
                if (maxEl) maxEl.value = s.retrieval_max_results || 7;

                const modeEl = document.getElementById('exec-mode');
                if (modeEl) {
                    modeEl.value = s.execution_mode || 'manual';
                    toggleScheduleOptions();
                }

                const freqEl = document.getElementById('exec-frequency');
                if (freqEl && s.scheduled_frequency) {
                    freqEl.value = s.scheduled_frequency;
                    toggleEveryXDays();
                }

                const xDaysEl = document.getElementById('exec-every-x-days');
                if (xDaysEl && s.scheduled_every_x_days) {
                    xDaysEl.value = s.scheduled_every_x_days;
                }

                const lastRunEl = document.getElementById('exec-last-run');
                if (lastRunEl) {
                    lastRunEl.textContent = s.last_run_at
                        ? new Date(s.last_run_at).toLocaleString()
                        : '—';
                }

                const nextRunEl = document.getElementById('exec-next-run');
                if (nextRunEl) {
                    nextRunEl.textContent = s.next_run_at
                        ? new Date(s.next_run_at).toLocaleString()
                        : '—';
                }
            } catch (err) {
                console.error('Error loading execution settings:', err);
            }
        }

        async function savePapersPerRunSettings() {
            const statusSpan = document.getElementById('exec-save-status');
            try {
                statusSpan.textContent = 'Saving...';
                statusSpan.style.color = '#666';

                const payload = {
                    retrieval_max_results: parseInt(document.getElementById('exec-retrieval-max')?.value || '7'),
                };

                const response = await fetch('/api/settings/execution', {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || 'Failed to save');
                }

                const data = await response.json();
                statusSpan.textContent = '✅ Papers per run saved';
                statusSpan.style.color = 'green';
                setTimeout(() => { statusSpan.textContent = ''; }, 3000);

            } catch (err) {
                console.error('Error saving papers per run settings:', err);
                statusSpan.textContent = '❌ ' + err.message;
                statusSpan.style.color = 'red';
            }
        }

        async function saveExecutionModeSettings() {
            const statusSpan = document.getElementById('exec-save-status-mode');
            try {
                statusSpan.textContent = 'Saving...';
                statusSpan.style.color = '#666';

                const mode = document.getElementById('exec-mode')?.value || 'manual';
                const payload = {
                    execution_mode: mode,
                };

                if (mode === 'scheduled') {
                    payload.scheduled_frequency = document.getElementById('exec-frequency')?.value || 'daily';
                    if (payload.scheduled_frequency === 'every_x_days') {
                        payload.scheduled_every_x_days = parseInt(document.getElementById('exec-every-x-days')?.value || '3');
                    }
                }

                const response = await fetch('/api/settings/execution', {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || 'Failed to save');
                }

                const data = await response.json();
                statusSpan.textContent = '✅ Schedule saved';
                statusSpan.style.color = 'green';
                setTimeout(() => { statusSpan.textContent = ''; }, 3000);

                // Reload to update timestamps
                loadExecutionSettings();

            } catch (err) {
                console.error('Error saving execution mode settings:', err);
                statusSpan.textContent = '❌ ' + err.message;
                statusSpan.style.color = 'red';
            }
        }

        function setDefaultPapersPerRun() {
            document.getElementById('exec-retrieval-max').value = 7;
            const statusSpan = document.getElementById('exec-save-status');
            statusSpan.textContent = '🔄 Reset to default (7). Click Save to apply.';
            statusSpan.style.color = '#666';
            setTimeout(() => { statusSpan.textContent = ''; }, 4000);
        }

        function setDefaultExecutionMode() {
            document.getElementById('exec-mode').value = 'manual';
            document.getElementById('exec-frequency').value = 'daily';
            document.getElementById('exec-every-x-days').value = 3;
            document.getElementById('schedule-options').style.display = 'none';
            document.getElementById('every-x-days-input').style.display = 'none';
            const statusSpan = document.getElementById('exec-save-status-mode');
            statusSpan.textContent = '🔄 Reset to default (Manual). Click Save to apply.';
            statusSpan.style.color = '#666';
            setTimeout(() => { statusSpan.textContent = ''; }, 4000);
        }

        async function reindexAll() {
            // Actions section removed from UI - keeping function for API backward compat
            console.log('reindexAll called but Actions section removed from UI');
        }

        async function resetSeenPapers() {
            // Actions section removed from UI - keeping function for API backward compat
            console.log('resetSeenPapers called but Actions section removed from UI');
        }

        // =============================================================================
        // Prompt Templates
        // =============================================================================
        let templatesExpanded = false;
        let promptTemplates = [];

        async function fetchTemplates() {
            try {
                const response = await fetch('/api/templates');
                if (!response.ok) throw new Error('Failed to fetch templates');
                const data = await response.json();
                if (data.success) {
                    promptTemplates = data.templates;
                    renderTemplates();
                }
            } catch (err) {
                console.error('Error fetching templates:', err);
            }
        }

        function renderTemplates() {
            const list = document.getElementById('templates-list');
            if (!list) return;

            if (promptTemplates.length === 0) {
                list.innerHTML = '<div class="empty-state" style="padding:12px;"><div>No templates yet.</div></div>';
                return;
            }

            // Sort templates: extract numeric part and sort numerically
            const sortedTemplates = [...promptTemplates].sort((a, b) => {
                // Extract numbers from template names (e.g., "Template 1" -> 1, "Template 10" -> 10)
                const numA = parseInt((a.name.match(/\d+/) || ['0'])[0]);
                const numB = parseInt((b.name.match(/\d+/) || ['0'])[0]);
                // If both have numbers, sort numerically
                if (numA && numB) return numA - numB;
                // Otherwise sort alphabetically
                return a.name.localeCompare(b.name);
            });

            let html = '';
            for (const t of sortedTemplates) {
                const preview = t.text.length > 60 ? t.text.substring(0, 60) + '...' : t.text;
                const builtinBadge = t.is_builtin ? '<span class="template-builtin-badge">Built-in</span>' : '';

                html += `
                    <div class="template-item" onclick="insertTemplate('${t.id}')">
                        <div class="template-info">
                            <div class="template-name">${escapeHtml(t.name)}${builtinBadge}</div>
                            <div class="template-preview">${escapeHtml(preview)}</div>
                        </div>
                    </div>
                `;
            }
            list.innerHTML = html;
        }

        function toggleTemplates() {
            templatesExpanded = !templatesExpanded;
            const content = document.getElementById('prompt-templates-content');
            const chevron = document.getElementById('templates-chevron');

            if (templatesExpanded) {
                content.classList.add('expanded');
                chevron.classList.add('expanded');
                fetchTemplates();
            } else {
                content.classList.remove('expanded');
                chevron.classList.remove('expanded');
            }
        }

        // ===== Autonomous Components Functions =====
        let autonomousExpanded = false;

        function toggleAutonomousComponents() {
            autonomousExpanded = !autonomousExpanded;
            const content = document.getElementById('autonomous-components-content');
            const chevron = document.getElementById('autonomous-chevron');

            if (autonomousExpanded) {
                content.classList.add('expanded');
                chevron.classList.add('expanded');
            } else {
                content.classList.remove('expanded');
                chevron.classList.remove('expanded');
            }
        }

        function openAutonomousModal(title) {
            const modal = document.getElementById('autonomous-modal');
            const titleEl = document.getElementById('autonomous-modal-title');
            const contentEl = document.getElementById('autonomous-modal-content');

            titleEl.textContent = title;
            contentEl.innerHTML = '<div class="autonomous-loading">Loading...</div>';
            modal.classList.add('active');
        }

        function closeAutonomousModal() {
            document.getElementById('autonomous-modal').classList.remove('active');
            const modal = document.querySelector('.autonomous-modal');
            modal?.classList.remove('expanded');
            modal?.querySelector('.live-doc-actions')?.remove();
        }

        // Close modal when clicking overlay
        document.getElementById('autonomous-modal')?.addEventListener('click', function (e) {
            if (e.target === this) closeAutonomousModal();
        });

        async function viewLiveDocument() {
            openAutonomousModal('📄 Live Research Document');
            const contentEl = document.getElementById('autonomous-modal-content');

            try {
                // Fetch both: HTML for display, markdown for download
                const [htmlResp, mdResp] = await Promise.all([
                    fetch('/api/live-document?format=html'),
                    fetch('/api/live-document?format=markdown')
                ]);

                if (htmlResp.status === 404) {
                    const data = await htmlResp.json();
                    contentEl.innerHTML = `
                        <div class="autonomous-empty">
                            <p>${data.detail || 'No live document found. Run a researchPulse first to generate one.'}</p>
                        </div>
                    `;
                    return;
                }

                if (!htmlResp.ok) throw new Error('Failed to fetch live document');

                const rawHtml = await htmlResp.text();
                const mdText = await mdResp.text();
                window._liveDocText = mdText;
                window._liveDocHtml = rawHtml;

                // Extract just the body content from the full HTML page
                const bodyMatch = rawHtml.match(/<body[^>]*>([\s\S]*?)<\/body>/i);
                const htmlContent = bodyMatch ? bodyMatch[1] : rawHtml;
                // Extract scoped styles
                const styleMatch = rawHtml.match(/<style[^>]*>([\s\S]*?)<\/style>/i);
                const scopedStyle = styleMatch ? styleMatch[1].replace(/body\s*\{/g, '.live-doc-rendered {') : '';

                contentEl.innerHTML = `
                    <div style="margin-bottom: 16px; padding: 12px 16px; background: var(--surface); border: 1px solid var(--border); border-radius: 10px; font-size: 0.88rem; color: var(--text-secondary); line-height: 1.5;">
                        <strong>What is this?</strong> This is your <em>Live Research Briefing</em> — an auto-generated document
                        that summarises your latest papers across all research runs. It refreshes autonomously after every run.
                        <br><br>
                        Each paper is scored by <strong>ResearchPulse</strong> fully autonomously:
                        <strong>Relevance</strong> (0–1) measures how closely a paper matches your research interests,
                        and <strong>Novelty</strong> (0–1) reflects how new or unique the paper is compared to what you've already seen.
                        The <strong>Score</strong> displayed for each paper is the sum of Relevance + Novelty (ranging from 0 to 2).
                        Papers are ranked from highest to lowest combined score.
                    </div>
                    <style>.live-doc-rendered { padding: 20px; background: var(--surface); border: 1px solid var(--border); border-radius: 10px; line-height: 1.6; font-size: 0.9rem; }
                    .live-doc-rendered h1 { color: #2563eb; border-bottom: 2px solid #2563eb; padding-bottom: 8px; font-size: 1.4rem; }
                    .live-doc-rendered h2 { color: #1e40af; margin-top: 24px; font-size: 1.15rem; }
                    .live-doc-rendered h3 { color: #1e3a8a; font-size: 1rem; }
                    .live-doc-rendered p { margin: 6px 0; }
                    .live-doc-rendered blockquote { background: rgba(37,99,235,0.06); padding: 12px 16px; border-left: 4px solid #2563eb; margin: 10px 0; border-radius: 4px; }
                    .live-doc-rendered table { border-collapse: collapse; width: 100%; margin: 16px 0; }
                    .live-doc-rendered th, .live-doc-rendered td { border: 1px solid var(--border); padding: 8px 12px; text-align: left; }
                    .live-doc-rendered th { background: var(--surface); font-weight: 600; }
                    .live-doc-rendered a { color: #2563eb; text-decoration: none; }
                    .live-doc-rendered a:hover { text-decoration: underline; }
                    .live-doc-rendered ul { padding-left: 24px; }
                    .live-doc-rendered li { margin: 4px 0; }
                    .live-doc-rendered hr { border: none; border-top: 1px solid var(--border); margin: 16px 0; }
                    .live-doc-rendered code { background: rgba(0,0,0,0.05); padding: 2px 6px; border-radius: 4px; font-size: 0.88em; }
                    </style>
                    <div class="live-doc-rendered">${htmlContent}</div>
                `;
                // Render the sticky action bar outside the scrollable content
                let actionsBar = contentEl.parentElement.querySelector('.live-doc-actions');
                if (!actionsBar) {
                    actionsBar = document.createElement('div');
                    actionsBar.className = 'live-doc-actions';
                    contentEl.parentElement.appendChild(actionsBar);
                }
                actionsBar.innerHTML = `
                    <button id="toggle-modal-size" onclick="toggleModalSize()" class="action-btn" style="font-size: 0.82rem;">↔️ Expand / Collapse</button>
                    <div style="display: flex; gap: 8px;">
                        <div class="download-dropdown" style="position: relative;">
                            <button onclick="this.parentElement.classList.toggle('open')" class="action-btn">⬇️ Download ▾</button>
                            <div class="download-dropdown-menu">
                                <button onclick="doDownloadLiveDoc('txt'); this.closest('.download-dropdown').classList.remove('open');">.txt</button>
                                <button onclick="doDownloadLiveDoc('html'); this.closest('.download-dropdown').classList.remove('open');">.html</button>
                                <button onclick="doDownloadLiveDoc('pdf'); this.closest('.download-dropdown').classList.remove('open');">.pdf (print)</button>
                            </div>
                        </div>
                        <button onclick="resetLiveDocument()" class="action-btn" style="color: var(--error); border-color: var(--error);">🗑️ Reset</button>
                    </div>
                `;
            } catch (error) {
                contentEl.innerHTML = `
                    <div class="autonomous-empty">
                        <p>Error loading live document: ${error.message}</p>
                    </div>
                `;
            }
        }

        function toggleModalSize() {
            document.querySelector('.autonomous-modal').classList.toggle('expanded');
        }

        async function resetLiveDocument() {
            if (!confirm('Reset the Live Document? This will delete the current document and all history. A new one will be generated on the next research run.')) return;
            try {
                const response = await fetch('/api/live-document', { method: 'DELETE' });
                if (!response.ok) throw new Error('Failed to reset');
                await viewLiveDocument();
            } catch (error) {
                alert('Error resetting live document: ' + error.message);
            }
        }

        function _clientSidePdfFallback() {
            // Use the already-loaded HTML from viewLiveDocument, no extra fetch needed
            const html = window._liveDocHtml;
            if (!html) {
                alert('Please open the Live Document first, then try downloading the PDF.');
                return;
            }
            const iframe = document.createElement('iframe');
            iframe.style.position = 'fixed';
            iframe.style.right = '0';
            iframe.style.bottom = '0';
            iframe.style.width = '0';
            iframe.style.height = '0';
            iframe.style.border = 'none';
            document.body.appendChild(iframe);
            const iframeDoc = iframe.contentWindow.document;
            iframeDoc.open();
            iframeDoc.write(html);
            iframeDoc.close();
            // Wait for content to render then trigger print (Save as PDF)
            setTimeout(() => {
                try { iframe.contentWindow.print(); } catch (e) { /* cross-origin guard */ }
                setTimeout(() => document.body.removeChild(iframe), 1000);
            }, 500);
        }

        function doDownloadLiveDoc(fmt) {
            try {
                if (fmt === 'pdf') {
                    _clientSidePdfFallback();
                    return;
                }
                if (fmt === 'html') {
                    const html = window._liveDocHtml;
                    if (!html) { alert('Please open the Live Document first.'); return; }
                    const blob = new Blob([html], { type: 'text/html;charset=utf-8' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = 'research_briefing_' + new Date().toISOString().slice(0, 10) + '.html';
                    document.body.appendChild(a);
                    a.click();
                    setTimeout(() => { document.body.removeChild(a); URL.revokeObjectURL(url); }, 100);
                    return;
                }
                // TXT download via API
                fetch('/api/live-document?format=txt')
                    .then(r => {
                        if (!r.ok) throw new Error('Failed to fetch document');
                        return r.text();
                    })
                    .then(text => {
                        const blob = new Blob([text], { type: 'text/plain;charset=utf-8' });
                        const url = URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = 'research_briefing_' + new Date().toISOString().slice(0, 10) + '.txt';
                        document.body.appendChild(a);
                        a.click();
                        setTimeout(() => { document.body.removeChild(a); URL.revokeObjectURL(url); }, 100);
                    })
                    .catch(e => alert('Download failed: ' + e.message));
            } catch (e) {
                alert('Download failed: ' + e.message);
            }
        }

        async function viewProfileSuggestions() {
            openAutonomousModal('💡 Profile Evolution Suggestions');
            const contentEl = document.getElementById('autonomous-modal-content');

            try {
                const response = await fetch('/api/profile-suggestions?status=pending&limit=20');

                if (response.status === 404) {
                    const data = await response.json();
                    contentEl.innerHTML = `
                        <div class="autonomous-empty">
                            <p>${data.detail || 'Profile Evolution feature is not enabled.'}</p>
                        </div>
                    `;
                    return;
                }

                if (!response.ok) throw new Error('Failed to fetch suggestions');

                const data = await response.json();

                // "What is this?" block — always shown regardless of suggestion count
                const whatIsThisHtml = `
                    <div style="margin-bottom: 16px; padding: 12px 16px; background: var(--surface); border: 1px solid var(--border); border-radius: 10px; font-size: 0.88rem; color: var(--text-secondary); line-height: 1.5;">
                        <strong>What is this?</strong> This section shows <em>Profile Evolution Suggestions</em> generated
                        autonomously from your research activity and discovered papers. They help you evolve your
                        <strong>Research Interests</strong> over time. Accept a suggestion to add it to your interests,
                        or dismiss it to hide it.
                    </div>
                `;

                if (!data.suggestions || data.suggestions.length === 0) {
                    contentEl.innerHTML = `
                        ${whatIsThisHtml}
                        <div class="autonomous-empty">
                            <p>No profile suggestions yet.</p>
                            <p>Run more research sessions to receive personalized recommendations.</p>
                        </div>
                    `;
                    return;
                }

                let html = whatIsThisHtml + data.suggestions.map(s => {
                    // Build supporting papers list
                    let papersHtml = '';
                    if (s.supporting_papers && s.supporting_papers.length > 0) {
                        papersHtml = `
                            <div class="suggestion-papers" style="margin-top:8px;font-size:0.85em;color:#6b7280;">
                                <strong>Based on:</strong>
                                ${s.supporting_papers.slice(0, 3).map(p =>
                            `<div style="margin:2px 0;">• <a href="https://arxiv.org/abs/${escapeHtml(p.arxiv_id)}" target="_blank" style="color:#3b82f6;">${escapeHtml(p.title)}</a></div>`
                        ).join('')}
                            </div>
                        `;
                    }

                    return `
                    <div class="suggestion-card">
                        <div class="suggestion-card-header">
                            <span class="suggestion-field">💡 Suggestion</span>
                            <span class="suggestion-status ${s.status}">${s.status}</span>
                        </div>
                        <div class="suggestion-reason">${escapeHtml(s.suggestion_text || '')}</div>
                        <div style="margin-top:6px;font-size:0.9em;color:#6b7280;">
                            ${escapeHtml(s.reasoning || '')}
                        </div>
                        ${s.confidence ? `<div style="margin-top:4px;font-size:0.8em;color:#9ca3af;">Confidence: ${Math.round(s.confidence * 100)}%</div>` : ''}
                        ${papersHtml}
                        ${s.status === 'pending' ? `
                            <div class="suggestion-actions">
                                <button class="accept-btn" onclick="updateSuggestionStatus('${s.id}', 'accepted')">✓ Accept</button>
                                <button class="reject-btn" onclick="updateSuggestionStatus('${s.id}', 'rejected')">✕ Dismiss</button>
                            </div>
                        ` : ''}
                    </div>
                `}).join('');

                contentEl.innerHTML = html;
            } catch (error) {
                contentEl.innerHTML = `
                    <div class="autonomous-empty">
                        <p>Error loading suggestions: ${error.message}</p>
                    </div>
                `;
            }
        }

        async function updateSuggestionStatus(suggestionId, status) {
            try {
                const response = await fetch('/api/profile-suggestions/' + suggestionId, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ status: status })
                });

                if (!response.ok) throw new Error('Failed to update suggestion');

                const result = await response.json();

                if (status === 'accepted' && result.applied) {
                    // Refresh the profile form so the settings tab shows the update
                    await loadProfile();
                }

                // Reload the suggestions (only show pending)
                await viewProfileSuggestions();
            } catch (error) {
                alert('Error updating suggestion: ' + error.message);
            }
        }

        async function viewHistoryLogs() {
            openAutonomousModal('📋 History Logs');
            const contentEl = document.getElementById('autonomous-modal-content');

            try {
                const response = await fetch('/api/audit-logs?limit=50');

                if (response.status === 404) {
                    const data = await response.json();
                    contentEl.innerHTML = `
                        <div class="autonomous-empty">
                            <p>${data.detail || 'History Logs are not available.'}</p>
                        </div>
                    `;
                    return;
                }

                if (!response.ok) throw new Error('Failed to fetch history logs');

                const data = await response.json();

                if (!data.audit_logs || data.audit_logs.length === 0) {
                    contentEl.innerHTML = `
                        <div class="autonomous-empty">
                            <p>No history logs yet.</p>
                            <p>Run a research session to see the history trail.</p>
                        </div>
                    `;
                    return;
                }

                let html = `
                    <div style="margin-bottom: 16px; padding: 12px 16px; background: var(--surface); border: 1px solid var(--border); border-radius: 10px; font-size: 0.88rem; color: var(--text-secondary); line-height: 1.5;">
                        <strong>What is this?</strong> These are your <em>History Logs</em> — a complete audit trail of every
                        research run, showing how many papers were retrieved, scored, shared, and discarded,
                        along with timing and stop-reason details.
                    </div>
                `;

                html += data.audit_logs.map(log => {
                    const createdAt = log.created_at ? new Date(log.created_at).toLocaleString() : 'N/A';
                    const durationSec = log.execution_time_ms ? (log.execution_time_ms / 1000).toFixed(1) : '0.0';
                    return `
                        <div class="audit-log-item">
                            <div class="audit-log-header">
                                <span class="audit-log-run-id">Run: ${escapeHtml(log.run_id || '')}</span>
                                <span class="audit-log-time">${createdAt}</span>
                            </div>
                            <div class="audit-log-stats">
                                <span class="audit-log-stat">📄 ${log.papers_retrieved_count || 0} retrieved</span>
                                <span class="audit-log-stat">📊 ${log.papers_scored_count || 0} scored</span>
                                <span class="audit-log-stat">✉️ ${log.papers_shared_count || 0} shared</span>
                                <span class="audit-log-stat">🗑️ ${log.papers_discarded_count || 0} discarded</span>
                            </div>
                            ${log.stop_reason ? `<div style="color: var(--text-secondary); margin-top: 6px; font-size: 0.82rem;">Stop: ${escapeHtml(log.stop_reason)}</div>` : ''}
                        </div>
                    `;
                }).join('');

                html += `
                    <div style="margin-top: 16px; display: flex; justify-content: flex-end;">
                        <button onclick="resetHistoryLogs()" class="action-btn" style="color: var(--error); border-color: var(--error);">🗑️ Reset All History</button>
                    </div>
                `;

                contentEl.innerHTML = html;
            } catch (error) {
                contentEl.innerHTML = `
                    <div class="autonomous-empty">
                        <p>Error loading history logs: ${error.message}</p>
                    </div>
                `;
            }
        }

        async function resetHistoryLogs() {
            if (!confirm('Reset all history logs? This will permanently delete all run history from the database.')) return;
            try {
                const response = await fetch('/api/audit-logs', { method: 'DELETE' });
                if (!response.ok) throw new Error('Failed to reset');
                await viewHistoryLogs();
            } catch (error) {
                alert('Error resetting history logs: ' + error.message);
            }
        }

        function insertTemplate(templateId) {
            const template = promptTemplates.find(t => t.id === templateId);
            if (!template) return;

            // Insert the template text as-is with placeholders visible.
            // The user fills in parameters before sending.
            // Execution goes through the same /api/execute pipeline as "Search for me".
            document.getElementById('message-input').value = template.text;
            autoResizeTextarea(document.getElementById('message-input'));
            document.getElementById('message-input').focus();

            // Auto-collapse the templates panel after selection
            if (templatesExpanded) {
                toggleTemplates();
            }
        }

        // Add/delete template functions removed — only built-in templates are supported

        // Fetch templates on page load
        fetchTemplates();

        // ========== Theme Toggle ==========
        function initTheme() {
            const savedTheme = localStorage.getItem('theme');
            const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;

            if (savedTheme === 'dark' || (!savedTheme && prefersDark)) {
                document.documentElement.classList.add('dark');
            } else {
                document.documentElement.classList.remove('dark');
            }
        }

        function toggleTheme() {
            const html = document.documentElement;
            html.classList.toggle('dark');
            const newTheme = html.classList.contains('dark') ? 'dark' : 'light';
            localStorage.setItem('theme', newTheme);
            if (typeof updateThreeJsTheme === 'function') {
                updateThreeJsTheme(newTheme);
            }
        }

        // Initialize theme on page load
        initTheme();

        // Add click handler for theme toggle
        document.getElementById('theme-toggle')?.addEventListener('click', toggleTheme);

        // FAQ Toggle Function
        function toggleFaq(element) {
            const faqItem = element.closest('.faq-item');
            if (faqItem) {
                faqItem.classList.toggle('expanded');
            }
        }

        // Listen for system theme changes
        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', (e) => {
            if (!localStorage.getItem('theme')) {
                if (e.matches) {
                    document.documentElement.classList.add('dark');
                } else {
                    document.documentElement.classList.remove('dark');
                }
                if (typeof updateThreeJsTheme === 'function') {
                    updateThreeJsTheme(e.matches ? 'dark' : 'light');
                }
            }
        });
    </script>

    <!-- Three.js Animated Background -->
    <script>
        // Three.js Animated Dots Background
        const scene = new THREE.Scene();
        const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
        const renderer = new THREE.WebGLRenderer({ alpha: true, antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
        document.getElementById('canvas-container').appendChild(renderer.domElement);

        // Create particles
        const geometry = new THREE.BufferGeometry();
        const particlesCount = 500;
        const posArray = new Float32Array(particlesCount * 3);
        for (let i = 0; i < particlesCount * 3; i++) {
            posArray[i] = (Math.random() - 0.5) * 12;
        }
        geometry.setAttribute('position', new THREE.BufferAttribute(posArray, 3));

        // Create circular particle texture
        function createCircleTexture() {
            const canvas = document.createElement('canvas');
            canvas.width = 32;
            canvas.height = 32;
            const ctx = canvas.getContext('2d');
            ctx.beginPath();
            ctx.arc(16, 16, 14, 0, 2 * Math.PI);
            ctx.fillStyle = 'white';
            ctx.fill();
            return new THREE.CanvasTexture(canvas);
        }

        const material = new THREE.PointsMaterial({
            size: 0.04,
            color: 0xa84370,
            transparent: true,
            opacity: 0.7,
            map: createCircleTexture(),
            depthWrite: false,
        });

        const particlesMesh = new THREE.Points(geometry, material);
        scene.add(particlesMesh);
        camera.position.z = 3;

        // Mouse movement tracking
        let mouseX = 0;
        let mouseY = 0;
        document.addEventListener('mousemove', (event) => {
            mouseX = event.clientX / window.innerWidth - 0.5;
            mouseY = event.clientY / window.innerHeight - 0.5;
        });

        const clock = new THREE.Clock();

        // Animation loop
        function animateBackground() {
            requestAnimationFrame(animateBackground);
            const elapsedTime = clock.getElapsedTime();
            particlesMesh.rotation.y = elapsedTime * 0.03;
            particlesMesh.rotation.x = mouseY * 0.08;
            particlesMesh.rotation.y += mouseX * 0.08;
            renderer.render(scene, camera);
        }
        animateBackground();

        // Theme-aware particle colors
        function updateThreeJsTheme(theme) {
            if (theme === 'light') {
                material.color.setHex(0x77347c);
                material.opacity = 0.5;
                document.getElementById('canvas-container').style.opacity = '0.3';
            } else {
                material.color.setHex(0xa84370);
                material.opacity = 0.7;
                document.getElementById('canvas-container').style.opacity = '0.6';
            }
        }

        // Initialize with current theme
        updateThreeJsTheme(document.documentElement.classList.contains('dark') ? 'dark' : 'light');

        // Handle window resize
        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });
    </script>
</body>

</html>