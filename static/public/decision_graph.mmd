graph TD
    START(["ðŸš€ Agent Episode Starts"]) --> SCOPE{"ðŸ”’ Scope Gate\nClassify User Request"}
    SCOPE -->|"IN_SCOPE"| PARSE["ðŸ“ Parse Prompt\nTemplate Â· Output Count K\nTime Period Â· Topic"]
    SCOPE -->|"OUT_OF_SCOPE\n(arXiv only)"| REDIRECT["â†©ï¸ Redirect\nSuggest arXiv rewrite"]
    SCOPE -->|"OUT_OF_SCOPE\n(general)"| REJECT["ðŸš« Reject\nNot a research request"]

    PARSE --> CATMAP{"ðŸ—‚ï¸ Category Source?"}
    CATMAP -->|"Explicit\ncategories set"| FETCH
    CATMAP -->|"Map from\ninterests"| MAPINT["Map 100+ Keywords\nâ†’ arXiv Categories"]
    CATMAP -->|"No interests"| DEFAULT["Default: cs.CL, cs.LG"]
    MAPINT --> PROMPT_OVR{"ðŸ’¬ Prompt mentions\nspecific topics?"}
    DEFAULT --> PROMPT_OVR
    PROMPT_OVR -->|"Yes"| OVERRIDE["Override categories\nfrom user message"]
    PROMPT_OVR -->|"No"| FETCH
    OVERRIDE --> FETCH

    FETCH["ðŸ” Fetch Papers\nfrom arXiv API"] --> CANCEL1{"âŒ Cancelled?"}
    CANCEL1 -->|"Yes"| TERMINATE(["ðŸ Terminate"])
    CANCEL1 -->|"No"| SEEN{"ðŸ“‹ Seen Before?\n(check DB)"}

    SEEN -->|"All papers\nalready seen"| STOP_NOSEEN["â¹ï¸ Stop:\nNo Unseen Papers"]
    SEEN -->|"Has unseen\npapers"| STOP_CHK1{"ðŸ›¡ï¸ Stop Policy\n6 Conditions"}

    STOP_CHK1 -->|"Max Runtime\nor Max Papers\nor Max RAG\nor No Important"| TERMINATE
    STOP_CHK1 -->|"Continue"| FB_CHK{"ðŸ‘¤ Previously marked\nNot Relevant?"}

    FB_CHK -->|"Yes"| SKIP_PAPER["â­ï¸ Skip Paper\nrelevance = 0"]
    FB_CHK -->|"No"| RAG_BUDGET{"ðŸ“Š RAG Query\nBudget Left?"}

    RAG_BUDGET -->|"Under limit"| RAG["ðŸ§  Query Pinecone\nSemantic Similarity"]
    RAG_BUDGET -->|"Exhausted"| SCORE
    RAG --> NOVELTY["ðŸ†• Calculate Novelty\nInverse of max similarity\nDecay factor 0.85"]
    NOVELTY --> SCORE

    SCORE["ðŸ“Š Score Relevance\nâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\nTopic Match Ã— 0.45\nCategory Ã— 0.30\nTitle Keywords Ã— 0.15\nVenue Bonus Ã— 0.10\nâ”€ Avoid Penalty Ã— 0.35\nÂ± Feedback Adj."] --> IMPORTANCE{"âš–ï¸ Importance?"}

    IMPORTANCE -->|"HIGH\nrel â‰¥ 0.65\nnov â‰¥ 0.5"| HIGH_PATH
    IMPORTANCE -->|"MEDIUM\nrel â‰¥ 0.4 or\nrel â‰¥ 0.3 + nov â‰¥ 0.6"| MED_PATH
    IMPORTANCE -->|"LOW\nbelow thresholds"| LOW_PATH

    HIGH_PATH["ðŸ”´ HIGH Importance"] --> EMAIL_CHK{"ðŸ“§ Send Email?"}
    HIGH_PATH --> CAL_CHK{"ðŸ“… Calendar\nReminder?"}
    HIGH_PATH --> RL_ADD["ðŸ“– Add to\nReading List"]

    EMAIL_CHK -->|"Enabled"| DIGEST_CHK{"ðŸ“¬ Digest Mode?"}
    EMAIL_CHK -->|"Disabled"| PERSIST
    DIGEST_CHK -->|"Individual"| SEND_NOW["âœ‰ï¸ Send HTML Email\nPriority-styled template"]
    DIGEST_CHK -->|"Batch"| QUEUE_DIGEST["ðŸ“¥ Queue for\nEnd-of-Run Digest"]

    CAL_CHK -->|"Enabled"| EST_TIME{"â±ï¸ PDF Accessible?"}
    CAL_CHK -->|"Disabled"| PERSIST
    EST_TIME -->|"Yes"| PDF_PAGES["ðŸ“„ Count PDF Pages\nÃ— reading speed\n(Deep/Normal/Skim)"]
    EST_TIME -->|"No"| ABSTRACT_EST["ðŸ“ Abstract Length\nHeuristic Estimate"]
    PDF_PAGES --> GEN_ICS["ðŸ“… Generate .ics\nCalendar Event"]
    ABSTRACT_EST --> GEN_ICS

    MED_PATH["ðŸŸ¡ MEDIUM Importance"] --> RL_ADD
    LOW_PATH["ðŸŸ¢ LOW Importance\nLog Only"] --> PERSIST

    RL_ADD --> PERSIST["ðŸ’¾ Persist State\nto PostgreSQL + Pinecone"]
    SEND_NOW --> PERSIST
    QUEUE_DIGEST --> PERSIST
    GEN_ICS --> PERSIST
    SKIP_PAPER --> PERSIST

    PERSIST --> MORE{"ðŸ“„ More\nPapers?"}
    MORE -->|"Yes"| STOP_CHK1
    MORE -->|"No"| ENFORCE["ðŸŽ¯ Output Enforcement\nTruncate to exactly K papers\nSort by relevance"]

    ENFORCE --> SURPLUS{"ðŸ‘¥ Colleagues\nConfigured?"}
    SURPLUS -->|"No"| REPORT
    SURPLUS -->|"Yes"| COL_PROC["ðŸ”„ Colleague Surplus\nProcessing"]

    COL_PROC --> AUTOSEND{"ðŸ¤– Auto-Send\nEnabled?"}
    AUTOSEND -->|"No"| COL_SKIP["â­ï¸ Skip\nColleague"]
    AUTOSEND -->|"Yes"| SHARE_PREF{"ðŸ“‹ Sharing\nPreference?"}

    SHARE_PREF -->|"on_request"| COL_SKIP
    SHARE_PREF -->|"never"| COL_SKIP
    SHARE_PREF -->|"immediate\ndaily Â· weekly"| MATCH_CHK{"ðŸ”— Topic or\nCategory Match?"}

    MATCH_CHK -->|"Match found"| DO_SHARE["ðŸ“¤ Share Paper"]
    MATCH_CHK -->|"No match"| IMP_OVERRIDE{"ðŸ”´ Paper is\nHIGH importance?"}
    IMP_OVERRIDE -->|"Yes"| DO_SHARE
    IMP_OVERRIDE -->|"No"| COL_SKIP

    DO_SHARE --> TONE{"ðŸ·ï¸ How was colleague\nadded?"}
    TONE -->|"Self-signup\nvia email"| AGENT_VOICE["ðŸ¤– Email as\nResearchPulse"]
    TONE -->|"Manual add\nby owner"| OWNER_VOICE["ðŸ‘¤ Email on\nbehalf of owner"]

    AGENT_VOICE --> REPORT
    OWNER_VOICE --> REPORT
    COL_SKIP --> REPORT

    REPORT["ðŸ“„ Generate Run Report"] --> AUTO_COMP{"ðŸ§¬ Autonomous\nComponents\n(Feature-Flagged)"}

    AUTO_COMP --> AUDIT_FLAG{"ðŸ“‹ AUDIT_LOG\nEnabled?"}
    AUDIT_FLAG -->|"ON"| DO_AUDIT["ðŸ“ Save Structured\nAudit Log"]
    AUDIT_FLAG -->|"OFF"| LLM_FLAG
    DO_AUDIT --> LLM_FLAG

    LLM_FLAG{"ðŸ”¬ LLM_NOVELTY\nEnabled?"}
    LLM_FLAG -->|"ON"| DO_LLM["ðŸ§ª LLM Novelty\nScoring\n4 sub-scores per paper"]
    LLM_FLAG -->|"OFF"| PROF_FLAG
    DO_LLM --> PROF_FLAG

    PROF_FLAG{"ðŸ’¡ PROFILE_EVOLUTION\nEnabled?"}
    PROF_FLAG -->|"OFF"| DOC_FLAG
    PROF_FLAG -->|"ON"| COOLDOWN{"â³ Cooldown\nExpired?"}
    COOLDOWN -->|"Active"| DOC_FLAG
    COOLDOWN -->|"Expired"| MIN_PAPERS{"ðŸ“Š â‰¥ N High-Rel\nPapers?"}
    MIN_PAPERS -->|"No"| DOC_FLAG
    MIN_PAPERS -->|"Yes"| SUGGEST["ðŸ’¡ LLM Profile\nSuggestions\nadd Â· remove Â· refine\nmerge topics/categories"]
    SUGGEST --> DOC_FLAG

    DOC_FLAG{"ðŸ“– LIVE_DOCUMENT\nEnabled?"}
    DOC_FLAG -->|"ON"| DO_DOC["ðŸ“– Update Living\nResearch Briefing\nExecutive Summary\nTrending Topics"]
    DOC_FLAG -->|"OFF"| END
    DO_DOC --> END

    END(["âœ… Episode Complete"])

    STOP_NOSEEN --> TERMINATE

    classDef decision fill:#fdf2f8,stroke:#db2777,stroke-width:2px,color:#1e293b
    classDef action fill:#f0f9ff,stroke:#3b82f6,stroke-width:1px,color:#1e293b
    classDef terminal fill:#f0fdf4,stroke:#16a34a,stroke-width:2px,color:#166534
    classDef high fill:#fef2f2,stroke:#dc2626,stroke-width:2px,color:#991b1b
    classDef medium fill:#fffbeb,stroke:#d97706,stroke-width:2px,color:#92400e
    classDef low fill:#f0fdf4,stroke:#16a34a,stroke-width:2px,color:#166534

    class SCOPE,CATMAP,PROMPT_OVR,CANCEL1,SEEN,STOP_CHK1,FB_CHK,RAG_BUDGET,IMPORTANCE,EMAIL_CHK,DIGEST_CHK,CAL_CHK,EST_TIME,MORE,SURPLUS,AUTOSEND,SHARE_PREF,MATCH_CHK,IMP_OVERRIDE,TONE,AUTO_COMP,AUDIT_FLAG,LLM_FLAG,PROF_FLAG,COOLDOWN,MIN_PAPERS,DOC_FLAG decision
    class HIGH_PATH high
    class MED_PATH medium
    class LOW_PATH low
    class START,END,TERMINATE,STOP_NOSEEN terminal
